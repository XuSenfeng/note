<!DOCTYPE html>

<html lang="zh-CN"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <meta name="html-generator" content="teedoc-plugin-jupyter-notebook-parser">
        
        <script src="/note/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/note/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/note/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/search/style.css" type="text/css"/>
        
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4d52982572d5512e9762879ebf063c86";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
        
        <meta name="blog-generator" content="teedoc-plugin-blog">
        
        <link rel="stylesheet" href="/note/static/css/gitalk/gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/gitalk/custom_gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/custom.css" type="text/css"/>
        
    
    
    <title>LangChain - XvSenfeng's Note</title>
    
    <script type="text/javascript">js_vars = {"teedoc-plugin-ad-hint": {"type": "hint", "label": "â˜†", "content": "è¿™æ˜¯ä¸€ä¸ªæ”¯æŒå›½é™…åŒ–çš„æ¶ˆæ¯ç¤ºä¾‹</br>å–œæ¬¢é¡¹ç›®è¯·<a target=\"_blank\" href=\"https://github.com/teedoc/teedoc\">ç‚¹ä¸‹ â˜† star </a>å“¦~ğŸ¦€ğŸ¦€", "show_times": 2, "show_after_s": 432000, "date": "2021-11-16 14:40", "color": "#a0421d", "link_color": "#e53935", "link_bg_color": "#e6ae5c", "bg_color": "#ffcf89", "color_hover": "white", "bg_color_hover": "#f57c00", "close_color": "#eab971"}}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/note/">
                
                    <img class="site_logo" src="/note/static/image/logo.png" alt="XvSenfeng logo">
                
                
                    <h2>XvSenfeng</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/note/blog/">åšå®¢</a></li>
<li class=""><a  href="/note/Linux/">Linux</a></li>
<li class=""><a  href="/note/ä»£ç åˆ†æ/">ä»£ç åˆ†æ</a></li>
<li class=""><a  href="/note/ä½¿ç”¨è½¯ä»¶/">ä½¿ç”¨è½¯ä»¶</a></li>
<li class=""><a  href="/note/åµŒå…¥å¼/">åµŒå…¥å¼</a></li>
<li class=""><a  href="/note/æ‰‹æœºå®‰å“/">æ‰‹æœºå®‰å“</a></li>
<li class="active"><a  href="/note/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a></li>
<li class=""><a  href="/note/ç¼–ç¨‹åŸºç¡€/">ç¼–ç¨‹åŸºç¡€</a></li>
<li class=""><a  href="/note/ç½‘ç»œ/">ç½‘ç»œ</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/XuSenfeng/note/">github</a></li>
</ul>

                <ul class="nav_plugins"><li><a id="google_translate_element"><img class="icon" src="/note/static/image/google_translate/translate.svg"/>Translate</a></li></ul><ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">æœç´¢</span>
                            <div id="search_hints">
                                <span id="search_input_hint">è¾“å…¥å…³é”®è¯ï¼Œå¤šå…³é”®è¯ç©ºæ ¼éš”å¼€</span>
                                <span id="search_loading_hint">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™ã€‚ã€‚ã€‚</span>
                                <span id="search_download_err_hint">ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ</span>
                                <span id="search_other_docs_result_hint">æ¥è‡ªå…¶å®ƒæ–‡æ¡£çš„ç»“æœ</span>
                                <span id="search_curr_doc_result_hint">å½“å‰æ–‡æ¡£æœç´¢ç»“æœ</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-10-5-Transformers.html"><span class="label">2024-10-5-Transformers</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-10-6-Juoyter.html"><span class="label">2024-10-6-Juoyter</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-10-7-Pandasåº“.html"><span class="label">2024-10-7-Pandasåº“</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-10-9-transformså®æˆ˜.html"><span class="label">2024-10-9-transformså®æˆ˜</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-9-21-LLM.html"><span class="label">2024-9-21-LLM</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-9-22-vLLM.html"><span class="label">2024-9-22-vLLM</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-9-22-æ·±åº¦å­¦ä¹ ç¯å¢ƒ.html"><span class="label">2024-9-22-æ·±åº¦å­¦ä¹ ç¯å¢ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-9-23-01pytorch.html"><span class="label">2024-9-23-01pytorch</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /2024-9-8-æœºå™¨å­¦ä¹ .html"><span class="label">2024-9-8-æœºå™¨å­¦ä¹ </span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /index.html"><span class="label">README</span><span class=""></span></a></li>
<li class="not_active no_link"><a><span class="label">rvæ¨¡å‹éƒ¨ç½²</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2025-11-28-00-é©±åŠ¨ç§»æ¤.html"><span class="label">2025-11-28-00-é©±åŠ¨ç§»æ¤</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2025-11-28-01-ç¯å¢ƒæ­å»º.html"><span class="label">2025-11-28-01-ç¯å¢ƒæ­å»º</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2025-12-2-02-åŸºç¡€æ¦‚å¿µ.html"><span class="label">2025-12-2-02-åŸºç¡€æ¦‚å¿µ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2025-12-3-03-RKNN_Toolkit2.html"><span class="label">2025-12-3-03-RKNN_Toolkit2</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2025-12-3-04-RKLLM.html"><span class="label">2025-12-3-04-RKLLM</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /rvæ¨¡å‹éƒ¨ç½²/2026-2-2-05-RKNNå¼€å‘.html"><span class="label">2026-2-2-05-RKNNå¼€å‘</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">vllmä»£ç åˆ†æ</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /vllmä»£ç åˆ†æ/2024-12-31-00-æ•´ä½“æ¡†æ¶.html"><span class="label">2024-12-31-00-æ•´ä½“æ¡†æ¶</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /vllmä»£ç åˆ†æ/2024-12-31-01-collect_env.html"><span class="label">2024-12-31-01-collect_env</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">å…·èº«æ™ºèƒ½</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å…·èº«æ™ºèƒ½/2026-2-2-åŸºç¡€æ¦‚å¿µ.html"><span class="label">2026-2-2-åŸºç¡€æ¦‚å¿µ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å…·èº«æ™ºèƒ½/2026-2-3-02-ä»¿çœŸ.html"><span class="label">2026-2-3-02-ä»¿çœŸ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å…·èº«æ™ºèƒ½/2026-2-3-03-å§¿æ€è§£ç®—.html"><span class="label">2026-2-3-03-å§¿æ€è§£ç®—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å…·èº«æ™ºèƒ½/2026-2-4-04-SO-ARM101.html"><span class="label">2026-2-4-04-SO-ARM101</span><span class=""></span></a></li>
</ul>
</li>
<li class="active_parent no_link"><a><span class="label">å®é™…åº”ç”¨</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-1-30-ollama.html"><span class="label">2025-1-30-ollama</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-12-10-è¯­éŸ³è¯†åˆ«.html"><span class="label">2025-12-10-è¯­éŸ³è¯†åˆ«</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-12-22-QLearning.html"><span class="label">2025-12-22-QLearning</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-16-dify.html"><span class="label">2025-2-16-dify</span><span class=""></span></a></li>
<li class="active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-16-langChain.html"><span class="label">2025-2-16-langChain</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-23-langchain2.html"><span class="label">2025-2-23-langchain2</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-26-Loraå¾®è°ƒ.html"><span class="label">2025-2-26-Loraå¾®è°ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-3-20-COZE.html"><span class="label">2025-3-20-COZE</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-4-2-MCP.html"><span class="label">2025-4-2-MCP</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">åµŒå…¥å¼ç§»æ¤</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /åµŒå…¥å¼ç§»æ¤/00ç»†èŠ.html"><span class="label">00ç»†èŠ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /åµŒå…¥å¼ç§»æ¤/2025-12-18-01-æ¨¡å‹é‡åŒ–.html"><span class="label">2025-12-18-01-æ¨¡å‹é‡åŒ–</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ææ²è¯¾ç¨‹</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/0000-0-0-00åŸºç¡€numpy.html"><span class="label">0000-0-0-00åŸºç¡€numpy</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/0000-0-0-00åŸºç¡€pandas.html"><span class="label">0000-0-0-00åŸºç¡€pandas</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2024-10-31-01.html"><span class="label">2024-10-31-01</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2024-11-03-02æ•°æ®ç±»å‹.html"><span class="label">2024-11-03-02æ•°æ®ç±»å‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-08-03åŸºç¡€å‡½æ•°.html"><span class="label">2025-1-08-03åŸºç¡€å‡½æ•°</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-08-04æ•°æ®é›†.html"><span class="label">2025-1-08-04æ•°æ®é›†</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-08-05æ„ŸçŸ¥æœº.html"><span class="label">2025-1-08-05æ„ŸçŸ¥æœº</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-09æ¨¡å‹é€‰æ‹©.html"><span class="label">2025-1-09æ¨¡å‹é€‰æ‹©</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-10-10ä¸¢å¼ƒæ³•.html"><span class="label">2025-1-10-10ä¸¢å¼ƒæ³•</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-11-11æ•°å€¼ç¨³å®šæ€§.html"><span class="label">2025-1-11-11æ•°å€¼ç¨³å®šæ€§</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-12-12å±‚å’Œå—.html"><span class="label">2025-1-12-12å±‚å’Œå—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-12-GPU.html"><span class="label">2025-1-12-GPU</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-12-å®æˆ˜æ¯”èµ›.html"><span class="label">2025-1-12-å®æˆ˜æ¯”èµ›</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-13-13å·ç§¯.html"><span class="label">2025-1-13-13å·ç§¯</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-13-14æ± åŒ–.html"><span class="label">2025-1-13-14æ± åŒ–</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-14-15LeNet.html"><span class="label">2025-1-14-15LeNet</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-14-16AlexNet.html"><span class="label">2025-1-14-16AlexNet</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-14-17VGG.html"><span class="label">2025-1-14-17VGG</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-14-18NiN.html"><span class="label">2025-1-14-18NiN</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-14-19GoogLeNet.html"><span class="label">2025-1-14-19GoogLeNet</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-15-20æ‰¹é‡å½’ä¸€åŒ–.html"><span class="label">2025-1-15-20æ‰¹é‡å½’ä¸€åŒ–</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-15-21æ®‹å·®ç½‘ç»œResNet.html"><span class="label">2025-1-15-21æ®‹å·®ç½‘ç»œResNet</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-16-èŠ¯ç‰‡.html"><span class="label">2025-1-16-èŠ¯ç‰‡</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-17-22æ•°æ®å¢å¹¿.html"><span class="label">2025-1-17-22æ•°æ®å¢å¹¿</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-17-23å¾®è°ƒ.html"><span class="label">2025-1-17-23å¾®è°ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-18-24CIFARæ•°æ®é›†.html"><span class="label">2025-1-18-24CIFARæ•°æ®é›†</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-19-25ç›®æ ‡æ£€æµ‹.html"><span class="label">2025-1-19-25ç›®æ ‡æ£€æµ‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-1-23-26åŒºåŸŸå·ç§¯ç¥ç»ç½‘ç»œ.html"><span class="label">2025-1-23-26åŒºåŸŸå·ç§¯ç¥ç»ç½‘ç»œ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-1-27è¯­ä¹‰åˆ†å‰².html"><span class="label">2025-2-1-27è¯­ä¹‰åˆ†å‰²</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-10-33é•¿çŸ­æœŸè®°å¿†LSTM.html"><span class="label">2025-2-10-33é•¿çŸ­æœŸè®°å¿†LSTM</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-10-34æ·±åº¦å¾ªç¯ç½‘ç»œ.html"><span class="label">2025-2-10-34æ·±åº¦å¾ªç¯ç½‘ç»œ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-10-35-BPTT.html"><span class="label">2025-2-10-35-BPTT</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-10-36åŒå‘å¾ªç¯ç¥ç»ç½‘ç»œ.html"><span class="label">2025-2-10-36åŒå‘å¾ªç¯ç¥ç»ç½‘ç»œ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-11-37ç¼–ç å™¨è§£ç å™¨.html"><span class="label">2025-2-11-37ç¼–ç å™¨è§£ç å™¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-11-38seq2seq.html"><span class="label">2025-2-11-38seq2seq</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-11-39æŸæœç´¢.html"><span class="label">2025-2-11-39æŸæœç´¢</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-11-40æ³¨æ„åŠ›æœºåˆ¶.html"><span class="label">2025-2-11-40æ³¨æ„åŠ›æœºåˆ¶</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-13-41æ³¨æ„åŠ›seq2seq.html"><span class="label">2025-2-13-41æ³¨æ„åŠ›seq2seq</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-15-42è‡ªæ³¨æ„åŠ›.html"><span class="label">2025-2-15-42è‡ªæ³¨æ„åŠ›</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-15-43Transformer.html"><span class="label">2025-2-15-43Transformer</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-15-44BERT.html"><span class="label">2025-2-15-44BERT</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-5-28æ ·å¼è¿ç§».html"><span class="label">2025-2-5-28æ ·å¼è¿ç§»</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-5-29åºåˆ—æ¨¡å‹.html"><span class="label">2025-2-5-29åºåˆ—æ¨¡å‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-6-30æ–‡å­—å¤„ç†.html"><span class="label">2025-2-6-30æ–‡å­—å¤„ç†</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-7-31-å¾ªç¯ç¥ç»ç½‘ç»œRNN.html"><span class="label">2025-2-7-31-å¾ªç¯ç¥ç»ç½‘ç»œRNN</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /ææ²è¯¾ç¨‹/2025-2-9-32-é—¨æ§å¾ªç¯å•å…ƒGRU.html"><span class="label">2025-2-9-32-é—¨æ§å¾ªç¯å•å…ƒGRU</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">è§†è§‰è¯†åˆ«</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/2025-12-12-04-ç»å…¸ç®—æ³•.html"><span class="label">2025-12-12-04-ç»å…¸ç®—æ³•</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/2025-12-12-05-YoloV1.html"><span class="label">2025-12-12-05-YoloV1</span><span class=""></span></a></li>
<li class="not_active no_link"><a><span class="label">K230</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/K230/2026-1-1-01-SDKç¼–è¯‘.html"><span class="label">2026-1-1-01-SDKç¼–è¯‘</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/K230/2026-1-10-03-Linuxä»£ç å¼€å‘.html"><span class="label">2026-1-10-03-Linuxä»£ç å¼€å‘</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/K230/2026-1-3-02-åŸºç¡€åŸç†.html"><span class="label">2026-1-3-02-åŸºç¡€åŸç†</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">MaixCAM</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-11-02-æ¨¡å‹è®­ç»ƒ.html"><span class="label">2025-12-11-02-æ¨¡å‹è®­ç»ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-11-03-å¸¸ç”¨çš„æ¨¡å‹.html"><span class="label">2025-12-11-03-å¸¸ç”¨çš„æ¨¡å‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-14-04-Yoloæ¨¡å‹è½¬æ¢.html"><span class="label">2025-12-14-04-Yoloæ¨¡å‹è½¬æ¢</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-14-05-MaixCDKåŸºç¡€ä½¿ç”¨.html"><span class="label">2025-12-14-05-MaixCDKåŸºç¡€ä½¿ç”¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-16-06-maixcdkå·¥å…·.html"><span class="label">2025-12-16-06-maixcdkå·¥å…·</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-17-07-ç»„ä»¶.html"><span class="label">2025-12-17-07-ç»„ä»¶</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-17-08-Cameraç¤ºä¾‹.html"><span class="label">2025-12-17-08-Cameraç¤ºä¾‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-17-09-APP.html"><span class="label">2025-12-17-09-APP</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-18-06-æ¨¡å‹ç›¸å…³å‚æ•°.html"><span class="label">2025-12-18-06-æ¨¡å‹ç›¸å…³å‚æ•°</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-19-07-AIç¼–è¯‘å™¨.html"><span class="label">2025-12-19-07-AIç¼–è¯‘å™¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-19-08-æ¨¡å‹å®ç°.html"><span class="label">2025-12-19-08-æ¨¡å‹å®ç°</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-20-09-MaixPyç¼–è¯‘.html"><span class="label">2025-12-20-09-MaixPyç¼–è¯‘</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-3-00-èµ„æ–™.html"><span class="label">2025-12-3-00-èµ„æ–™</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/MaixCAM/2025-12-5-01ç¼–è¯‘ä¸‹è½½.html"><span class="label">2025-12-5-01ç¼–è¯‘ä¸‹è½½</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">yolo</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-12-02-åŸºç¡€ä½¿ç”¨.html"><span class="label">2025-12-12-02-åŸºç¡€ä½¿ç”¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-12-03-æ•°æ®é›†.html"><span class="label">2025-12-12-03-æ•°æ®é›†</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-12-04-é¢„æµ‹.html"><span class="label">2025-12-12-04-é¢„æµ‹</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-05-è®­ç»ƒ.html"><span class="label">2025-12-13-05-è®­ç»ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-06-yolov5åŸºç¡€ä½¿ç”¨.html"><span class="label">2025-12-13-06-yolov5åŸºç¡€ä½¿ç”¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-07-AutoDLæœåŠ¡å™¨è®­ç»ƒ.html"><span class="label">2025-12-13-07-AutoDLæœåŠ¡å™¨è®­ç»ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-08-yolov5æ¡†æ¶.html"><span class="label">2025-12-13-08-yolov5æ¡†æ¶</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-09-ä¿®æ”¹ç½‘ç»œ.html"><span class="label">2025-12-13-09-ä¿®æ”¹ç½‘ç»œ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-13-10-æ¨¡å‹éƒ¨ç½².html"><span class="label">2025-12-13-10-æ¨¡å‹éƒ¨ç½²</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/æœºå™¨å­¦ä¹ /è§†è§‰è¯†åˆ«/yolo/2025-12-4-01-yoloå®‰è£….html"><span class="label">2025-12-4-01-yoloå®‰è£…</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>LangChain</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="æœ€åä¿®æ”¹æ—¥æœŸï¼š 2025-12-14">
                                    2025-12-14
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/XuSenfeng/note/tree/master/doc/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-16-langChain.md" target="_blank">
                                    ç¼–è¾‘æœ¬é¡µ
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h2 id="%E6%9E%B6%E6%9E%84">æ¶æ„</h2>
<ul>
<li>LangSmith: ç›‘æ§</li>
<li>LangServe: æœåŠ¡å™¨å¤„ç†</li>
<li>Templates: æ¨¡æ¿</li>
<li>LangChain: æ™ºèƒ½è°ƒç”¨, Agentså¼€å‘ä»¥åŠæ£€ç´¢ç­–ç•¥</li>
<li>LangChainCommunity: ç¤¾åŒº, æ”¯æŒå„ç§å¤§æ¨¡å‹, æç¤ºè¯ç­‰çš„å¤„ç†, è¾“å…¥å†…å®¹çš„æ ¼å¼åŒ–, å·¥å…·è°ƒç”¨çš„æ”¯æŒ</li>
<li>LangChainCore: LCELè¡¨è¾¾å¼è¯­è¨€çš„æ‰§è¡Œ</li>
</ul>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/faaf313af63c5029c7983192c1f43bd2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<p>ä¸»è¦çš„ç»„æˆ</p>
<ul>
<li>LangChainåº“, æœ‰Pythonå’Œjava, é‡Œé¢æœ‰å„ç§ç»„ä»¶çš„æ¥å£ä»¥åŠè¿è¡Œçš„åŸºç¡€</li>
<li>LangChainæ¨¡æ¿: æä¾›çš„AIæ¨¡æ¿</li>
<li>LangServer: FastAPIæŠŠLangChainçš„é“¾(Chain)å‘å¸ƒä¸ºREST API</li>
<li>LangSmith: å¼€å‘å¹³å°äº‘æœåŠ¡</li>
</ul>
<p>åº“</p>
<ul>
<li>langchain-core: åŸºç¡€çš„æŠ½è±¡ä»¥åŠLangChainçš„è¡¨è¾¾è¯­è¨€</li>
<li>langchain-community: ç¬¬ä¸‰å‘é›†æˆ</li>
<li>langchain: é“¾ä»¥åŠä»£ç†å’Œagentæ£€ç´¢ç­–ç•¥</li>
</ul>
<p><img src="https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502181323177.png" alt="image-20250218132339058" /></p>
<blockquote>
<p>è¾“å…¥å’Œæ¨¡æ¿ç»“åˆä»¥åè¾“å…¥åˆ°LLMé‡Œé¢, è¿›è¡Œå¤„ç†è·å¾—è¾“å‡º, æŒ‰ç…§å®¢æˆ·éœ€æ±‚çš„æ ¼å¼è¿›è¡Œç»„è£…</p>
<p>LLM: é—®ç­”æ¨¡å‹, è¾“å…¥ä¸€ä¸ªæ–‡æœ¬, è¿”å›ä¸€ä¸ªæ–‡æœ¬</p>
<p>Chat Model: å¯¹è¯æ¨¡å‹, æ¥æ”¶ä¸€ç»„å¯¹è¯, è¿”å›å¯¹è¯æ¶ˆæ¯, å’ŒèŠå¤©ç±»ä¼¼</p>
</blockquote>
<p>æ ¸å¿ƒæ¦‚å¿µ</p>
<ul>
<li>LLMs</li>
</ul>
<p>å°è£…çš„åŸºç¡€æ¨¡å‹, æ¥å—ä¸€ä¸ªæ–‡æœ¬çš„è¾“å…¥, è¿”å›ä¸€ä¸ªç»“æœ</p>
<ul>
<li>ChatModels</li>
</ul>
<p>èŠå¤©æ¨¡å‹, å’ŒLLMsä¸åŒ, å‘³è•¾å¯¹è¯è®¾è®¡, å¯ä»¥å¤„ç†é•¿ä¸‹æ–‡</p>
<ul>
<li>æ¶ˆæ¯Message</li>
</ul>
<p>èŠå¤©æ¨¡å‹çš„æ¶ˆæ¯å†…å®¹, æœ‰å¤šç§HumanMessage, AIMessage, SystemMessage, FunctionMessage, ToolMessageç­‰</p>
<ul>
<li>æç¤ºprompts</li>
</ul>
<p>æ ¼å¼åŒ–æç¤ºè¯</p>
<ul>
<li>è¾“å‡ºè§£é‡Šå™¨</li>
</ul>
<p>llmè¿”å›ä»¥åä½¿ç”¨ä¸“é—¨çš„è§£é‡Šå™¨è¿›è¡Œæ ¼å¼åŒ–ä¸ºjsonä¹‹ç±»çš„</p>
<ul>
<li>Retrievers</li>
</ul>
<p>ç§æœ‰æ•°æ®å¯¼å…¥å¤§æ¨¡å‹, æé«˜é—®é¢˜çš„è´¨é‡, LangChainå°è£…äº†æ£€ç´¢çš„æ¡†æ¶Retrieveers, å¯ä»¥åŠ å…¥æ–‡æ¡£, åˆ‡å‰², å­˜å‚¨æœç´¢</p>
<ul>
<li>å‘é‡å­˜å‚¨Vector stores</li>
</ul>
<p>ç§æœ‰æ•°æ®çš„è¯­ä¹‰ç›¸ä¼¼æ£€ç´¢, æ”¯æŒå¤šç§å‘é‡æ•°æ®åº“</p>
<ul>
<li>Agent</li>
</ul>
<p>æ™ºèƒ½ä½“, ä»¥LLMä¸ºå†³ç­–å¼•æ“, æ ¹æ®ç”¨æˆ·çš„è¾“å…¥, è‡ªåŠ¨è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿå’Œè®¾å¤‡å®Œæˆä»»åŠ¡</p>
<h2 id="%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B">ç®€å•ç¤ºä¾‹</h2>

<pre class="language-python"><code class="language-python">from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
import os
os.environ[&quot;OPENAI_BASE_URL&quot;] = &quot;https://api.chatanywhere.tech&quot;
llm = ChatOpenAI()

prompt = ChatPromptTemplate.from_messages([
    (&quot;system&quot;, &quot;ä½ æ˜¯ä¸€ä¸ªå›¾ä¹¦ç®¡ç†å‘˜ã€‚&quot;),
    (&quot;user&quot;, &quot;{input}&quot;),
])
# é€šè¿‡LangChainçš„é“¾å¼è°ƒç”¨ç”Ÿæˆä¸€ä¸ªchainå¯¹è±¡
chain  = prompt | llm
# æ‰“å°ç”Ÿæˆçš„å¯¹è¯
result = chain.invoke({&quot;input&quot;: &quot;ä½ å¥½ï¼Œç»™æˆ‘æ¨èä¸€ä¸ªæ•…äº‹ä¹¦ã€‚&quot;})
print(result)

&quot;&quot;&quot;
content='ä½ å¥½ï¼Œæˆ‘æ¨èç»™ä½ ä¸€æœ¬ç»å…¸çš„æ•…äº‹ä¹¦ã€Šå°ç‹å­ã€‹ã€‚è¿™æœ¬ä¹¦ç”±æ³•å›½ä½œå®¶å®‰æ‰˜ä¸‡Â·å¾·Â·åœ£-åŸƒå…‹çµ®ä½åˆ›ä½œï¼Œè®²è¿°äº†ä¸€ä¸ªå°ç‹å­åœ¨å®‡å®™ä¸­çš„å†’é™©æ•…äº‹ï¼Œé€šè¿‡ä»–å’Œå„ç§å¥‡ç‰¹è§’è‰²çš„ç›¸é‡ï¼Œæ­ç¤ºäº†äººç”Ÿã€å‹æƒ…ã€çˆ±æƒ…ã€è´£ä»»ç­‰æ·±åˆ»çš„ä¸»é¢˜ï¼Œæ˜¯ä¸€éƒ¨å¯Œæœ‰å“²ç†çš„ä½œå“ã€‚å¸Œæœ›ä½ ä¼šå–œæ¬¢è¿™æœ¬ä¹¦ï¼' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 149, 'prompt_tokens': 32, 'total_tokens': 181, 'completion_tokens_details': None, 'prompt_tokens_details': None}, 'model_name': 'gpt-3.5-turbo-0125', 'system_fingerprint': 'fp_0165350fbb', 'finish_reason': 'stop', 'logprobs': None} id='run-b9a821df-af44-429d-906c-8f5ddb6a46e7-0' usage_metadata={'input_tokens': 32, 'output_tokens': 149, 'total_tokens': 181, 'input_token_details': {}, 'output_token_details': {}}
&quot;&quot;&quot;
# ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼å¯ä»¥æ”¹å˜è¾“å‡ºçš„æ ¼å¼
from langchain_core.output_parsers import StrOutputParser
output_parser = StrOutputParser()
chain  = prompt | llm | output_parser
&quot;&quot;&quot;
ä½ å¥½ï¼å½“ç„¶å¯ä»¥ã€‚æˆ‘æ¨èä½ é˜…è¯»ã€Šå°ç‹å­ã€‹è¿™æœ¬ä¹¦ã€‚è¿™æ˜¯ä¸€æœ¬ç»å…¸çš„ç«¥è¯æ•…äº‹ï¼Œè®²è¿°äº†ä¸€ä½ç‹å­åœ¨ä¸åŒæ˜Ÿçƒä¸Šçš„å†’é™©æ•…äº‹ï¼Œä»¥åŠä»–ä¸ä¸€åªç‹ç‹¸å’Œä¸€æœµç«ç‘°çš„æ„Ÿäººæƒ…æ„Ÿçº è‘›ã€‚è¿™æœ¬ä¹¦æ·±åˆ»åœ°æ¢è®¨äº†å‹è°Šã€çˆ±æƒ…å’Œäººç”Ÿæ„ä¹‰çš„ä¸»é¢˜ï¼Œæ˜¯ä¸€éƒ¨æ„Ÿäººè‡³æ·±çš„æ–‡å­¦ä½œå“ã€‚å¸Œæœ›ä½ ä¼šå–œæ¬¢ï¼
&quot;&quot;&quot;
</code></pre>
<h2 id="%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B">æç¤ºè¯å·¥ç¨‹</h2>
<p>å’ŒAIè¿›è¡Œæ²Ÿé€šçš„æ—¶å€™éœ€è¦ä½¿ç”¨æç¤ºè¯å’ŒAIè¿›è¡Œå¯¹è¯, åŒæ—¶AIå¯èƒ½å‡ºç°å¹»è§‰, å¼€å‘çš„æ—¶å€™ä¸å¯ä»¥ç›´æ¥è¿›è¡Œç¡¬ç¼–, ä¸åˆ©äºæç¤ºè¯ç®¡ç†, é€šè¿‡æç¤ºè¯çš„æ¨¡æ¿è¿›è¡Œç»´æŠ¤</p>
<p>å®é™…ç”¨æˆ·çš„è¾“å…¥åªæ˜¯æç¤ºè¯é‡Œé¢ä¸€ä¸ªå‚æ•°</p>
<ul>
<li>å‘ç»™å¤§æ¨¡å‹çš„æŒ‡ä»¤</li>
<li>ä¸€ç»„é—®ç­”ç¤ºä¾‹</li>
<li>å‘ç»™æ¨¡å‹çš„é—®é¢˜</li>
</ul>
<h3 id="%E6%9E%84%E6%88%90">æ„æˆ</h3>
<ul>
<li><p>PromptValue: è¡¨ç¤ºæ¨¡å‹è¾“å…¥çš„ç±»ã€‚</p>
</li>
<li><p>Prompt Templates: è´Ÿè´£æ„å»º PromptValue çš„ç±»ã€‚</p>
</li>
<li><p>ç¤ºä¾‹é€‰æ‹©å™¨ Example Selectors: åœ¨æç¤ºä¸­åŒ…å«ç¤ºä¾‹é€šå¸¸æ˜¯æœ‰ç”¨çš„ã€‚è¿™äº›ç¤ºä¾‹å¯ä»¥ç¡¬ç¼–ç ï¼Œä½†å¦‚æœå®ƒä»¬æ˜¯åŠ¨æ€é€‰æ‹©çš„ï¼Œåˆ™é€šå¸¸æ›´æœ‰ç”¨ã€‚</p>
</li>
<li><p>è¾“å‡ºè§£æå™¨ Output Parsers: è¯­è¨€æ¨¡å‹ï¼ˆå’ŒèŠå¤©æ¨¡å‹ï¼‰è¾“å‡ºæ–‡æœ¬ã€‚ä½†æ˜¯è®¸å¤šæ—¶å€™ï¼Œæ‚¨å¯èƒ½æƒ³è·å¾—æ¯”ä»…æ–‡æœ¬æ›´æœ‰ç»“æ„åŒ–çš„ä¿¡æ¯ã€‚è¿™å°±æ˜¯è¾“å‡ºè§£æå™¨å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚è¾“å‡ºè§£æå™¨è´Ÿè´£ï¼ˆ1ï¼‰æŒ‡ç¤ºæ¨¡å‹å¦‚ä½•æ ¼å¼åŒ–è¾“å‡ºï¼Œï¼ˆ2ï¼‰å°†è¾“å‡ºè§£æä¸ºæ‰€éœ€æ ¼å¼ï¼ˆåŒ…æ‹¬å¿…è¦æ—¶è¿›è¡Œé‡è¯•ï¼‰ã€‚</p>
</li>
</ul>
<p>æœ‰ä¸¤ä¸ªæ–¹æ³•ä¸€å®šæœ‰å®ç°</p>
<p><code>get_format_instructions() -&gt; str</code>ï¼šä¸€ä¸ªè¿”å›åŒ…å«è¯­è¨€æ¨¡å‹è¾“å‡ºæ ¼å¼åŒ–æŒ‡ä»¤çš„å­—ç¬¦ä¸²çš„æ–¹æ³•ã€‚ parse(str) -&gt; Anyï¼šä¸€ä¸ªæ¥å—å­—ç¬¦ä¸²ï¼ˆå‡è®¾ä¸ºè¯­è¨€æ¨¡å‹çš„å“åº”ï¼‰å¹¶å°†å…¶è§£æä¸ºæŸç§ç»“æ„çš„æ–¹æ³•ã€‚ è¿˜æœ‰ä¸€ä¸ªå¯é€‰çš„æ–¹æ³•ï¼š</p>
<p><code>parse_with_prompt(str) -&gt; Any</code>ï¼šä¸€ä¸ªæ¥å—å­—ç¬¦ä¸²ï¼ˆå‡è®¾ä¸ºè¯­è¨€æ¨¡å‹çš„å“åº”ï¼‰å’Œæç¤ºï¼ˆå‡è®¾ä¸ºç”Ÿæˆæ­¤å“åº”çš„æç¤ºï¼‰çš„æ–¹æ³•ï¼Œå¹¶å°†å…¶è§£æä¸ºæŸç§ç»“æ„ã€‚åœ¨è¾“å‡ºè§£æå™¨å¸Œæœ›ä»¥æŸç§æ–¹å¼é‡è¯•æˆ–ä¿®å¤è¾“å‡ºï¼Œå¹¶ä¸”éœ€è¦æ¥è‡ªæç¤ºçš„ä¿¡æ¯æ—¶ï¼Œæä¾›æç¤ºéå¸¸æœ‰ç”¨ã€‚</p>
<h3 id="%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%A8%A1%E6%9D%BF">å­—ç¬¦ä¸²æ ¼å¼çš„æ¨¡æ¿</h3>

<pre class="language-python"><code class="language-python">from langchain_core.prompts import ChatPromptTemplate
# è¿™ç§çš„ä¼šç”Ÿæˆæ¶ˆæ¯, å¯ä»¥æœ‰ä¸Šä¸‹æ–‡
chat_template = ChatPromptTemplate.from_messages([
    (&quot;system&quot;, &quot;ä½ æ˜¯ä¸€ä¸ªçŒ«å¨˜ï¼Œä½ çš„åå­—æ˜¯{name}ã€‚&quot;),
    (&quot;system&quot;, &quot;ä½ æ­£åœ¨ä¸€å®¶å® ç‰©åº—é‡Œç­‰å¾…è¢«é¢†å…»ã€‚&quot;),
    (&quot;human&quot;, &quot;ä½ å¥½ï¼Œå°çŒ«ã€‚&quot;),
    (&quot;ai&quot;, &quot;ä½ å¥½, å–µ~~&quot;),
    (&quot;human&quot;, &quot;{input}&quot;)
])

message = chat_template.format_messages(name = &quot;å°èŠ±&quot;, input = &quot;ä½ çš„åå­—æ˜¯ä»€ä¹ˆ?&quot;)
print(message)
&quot;&quot;&quot;
[
SystemMessage(content='ä½ æ˜¯ä¸€ä¸ªçŒ«å¨˜ï¼Œä½ çš„åå­—æ˜¯å°èŠ±ã€‚', additional_kwargs={}, response_metadata={}), 
SystemMessage(content='ä½ æ­£åœ¨ä¸€å®¶å® ç‰©åº—é‡Œç­‰å¾…è¢«é¢†å…»ã€‚', additional_kwargs={}, response_metadata={}), 
HumanMessage(content='ä½ å¥½ï¼Œå°çŒ«ã€‚', additional_kwargs={}, response_metadata={}), AIMessage(content='ä½ å¥½, å–µ~~', additional_kwargs={}, response_metadata={}), HumanMessage(content='ä½ çš„åå­—æ˜¯ä»€ä¹ˆ?', additional_kwargs={}, response_metadata={})
]
&quot;&quot;&quot;
# ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²
from langchain_core.prompts import PromptTemplate
prompt_template = PromptTemplate.from_template(
    &quot;ä½ çš„åå­—æ˜¯{name}, ä½ æ­£åœ¨ä¸€å®¶å® ç‰©åº—é‡Œç­‰å¾…è¢«é¢†å…»ã€‚ä½ å¥½ï¼Œå°çŒ«ã€‚{input}&quot;
)
message = prompt_template.format(name = &quot;å°èŠ±&quot;, input = &quot;ä½ çš„åå­—æ˜¯ä»€ä¹ˆ?&quot;)
print(message)
&quot;&quot;&quot;
ä½ çš„åå­—æ˜¯å°èŠ±, ä½ æ­£åœ¨ä¸€å®¶å® ç‰©åº—é‡Œç­‰å¾…è¢«é¢†å…»ã€‚ä½ å¥½ï¼Œå°çŒ«ã€‚ä½ çš„åå­—æ˜¯ä»€ä¹ˆ?
&quot;&quot;&quot;
from langchain_core.messages import SystemMessage
from langchain.prompts import HumanMessagePromptTemplate

chat_template = ChatPromptTemplate.from_messages([
    SystemMessage(
        content = (&quot;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;)
    ),
    HumanMessagePromptTemplate.from_template(&quot;{text}&quot;)
])

message = chat_template.format_messages(text = &quot;ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ çš„äº§å“ã€‚&quot;)
print(message)
&quot;&quot;&quot;
[
SystemMessage(content='ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚', additional_kwargs={}, response_metadata={}), 
HumanMessage(content='ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ çš„äº§å“ã€‚', additional_kwargs={}, response_metadata={})
]
&quot;&quot;&quot;

</code></pre>
<p>æ¶ˆæ¯æç¤ºè¯é‡Œé¢æœ‰ä¸‰ç§è§’è‰²</p>
<ul>
<li>åŠ©æ‰‹Assistant: AIçš„å›ç­”</li>
<li>äººç±»User: ä½ å‘é€çš„æ¶ˆæ¯</li>
<li>ç³»ç»ŸSystem: è¿›è¡ŒAIèº«ä»½çš„æè¿°</li>
</ul>
<h3 id="MessagesPlaceholder">MessagesPlaceholder</h3>
<p>ç‰¹å®šçš„ä½ç½®æ·»åŠ æ¶ˆæ¯åˆ—è¡¨, ä¸Šé¢å¤„ç†çš„æ˜¯ä¸¤æ¡æ¶ˆæ¯, æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸², å¦‚æœè¾“å…¥çš„æ˜¯ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª</p>

<pre class="language-python"><code class="language-python">from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import HumanMessage
prompt_template = ChatPromptTemplate.from_messages([
    (&quot;system&quot;, &quot;ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹&quot;),
    MessagesPlaceholder(&quot;msgs&quot;)
])

prompt_template.invoke({&quot;msgs&quot;: [HumanMessage(content=&quot;ä½ å¥½&quot;)]})
&quot;&quot;&quot;
ChatPromptValue(
messages=[
SystemMessage(content='ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹', additional_kwargs={}, response_metadata={}), 
HumanMessage(content='ä½ å¥½', additional_kwargs={}, response_metadata={})
]
)
&quot;&quot;&quot;
</code></pre>
<blockquote>
<p>å¯ä»¥çœ‹ä¸ºä¸€ä¸ªå ä½ç¬¦, è¿™é‡Œå¯ä»¥ç©¿è¿›å»ä¸€ç³»åˆ—çš„Message</p>
</blockquote>
<h3 id="Few-shot-prompt-template">Few-shot prompt template</h3>
<p>è¿½åŠ æç¤ºè¯ç¤ºä¾‹</p>
<p>å¸®åŠ©äº¤äº’æ ·æœ¬æ›´å¥½çš„äº†è§£ç”¨æˆ·çš„æ„å›¾, ä»è€Œæ›´å¥½çš„å›ç­”é—®é¢˜ä»¥åŠå¤„ç†ä»»åŠ¡, ä½¿ç”¨å°‘é‡çš„ç¤ºä¾‹æŒ‡å¯¼æ¨¡å‹è¾“å…¥, å¯ä»¥ä½¿ç”¨ç¤ºä¾‹é›†è¿›è¡Œ</p>

<pre class="language-python"><code class="language-python">from langchain.prompts.few_shot import FewShotPromptTemplate
from langchain.prompts.prompt import PromptTemplate

examples = [
    {
        &quot;question&quot;: &quot;è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³?&quot;,
        &quot;answer&quot;: 
                    &quot;&quot;&quot;
                    è¿™é‡Œè¦å›ç­”çš„æ˜¯è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³? æ¯›æ³½ä¸œçš„å¯¿å‘½æ˜¯1893å¹´12æœˆ26æ—¥å‡ºç”Ÿ, 1976å¹´9æœˆ9æ—¥å»ä¸–, äº«å¹´82å². 
                    é‚“å°å¹³çš„å¯¿å‘½æ˜¯1904å¹´8æœˆ22æ—¥å‡ºç”Ÿ, 1997å¹´2æœˆ19æ—¥å»ä¸–, äº«å¹´92å². 
                    å› æ­¤, é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.
                    æ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.        
                    &quot;&quot;&quot;
    },
    {
        &quot;question&quot;: &quot;å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯å“ªå›½äºº?&quot;,
        &quot;answer&quot;: 
                    &quot;&quot;&quot;
                    è¿™é‡Œè¦å›ç­”çš„æ˜¯è·Ÿè¿›é—®é¢˜å—? æ˜¯çš„
                    è·Ÿè¿›: å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯è°?
                    å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯é¥ºå­.
                    è·Ÿè¿›: é¥ºå­æ˜¯å“ªå›½äºº?
                    é¥ºå­æ˜¯ä¸­å›½äºº.
                    æ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é¥ºå­æ˜¯ä¸­å›½äºº.
                    &quot;&quot;&quot;
    }
]
# ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿æ¥ç”Ÿæˆé—®é¢˜å’Œç­”æ¡ˆ
example_prompt = PromptTemplate(input_variables=[&quot;question&quot;, &quot;answer&quot;], template=&quot;é—®é¢˜: {question}\\n{answer}&quot;)
&quot;&quot;&quot;
StringPromptValue
&quot;&quot;&quot;
prompt = FewShotPromptTemplate(
    example_prompt=example_prompt,
    examples=examples,
    suffix=&quot;é—®é¢˜:{input}&quot;, # åç¼€
    input_variables=[&quot;input&quot;]
)
print(prompt.format(input=&quot;å²å‡¯æ­Œçˆ¸çˆ¸æ˜¯è°?&quot;))
&quot;&quot;&quot;
é—®é¢˜: è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³?\n
                    è¿™é‡Œè¦å›ç­”çš„æ˜¯è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³? æ¯›æ³½ä¸œçš„å¯¿å‘½æ˜¯1893å¹´12æœˆ26æ—¥å‡ºç”Ÿ, 1976å¹´9æœˆ9æ—¥å»ä¸–, äº«å¹´82å². 
                    é‚“å°å¹³çš„å¯¿å‘½æ˜¯1904å¹´8æœˆ22æ—¥å‡ºç”Ÿ, 1997å¹´2æœˆ19æ—¥å»ä¸–, äº«å¹´92å². 
                    å› æ­¤, é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.
                    æ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.        


é—®é¢˜: å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯å“ªå›½äºº?\n
                    è¿™é‡Œè¦å›ç­”çš„æ˜¯è·Ÿè¿›é—®é¢˜å—? æ˜¯çš„
                    è·Ÿè¿›: å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯è°?
                    å“ªå’ä¹‹é­”ç«¥é™ä¸–çš„å¯¼æ¼”æ˜¯é¥ºå­.
                    è·Ÿè¿›: é¥ºå­æ˜¯å“ªå›½äºº?
                    é¥ºå­æ˜¯ä¸­å›½äºº.
                    æ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é¥ºå­æ˜¯ä¸­å›½äºº.


é—®é¢˜:å²å‡¯æ­Œçˆ¸çˆ¸æ˜¯è°?
&quot;&quot;&quot;
</code></pre>
<blockquote>
<p>è¿™é‡Œçš„example_promptç›´æ¥ä½¿ç”¨examplesçš„æ—¶å€™éœ€è¦ä½¿ç”¨**è§£å¼•ç”¨</p>

<pre class="language-python"><code class="language-python">example_prompt = PromptTemplate(input_variables=[&quot;question&quot;, &quot;answer&quot;], template=&quot;é—®é¢˜: {question}\\n{answer}&quot;)
print(example_prompt.format(**examples[0]))
</code></pre>
</blockquote>
<h3 id="%E7%A4%BA%E4%BE%8B%E9%80%89%E6%8B%A9%E5%99%A8">ç¤ºä¾‹é€‰æ‹©å™¨</h3>
<p>å®é™…ä½¿ç”¨çš„æ—¶å€™ä¸å¯ä»¥å¸¦å¤ªé•¿çš„ç¤ºä¾‹, æ‰€ä»¥å¯ä»¥ä½¿ç”¨ç¤ºä¾‹é€‰æ‹©å™¨</p>
<p>ExampleSelector, åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™æŠŠé—®é¢˜å’Œç¤ºä¾‹è¿›è¡Œä¸€ä¸ªåŒ¹é…, ä½¿ç”¨å‘é‡æ•°æ®åº“è¿›è¡Œæœç´¢</p>

<pre class="language-python"><code class="language-python">from langchain.prompts.example_selector import SemanticSimilarityExampleSelector # è¯­ä¹‰ç›¸ä¼¼åº¦é€‰æ‹©å™¨
from langchain_community.vectorstores import Chroma # å¼€æºçš„å‘é‡åº“
from langchain_openai import OpenAIEmbeddings # OpenAIçš„Embeddings

example_selector = SemanticSimilarityExampleSelector.from_examples(
    examples=examples,
    vectorstore_cls=Chroma,
    embeddings=OpenAIEmbeddings(),
    k = 1,
)

question = &quot;çˆ±å› æ–¯å¦å’Œéœé‡‘è°æ´»å¾—é•¿?&quot;
selected_examples = example_selector.select_examples({&quot;question&quot;:question})
print(selected_examples)
for example in selected_examples:
    print(example_prompt.format(**example))

&quot;&quot;&quot;
[{'answer': '\n è¿™é‡Œè¦å›ç­”çš„æ˜¯è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³? æ¯›æ³½ä¸œçš„å¯¿å‘½æ˜¯1893å¹´12æœˆ26æ—¥å‡ºç”Ÿ, 1976å¹´9æœˆ9æ—¥å»ä¸–, äº«å¹´82å². \né‚“å°å¹³çš„å¯¿å‘½æ˜¯1904å¹´8æœˆ22æ—¥å‡ºç”Ÿ, 1997å¹´2æœˆ19æ—¥å»ä¸–, äº«å¹´92å². \n     å› æ­¤, é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.\næ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.  \n ', 'question': 'è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³?'}]
é—®é¢˜: è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³?\n
                    è¿™é‡Œè¦å›ç­”çš„æ˜¯è°çš„å¯¿å‘½æ›´é•¿, æ¯›æ³½ä¸œè¿˜æ˜¯é‚“å°å¹³? æ¯›æ³½ä¸œçš„å¯¿å‘½æ˜¯1893å¹´12æœˆ26æ—¥å‡ºç”Ÿ, 1976å¹´9æœˆ9æ—¥å»ä¸–, äº«å¹´82å². 
                    é‚“å°å¹³çš„å¯¿å‘½æ˜¯1904å¹´8æœˆ22æ—¥å‡ºç”Ÿ, 1997å¹´2æœˆ19æ—¥å»ä¸–, äº«å¹´92å². 
                    å› æ­¤, é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.
                    æ‰€ä»¥æœ€ç»ˆçš„ç­”æ¡ˆæ˜¯é‚“å°å¹³çš„å¯¿å‘½æ›´é•¿.
&quot;&quot;&quot;
</code></pre>
<p>ç›´æ¥è¿”å›çš„æ•°æ®è¿˜æ˜¯ä¸€ä¸ªå­—å…¸çš„</p>
<h2 id="%E5%B7%A5%E4%BD%9C%E6%B5%81">å·¥ä½œæµ</h2>
<p>é“¾ï¼ˆ Chains ï¼‰æ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„æ¦‚å¿µï¼Œå®ƒæŒ‡çš„æ˜¯å°†ä¸€ç³»åˆ—æ¨¡å—åŒ–ç»„ä»¶ï¼ˆæˆ–å…¶ä»–é“¾ï¼‰ä»¥ç‰¹å®šæ–¹å¼ç»„åˆèµ·æ¥ï¼Œä»¥å®ç°å…±åŒçš„ç”¨ä¾‹ã€‚</p>
<p>æœ€å¸¸ç”¨çš„é“¾ç±»å‹æ˜¯LLMChainï¼ˆLLMé“¾ï¼‰ï¼Œå®ƒç»“åˆäº†PromptTemplateï¼ˆæç¤ºæ¨¡æ¿ï¼‰ã€Modelï¼ˆæ¨¡å‹ï¼‰å’ŒGuardrailsï¼ˆå®ˆå«ï¼‰æ¥æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œè¿›è¡Œç›¸åº”çš„æ ¼å¼åŒ–ï¼Œå°†å…¶ä¼ é€’ç»™æ¨¡å‹å¹¶è·å–å“åº”ï¼Œç„¶åéªŒè¯å’Œä¿®æ­£ï¼ˆå¦‚æœéœ€è¦ï¼‰æ¨¡å‹çš„è¾“å‡º</p>
<p>å¯ä»¥ä½¿ç”¨åŒæ­¥å’Œå¼‚æ­¥çš„API, å¯ä»¥åœ¨ä»»æ„ä½ç½®è¿›è¡Œé‡è¯•ä»¥åŠå›é€€, è®¿é—®ä¸­é—´çš„ç»“æœ</p>
<h3 id="Runable-interface">Runable interface</h3>
<p>ä¸€ä¸ªé€šç”¨çš„æ¥å£, æ‰€æœ‰çš„éƒ¨ä»¶éƒ½æ”¯æŒè¿™ä¸ªæ¥å£, åŒ…æ‹¬ä»¥ä¸‹çš„å†…å®¹:</p>
<ul>
<li>stream: è¿”å›å“åº”çš„æ•°æ®å—, æ•°æ®å—ä¼ è¾“, è¾“å‡ºçš„æ—¶å€™æ˜¯ä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„, å‡å°‘ç­‰å¾…çš„æ—¶é—´</li>
<li>invoke: å¯¹è¾“å…¥çš„è°ƒç”¨é“¾, åŒæ­¥è°ƒç”¨, æ²¡æœ‰ç»“æœä¸€ç›´ç­‰å¾…</li>
<li>batch: è¾“å…¥åˆ—è¡¨çš„è°ƒç”¨é“¾, æ‰¹é‡è°ƒç”¨, åŒæ—¶è°ƒç”¨å¤šæ¬¡</li>
</ul>
<p>è¿˜å¯ä»¥ä½¿ç”¨å¼‚æ­¥çš„æ–¹æ³•, å’Œasyncio+awaitä¸€èµ·ä½¿ç”¨</p>
<ul>
<li>astream: å¼‚æ­¥è¿”å›ç›¸åº”çš„æ•°æ®é“¾</li>
<li>ainvoke: å¼‚æ­¥å¯¹è¾“å…¥çš„è°ƒç”¨é“¾</li>
<li>abatch: å¼‚æ­¥å¯¹è¾“å…¥åˆ—è¡¨çš„è°ƒç”¨</li>
<li>astream_log: å¼‚æ­¥è¿”å›ä¸­é—´æ­¥éª¤, ä»¥åŠæœ€ç»ˆçš„ç›¸åº”</li>
<li>astream_events: å¤„ç†æ—¶é—´</li>
</ul>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒLangChainä¸­çš„é“¾åŒ…å«: å¤§æ¨¡å‹(LLMs)ã€æç¤ºè¯æ¨¡ç‰ˆ(Prompt Template)ã€å·¥å…·(Tools)å’Œè¾“å‡ºè§£æå™¨(Output Parsers)ã€‚è¿™å‡ éƒ¨åˆ†éƒ½ç»§æ‰¿å¹¶å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æ˜¯<code>Runnable</code>çš„å®ä¾‹ã€‚</p>
<p>åœ¨LangChainä¸­ï¼Œå¯ä»¥ä½¿ç”¨LangChain Expression Language(LCEL)å°†å¤šä¸ª<code>Runnable</code>ç»„åˆæˆé“¾ã€‚å…¶å…·ä½“çš„<code>Runnable</code>ç»„åˆæ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li><code>RunnableSequence</code>:æŒ‰é¡ºåºè°ƒç”¨ä¸€ç³»åˆ—å¯è¿è¡Œæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ª<code>Runnable</code>çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªçš„è¾“å…¥ã€‚ä¸€èˆ¬é€šè¿‡ä½¿ç”¨<code>|</code>è¿ç®—ç¬¦æˆ–å¯è¿è¡Œé¡¹åˆ—è¡¨æ¥æ„é€ ã€‚</li>
</ul>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableSequence
#æ–¹æ³•1
chain=prompt|llm
#æ–¹æ³•2
chain = RunnableSequence([prompt,llm])
</code></pre>
<ul>
<li><code>RunnableParallell</code>:åŒæ—¶è°ƒç”¨å¤š<code>Runnable</code>ã€‚åœ¨åºåˆ—ä¸­ä½¿ç”¨dictæˆ–é€šè¿‡å°†dictä¼ é€’ç»™<code>RunnableParallel</code>æ¥æ„é€ å®ƒã€‚</li>
</ul>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableLambda

def add_one(x: int) -&gt; int:
    return x + 1

def mul_two(x: int) -&gt; int:
    return x * 2

def mul_three(x: int) -&gt; int:
    return x * 3

runnable_1 = RunnableLambda(add_one)
runnable_2 = RunnableLambda(mul_two)
runnable_3 = RunnableLambda(mul_three)
#æ–¹æ³•1
sequence = runnable_1 | { 
    &quot;mul_two&quot;: runnable_2,
    &quot;mul_three&quot;: runnable_3,
}
#æ–¹æ³•2
sequence = runnable_1 | RunnableParallel(
     {&quot;mul_two&quot;: runnable_2, &quot;mul_three&quot;: runnable_3})
</code></pre>
<h4 id="%E5%B8%B8%E7%94%A8%E7%B1%BB">å¸¸ç”¨ç±»</h4>
<p>RunnableLambdaå’ŒRunnableGeneratorè¿™ä¸¤ä¸ªç±»é€šå¸¸ç”¨æ¥è‡ªå®šä¹‰Runnableã€‚è¿™ä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li><code>RunnableLambda</code>:æ˜¯å°†Pythonä¸­çš„å¯è°ƒç”¨å¯¹è±¡åŒ…è£…æˆRunnable, è¿™ç§ç±»å‹çš„Runnableæ— æ³•å¤„ç†æµå¼æ•°æ®ã€‚</li>
<li><code>RunnableGenerator</code>:å°†Pythonä¸­çš„ç”Ÿæˆå™¨åŒ…è£…æˆRunnable,å¯ä»¥å¤„ç†æµå¼æ•°æ®ã€‚</li>
</ul>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableLambda,RunnableGenerator
from dotenv import load_dotenv,find_dotenv
_=load_dotenv(find_dotenv())
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import CommaSeparatedListOutputParser

#ç®€å•çš„ä¾‹å­ï¼Œè¾“å‡º1åˆ°10ä¹‹é—´çš„æ‰€æœ‰æ•´æ•°
prompt=PromptTemplate.from_template(&quot;è¾“å‡º1åˆ°{max_value}ä¹‹é—´çš„æ‰€æœ‰æ•´æ•°ã€‚æ¯ä¸ªæ•°å­—ä¹‹é—´ç”¨é€—å·,åˆ†éš”, æ— ç»“å°¾ç¬¦ã€‚&quot;)
def add_one(x):
    return ' '.join([str((int(i)+1)) for i in x])
runnable=RunnableLambda(add_one) # ä¸€ä¸ªç®€å•çš„lambdaå‡½æ•°ï¼Œå°†è¾“å…¥çš„æ•°å­—åŠ 1
#éæµå¼å¤„ç†
llm=ChatOpenAI()
# CommaSeparatedListOutputParser() ç”¨äºè§£æé€—å·åˆ†éš”çš„æ•°å­—, è¾“å‡ºä¸ºä¸€ä¸ªåˆ—è¡¨, æ¯ä¸€é¡¹ä¸ºä¸€ä¸ªæ•°å­—
chain=prompt | llm | CommaSeparatedListOutputParser() | runnable
print(chain.invoke({&quot;max_value&quot;:&quot;10&quot;}))

#æµå¼å¤„ç†
stream_llm=ChatOpenAI(model_kwargs={&quot;stream&quot;:True})
def stream_add_one(x):
    print(x)
    for i in x:
        if i.content.isdigit():
            yield str((int(i.content)+1))
stream_chain=prompt | stream_llm | RunnableGenerator(stream_add_one)
for chunk in stream_chain.stream({&quot;max_value&quot;:&quot;10&quot;}):
    print(chunk)
</code></pre>
<h4 id="RunableBinding">RunableBinding</h4>
<p>RunnableBindingå¯ä»¥çœ‹ä½œæ˜¯Runnableçš„è£…é¥°å™¨ï¼Œå®ƒå…è®¸åœ¨ä¸æ”¹å˜åŸå‡½æ•°ä»£ç çš„å‰æä¸‹ï¼ŒåŠ¨æ€åœ°æ·»åŠ æˆ–ä¿®æ”¹å‡½æ•°çš„åŠŸèƒ½ã€‚Runnableä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•åˆ›å»ºRunnableBindingç±»æˆ–å…¶å­ç±»ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>bind: ç»‘å®šè¿è¡Œå‚æ•°kwargsã€‚æ¯”å¦‚ï¼Œå¯ä»¥å°†å¸¸ç”¨çš„æ–¹æ³•(æ¯”å¦‚invoke, batch, transform, streamåŠå…¶ä»–)ä¸­çš„å¯é€‰å‚æ•°åˆ°Runnableä¸Šã€‚</li>
<li>with_configï¼šç»‘å®šconfigã€‚</li>
<li>with_listenersï¼šç»‘å®šç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨ã€‚Runnableå¯ä»¥è®¾ç½®ä¸‰ç±»ç›‘å¬å™¨ï¼šon_startã€on_endå’Œon_errorã€‚é€šè¿‡ç›‘è§†å™¨å¯ä»¥è·å–ç›¸å…³è¿è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶idã€ç±»å‹ã€è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ã€start_timeã€end_timeä»¥åŠå…¶ä»–æ ‡è®°å’Œå…ƒæ•°æ®ã€‚å…·ä½“ä¸¾ä¾‹å¦‚ä¸‹ï¼š</li>
</ul>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableLambda
from langchain_core.tracers.schemas import Run
import time

def add_one(a):
    try:
        return a+1
    except Exception as e:
        print(&quot;Error: æ•°æ®ç±»å‹é”™è¯¯ï¼Œæ— æ³•è¿›è¡ŒåŠ æ³•è¿ç®—&quot;,e)

def fn_start(run_obj: Run):
    print(&quot;Runnableå¼€å§‹è¿è¡Œæ—¶é—´:&quot;,run_obj.start_time)

def fn_end(run_obj: Run):
    print(&quot;Runnableç»“æŸè¿è¡Œæ—¶é—´:&quot;,run_obj.end_time)

def fn_error(run_obj: Run):
    print(run_obj.error)

runnable=RunnableLambda(add_one).with_listeners(on_start=fn_start,
                                                on_end=fn_end,
                                                on_error=fn_error)
runnable.invoke(2)
runnable.invoke(&quot;2&quot;)

&quot;&quot;&quot;
Runnableå¼€å§‹è¿è¡Œæ—¶é—´: 2025-02-21 10:42:16.286062+00:00
Runnableç»“æŸè¿è¡Œæ—¶é—´: 2025-02-21 10:42:16.287158+00:00
Runnableå¼€å§‹è¿è¡Œæ—¶é—´: 2025-02-21 10:42:16.287158+00:00
Error: æ•°æ®ç±»å‹é”™è¯¯ï¼Œæ— æ³•è¿›è¡ŒåŠ æ³•è¿ç®— can only concatenate str (not &quot;int&quot;) to str
Runnableç»“æŸè¿è¡Œæ—¶é—´: 2025-02-21 10:42:16.287158+00:00
&quot;&quot;&quot;
</code></pre>
<ul>
<li>with_typesï¼šè¦†ç›–è¾“å…¥å’Œè¾“å‡ºç±»å‹ã€‚</li>
<li>with_fallbacksï¼šç»‘å®šå›é€€ç­–ç•¥ã€‚</li>
<li>with_retryï¼šç»‘å®šé‡è¯•ç­–ç•¥ã€‚</li>
</ul>
<h4 id="RunnableEach">RunnableEach</h4>
<p><code>RunnableEach</code>æ˜¯ä¸€ä¸ªç”¨äºæ‰¹é‡å¤„ç†ä»»åŠ¡çš„ç»„ä»¶ï¼Œå®ƒå¯ä»¥å¯¹ä¸€ç»„è¾“å…¥æ•°æ®åˆ†åˆ«åº”ç”¨æŒ‡å®šçš„<code>Runnable</code>ç»„ä»¶</p>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableLambda
from langchain_core.runnables.base import RunnableEach

def add_one(a):
    try:
        return a+1
    except Exception as e:
        print(&quot;Error: æ•°æ®ç±»å‹é”™è¯¯ï¼Œæ— æ³•è¿›è¡ŒåŠ æ³•è¿ç®—&quot;,e)
runnable=RunnableEach(bound=RunnableLambda(add_one))
print(runnable.invoke([1,2,4]))
</code></pre>
<h4 id="RunnableBranch">RunnableBranch</h4>

<pre class="language-python"><code class="language-python">from langchain_core.runnables import RunnableBranch,RunnableLambda

def add_int_one(a):
    try:
        return a+1
    except Exception as e:
        print(&quot;Error:&quot;,e)
def add_str_one(a):
    try:
        return chr(ord(a)+1)
    except Exception as e:
        print(&quot;Error:&quot;,e)

runnable=RunnableBranch(
    (lambda x:type(x)==str,RunnableLambda(add_str_one)),
    (lambda x:type(x)==int,RunnableLambda(add_int_one)),
    lambda x:x,
)
print(runnable.invoke('a'))
print(runnable.invoke(1))
</code></pre>
<h3 id="%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B1%BB%E5%9E%8B">è¾“å…¥è¾“å‡ºç±»å‹</h3>
<p><img src="https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502201358867.png" alt="image-20250220135854967" /></p>
<blockquote>
<p>æ‰€æœ‰çš„è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯å…¬å¼€çš„æ‰€ä»¥å¯ä»¥ä½¿ç”¨Pydanticæ¨¡å‹è¿›è¡Œæ£€æŸ¥, input_schema, output_schema</p>
</blockquote>
<h3 id="stream">stream</h3>
<p>æ‰€æœ‰çš„runableå¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨streamå’Œastreamçš„æ–¹æ³•, ä»¥æµå¼çš„æ–¹æ³•è¿›è¡Œè¾“å‡ºä»¥åŠå¤„ç†è¾“å…¥æµ</p>

<pre class="language-python"><code class="language-python">from langchain_openai import ChatOpenAI
model = ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;)
chunks = []
for chunk in model.stream(&quot;ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;):
    chunks.append(chunk)
    print(chunk.content, end=&quot;|&quot;, flush=True)

&quot;&quot;&quot;
|ä½ |å¥½|ï¼Œ|æˆ‘|æ˜¯|ä¸€ä¸ª|è¯­|è¨€|æ¨¡|å‹|äºº|å·¥|æ™º|èƒ½|åŠ©|æ‰‹|ï¼Œ|å¯ä»¥|å›|ç­”|å„|ç§|é—®é¢˜|ã€|æ|ä¾›|ä¿¡æ¯|å’Œ|å¸®|åŠ©|è§£|å†³|é—®é¢˜|ã€‚|æˆ‘|æ²¡æœ‰|å…·|ä½“|çš„|ä¸ª|äºº|èº«|ä»½|å’Œ|ç»|å†|ï¼Œ|ä½†|æˆ‘|è¢«|è®¾è®¡|æˆ|å¯ä»¥|å’Œ|ç”¨æˆ·|è¿›è¡Œ|è‡ª|ç„¶|ã€|å¯Œ|æœ‰|æ„|ä¹‰|çš„|å¯¹|è¯|ã€‚|å¸Œ|æœ›|æˆ‘|èƒ½|å¤Ÿ|å¸®|åŠ©|åˆ°|ä½ |ï¼|æœ‰|ä»€|ä¹ˆ|é—®é¢˜|å¯ä»¥|é—®|æˆ‘çš„|å—|ï¼Ÿ||
&quot;&quot;&quot;
</code></pre>
<p>è¿”å›çš„æ•°æ®æ˜¯å¾ˆä¸ªAIMessageChunk</p>

<pre class="language-python"><code class="language-python">chunks[0]
&quot;&quot;&quot;
AIMessageChunk(content='', additional_kwargs={}, response_metadata={}, id='run-7f89c698-1a31-403a-96b8-105b4d3bc9ea')
&quot;&quot;&quot;
</code></pre>
<p>å®é™…æ˜¯æŠŠLLMçš„äº‹ä»¶æŠ¥æ–‡è¿›è¡Œè½¬æ¢, è¿™ä¸€ä¸ªæ•°æ®ç±»å‹å¯ä»¥ä½¿ç”¨<code>+</code>è¿›è¡Œè¿æ¥</p>

<pre class="language-python"><code class="language-python">chunks[0] + chunks[1] + chunks[2]
&quot;&quot;&quot;
AIMessageChunk(content='ä½ å¥½', additional_kwargs={}, response_metadata={}, id='run-7f89c698-1a31-403a-96b8-105b4d3bc9ea')
&quot;&quot;&quot;
</code></pre>
<h3 id="LCEL%E8%AF%AD%E8%A8%80">LCELè¯­è¨€</h3>
<p>LangChainçš„è¡¨è¾¾å¼è¯­è¨€, å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­è¨€æŠŠåŸºæœ¬çš„å—è¿›è¡Œç»„åˆ, å¯ä»¥è‡ªåŠ¨çš„å®ç°streamå’Œastreamçš„è§†çº¿, å®ç°å¯¹æœ€ç»ˆç»“æœçš„æµå¼ä¼ è¾“</p>

<pre class="language-python"><code class="language-python">import asyncio
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
prompt = ChatPromptTemplate.from_template(&quot;ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹, ç»™æˆ‘ä¸€ä¸ªæœ‰å…³{input}çš„ç¬‘è¯&quot;)
parser = StrOutputParser()  # æŠŠè¾“å‡ºçš„å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²
chain = prompt | model | parser
async for chunk in chain.astream({&quot;input&quot;:&quot;çŒ«&quot;}):
    print(chunk, end=&quot;|&quot;, flush=True)
&quot;&quot;&quot;
|ä¸º|ä»€|ä¹ˆ|çŒ«|æ— |æ³•|å‚|åŠ |æ¯”|èµ›|ï¼Ÿ|å› |ä¸º|ä»–|ä»¬|æ€»|æ˜¯|åœ¨|æŠ“|è€³|æŒ |è…®|ï¼|å“ˆ|å“ˆ|å“ˆ|ï¼||
&quot;&quot;&quot;
</code></pre>

<pre class="language-python"><code class="language-python">import asyncio
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import JsonOutputParser

model = ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;)
parser = JsonOutputParser()
chain = model | parser
async def async_stream():
    async for text in chain.astream(&quot;ä»¥jsonçš„æ ¼å¼è¾“å‡ºè‹±å›½, ä¸­å›½, æ—¥æœ¬çš„äººå£åˆ—è¡¨&quot;
                                    &quot;ä½¿ç”¨ä¸€ä¸ªæœ‰countryå­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºå›½å®¶, ä¸€ä¸ªæœ‰population&quot;
                                    &quot;å­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºäººå£&quot;
                                    ):
        print(text)


asyncio.run(async_stream())

&quot;&quot;&quot;
{}
{'countries': []}
{'countries': [{}]}
{'countries': [{'country': ''}]}
{'countries': [{'country': 'è‹±'}]}
{'countries': [{'country': 'è‹±å›½'}]}
{'countries': [{'country': 'è‹±å›½', 'population': ''}]}
{'countries': [{'country': 'è‹±å›½', 'population': '660'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '660400'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': ''}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': ''}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '143'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '143932'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '143932377'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': ''}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥æœ¬'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥æœ¬', 'population': ''}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥æœ¬', 'population': '125'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥æœ¬', 'population': '125360'}]}
{'countries': [{'country': 'è‹±å›½', 'population': '66040000'}, {'country': 'ä¸­å›½', 'population': '1439323776'}, {'country': 'æ—¥æœ¬', 'population': '125360000'}]}
&quot;&quot;&quot;
</code></pre>
<h3 id="Stream-events%28%E4%BA%8B%E4%BB%B6%E6%B5%81%29">Stream events(äº‹ä»¶æµ)</h3>
<table>
<thead>
<tr>
  <th>event</th>
  <th>name</th>
  <th>chunk</th>
  <th>input</th>
  <th>output</th>
</tr>
</thead>
<tbody>
<tr>
  <td>on_chat_model_start</td>
  <td>[model name]</td>
  <td></td>
  <td>{&quot;messages&quot;: [[SystemMessage, HumanMessage]]}</td>
  <td></td>
</tr>
<tr>
  <td>on_chat_model_stream</td>
  <td>[model name]</td>
  <td>AIMessageChunk(content=&quot;hello&quot;)</td>
  <td></td>
  <td></td>
</tr>
<tr>
  <td>on_chat_model_end</td>
  <td>[model name]</td>
  <td></td>
  <td>{&quot;messages&quot;: [[SystemMessage, HumanMessage]]}</td>
  <td>AIMessageChunk(content=&quot;hello world&quot;)</td>
</tr>
<tr>
  <td>on_llm_start</td>
  <td>[model name]</td>
  <td></td>
  <td>{'input': 'hello'}</td>
  <td></td>
</tr>
<tr>
  <td>on_llm_stream</td>
  <td>[model name]</td>
  <td>'Hello'</td>
  <td></td>
  <td></td>
</tr>
<tr>
  <td>on_llm_end</td>
  <td>[model name]</td>
  <td></td>
  <td>'Hello human!'</td>
  <td></td>
</tr>
<tr>
  <td>on_chain_start</td>
  <td>format_docs</td>
  <td></td>
  <td></td>
  <td></td>
</tr>
<tr>
  <td>on_chain_stream</td>
  <td>format_docs</td>
  <td>&quot;hello world!, goodbye world!&quot;</td>
  <td></td>
  <td></td>
</tr>
<tr>
  <td>on_chain_end</td>
  <td>format_docs</td>
  <td></td>
  <td>[Document(...)]</td>
  <td>&quot;hello world!, goodbye world!&quot;</td>
</tr>
<tr>
  <td>on_tool_start</td>
  <td>some_tool</td>
  <td></td>
  <td>{&quot;x&quot;: 1, &quot;y&quot;: &quot;2&quot;}</td>
  <td></td>
</tr>
<tr>
  <td>on_tool_end</td>
  <td>some_tool</td>
  <td></td>
  <td></td>
  <td>{&quot;x&quot;: 1, &quot;y&quot;: &quot;2&quot;}</td>
</tr>
<tr>
  <td>on_retriever_start</td>
  <td>[retriever name]</td>
  <td></td>
  <td>{&quot;query&quot;: &quot;hello&quot;}</td>
  <td></td>
</tr>
<tr>
  <td>on_retriever_end</td>
  <td>[retriever name]</td>
  <td></td>
  <td>{&quot;query&quot;: &quot;hello&quot;}</td>
  <td>[Document(...), ..]</td>
</tr>
<tr>
  <td>on_prompt_start</td>
  <td>[template_name]</td>
  <td></td>
  <td>{&quot;question&quot;: &quot;hello&quot;}</td>
  <td></td>
</tr>
<tr>
  <td>on_prompt_end</td>
  <td>[template_name]</td>
  <td></td>
  <td>{&quot;question&quot;: &quot;hello&quot;}</td>
  <td>ChatPromptValue(messages: [SystemMessage, ...])</td>
</tr>
</tbody>
</table>

<pre class="language-python"><code class="language-python">async def async_stream():
    events = []
    async for event in model.astream_events(&quot;ä»¥jsonçš„æ ¼å¼è¾“å‡ºè‹±å›½, ä¸­å›½, æ—¥æœ¬çš„äººå£åˆ—è¡¨&quot;
                                            &quot;ä½¿ç”¨ä¸€ä¸ªæœ‰countryå­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºå›½å®¶,&quot;
                                            &quot;ä¸€ä¸ªæœ‰populationå­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºäººå£&quot;, 
                                            version=&quot;v2&quot;):
        events.append(event)
    print(events)

asyncio.run(async_stream())
&quot;&quot;&quot;
[{
'event': 'on_chat_model_start', 
'data': 
    {
        'input': 'ä»¥jsonçš„æ ¼å¼è¾“å‡ºè‹± å›½, ä¸­å›½, æ—¥æœ¬çš„äººå£åˆ—è¡¨ä½¿ç”¨ä¸€ä¸ªæœ‰countryå­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºå›½å®¶,ä¸€ä¸ªæœ‰populationå­—æ®µçš„jsonæ ¼å¼æ¥è¡¨ç¤ºäººå£'}, 
        'name': 'ChatOpenAI', 
        'tags': [], 
        'run_id': '4b4bb3fb-d9ef-489e-8168-59e25185ade3', 
        'metadata': {
            'ls_provider': 'openai', 
            'ls_model_name': 'gpt-3.5-turbo-1106', 
            'ls_model_type': 'chat', 
            'ls_temperature': None
        }, 
        'parent_ids': []
    }, 
{
    'event': 'on_chat_model_stream', 
    'run_id': '4b4bb3fb-d9ef-489e-8168-59e25185ade3', 
    'name': 'ChatOpenAI', 
    'tags': [], 
    'metadata': {
        'ls_provider': 'openai', 
        'ls_model_name': 'gpt-3.5-turbo-1106', 
        'ls_model_type': 'chat', 
        'ls_temperature': None
    }, 
    'data': {
    	'chunk': AIMessageChunk(content='', 
    	additional_kwargs={}, 
    	response_metadata={}, 
    	id='run-4b4bb3fb-d9ef-489e-8168-59e25185ade3')
    }, 
    'parent_ids': []
}, 
....
&quot;&quot;&quot;
</code></pre>
<h3 id="%E5%BC%82%E6%AD%A5%E6%89%A7%E8%A1%8C">å¼‚æ­¥æ‰§è¡Œ</h3>

<pre class="language-python"><code class="language-python">async def task1():
    model = ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;)
    chunks = []
    async for chunk in model.astream(&quot;ä»‹ç»ä¸€ä¸‹è¶Šå—&quot;):
        chunks.append(chunk)
        print(chunk.content, end=&quot;|&quot;, flush=True)


async def task2():
    model = ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;)
    chunks = []
    async for chunk in model.astream(&quot;ä»‹ç»ä¸€ä¸‹è€æŒ&quot;):
        chunks.append(chunk)
        print(chunk.content, end=&quot;|&quot;, flush=True)


async def main():
    await asyncio.gather(task1(), task2())

asyncio.run(main())
&quot;&quot;&quot;
|è¶Š|å—|ï¼Œ|å…¨|å|ä¸º||è€|æŒ|ï¼Œ|å…¨|è¶Š|ç§°|ä¸º|å—|ç¤¾|è€|æŒ|äºº|æ°‘|æ°‘|ä¸»|å…±|å’Œ| å›½|ä¼š|ä¸»|ä¹‰|å…±|å’Œ|å›½|ï¼Œ|æ˜¯|ä¸œ|å—|äºš|çš„|ä¸€ä¸ª|ï¼Œ|æ˜¯|ä¸œ|å—|å›½|äºš|çš„|å®¶|ï¼Œ| ä¸œ|ä¸€ä¸ª|å†…|é™†|å›½|ä¸´|å®¶|å—|ï¼Œ|ä¸­å›½|ä½|æµ·|ï¼Œ|äº|ä¸­å›½|ã€|è¶Š|å—|ä¸|å—|è€|æŒ|ã€|å’Œ|æ³°|æŸ¬|åŸ”|å›½|å¯¨|ã€|ç›¸|é‚»|ç¼…|ç”¸|ï¼Œ|è¥¿|ä¸|å’Œ|æŸ¬|åŸ”|æŸ¬|å¯¨|ä¹‹|åŸ”|é—´|å¯¨|å’Œ|ã€‚|æ³°|è€|æŒ|å›½|çš„|æ¥|é¦–|éƒ½|å£¤|å’Œ|ï¼Œ|æœ€|åŒ—|å¤§|ç•Œ|åŸ|ä¸|å¸‚|ä¸­å›½|æ˜¯|äº¤| ç•Œ|ä¸‡|ã€‚|è¶Š|è±¡|ã€‚

|å—|è€|æ˜¯|æŒ|æ˜¯|ä¸€ä¸ª|ä¸€ä¸ª|å¤š|å±±|åœ°|æ‹¥|æœ‰|å½¢|çš„|æ‚ |å›½|ä¹…|å®¶|ï¼Œ|å†|æ‹¥|å²| æœ‰|å’Œ|ä¸°|ä¸°|å¯Œ|å¯Œ|çš„|è‡ª|ç„¶|æ–‡|èµ„æº|ï¼Œ|åŒ…|æ‹¬|æ°´|åŒ–|é—|äº§|çš„|å›½|åŠ›|å®¶|èµ„æº|ï¼Œ|ã€|è‡ª|æ£®|æ—|å¤|ä»¥|æ¥|å°±|èµ„æº|æ˜¯|å’Œ|ä¸€ä¸ª|çŸ¿|é‡|è¦|äº§|çš„|èµ„æº|æ–‡|ã€‚|åŒ–|å†œ|å’Œ|ä¸š|æ˜¯|å•†|è€|ä¸š|æŒ|æ¢|ç»|çº½|ã€‚

|æµ|è¶Š|å—|çš„|çš„|æ”¯|æŸ±|ï¼Œ|é¦–|éƒ½|ä¸»|æ˜¯|æ²³|å†…|è¦|ç§|ï¼Œ|æ¤|ç¨»|æ˜¯|ç±³|ã€|ä¸€ä¸ª|ç‰|å†|ç±³|ã€|å²|æ‚ |å’–|å•¡|ä¹…|ä¸”|å’Œ|æ©¡|å……|æ»¡|èƒ¶|æ´»|ç­‰|ä½œ|åŠ›|ç‰©|çš„|ã€‚

|è€|åŸ|æŒ|å¸‚|æ˜¯|ã€‚|è¶Š|ä¸€ä¸ª|ä¸–|ä¿—|å—|å›½|ä»¥|å…¶|å®¶|ï¼Œ|ç¾|ä¿¡|ä¸½|ä»°|çš„|è‡ª|ç„¶|é£|å…‰|ã€|æ‚ |ä¹…|çš„|å†|å²|å’Œ|æ–‡|åŒ–|ã€|ä¸°|å¯Œ|çš„|ç¾|é£Ÿ|å’Œ|ç‹¬|ç‰¹|çš„|æ°‘|ä¿—|é£|æƒ…|è€Œ|é—»|å|äº|ä¸–|ã€‚|è¥¿|å±±|ç¾¤|å³°|ã€|ä¸‹|é¾™|æ¹¾|ã€|æ²³|å†…|è€|åŸ|ã€|å²˜|æ¸¯|ã€|èƒ¡|å¿—|æ˜|å¸‚|ç­‰|åœ°|éƒ½|æ˜¯|è¶Š|å—|è‘—|å|çš„|æ—…|æ¸¸|èƒœ|åœ°|ã€‚

|è¶Š|å—|çš„|ç»|æµ|ä¸»|è¦|ä»¥|å†œ|ä¸š|ã€|å·¥|ä¸š|å’Œ|æœåŠ¡|ä¸š|ä¸º|ä¸»|ï¼Œ|å…¶ä¸­|å†œ|ä¸š| æ˜¯|å›½|æ°‘|ç»|æµ|çš„|é‡|è¦|æ”¯|æŸ±|ã€‚|è¶Š|å—|æ˜¯|ä¸–|ç•Œ|ä¸Š|æœ€|å¤§|çš„|ç¨»|ç±³|å‡º|å£|å›½|ä¸Š|ä»¥|ä¹‹|ä¸€|ï¼Œ|ä½›|åŒæ—¶|æ•™|ä¹Ÿ|ä¸º|æœ‰|ä¸°|ä¸»|å¯Œ|ï¼Œ|çš„|å¤©|ç„¶|ä½›|æ•™|èµ„æº|ï¼Œ|åŒ…|æ‹¬|æ–‡|åŒ–|åœ¨|è€|æŒ|å¾—|çŸ³|åˆ°|æ²¹|äº†|ã€|å¹¿|å¤©|æ³›|ç„¶|ä¼ |æ’­|æ°”|å’Œ|å’Œ|å‘|ç¨€|å±•|åœŸ|ã€‚|è€|ç­‰|ã€‚|æŒ|è¿‘|çš„|æ–‡|åŒ–|å’Œ|å¹´|ä¼ |æ¥|ç»Ÿ|ï¼Œ|è¶Š|ä¹Ÿ|å—|çš„|å—|åˆ°|ä½›|ç»|æµ|æ•™|çš„|å¾—|å½±|åˆ°|å“|äº†|ï¼Œ|äºº|ä»¬|å¿«|é€Ÿ|å°Š|é‡|å‘|å±•|é•¿|è¾ˆ|ï¼Œ|ï¼Œ|å¸|å¼•|äº†|æ³¨|å¤§|é‡|ç¤¼|é‡|ä»ª|å’Œ|å¤–|å›½|ä¼ |ç»Ÿ|æŠ•|èŠ‚|èµ„|æ—¥|ã€‚

|è¶Š|ã€‚

|è€|å—|äºº|æŒ|æ°‘|çƒ­|çš„|æ—…|æƒ…|æ¸¸|ä¸š|å¥½|å‘|å±•|å®¢|è¿…|ï¼Œ|é€Ÿ|å–œ|ï¼Œ|æ¬¢|å¸|éŸ³|å¼•|äº†|ä¹|è¶Š|ã€|èˆ|è¹ˆ|æ¥|è¶Š|å¤š|çš„|å›½|å†…|å’Œ|å¤–|ç¾|é£Ÿ|æ¸¸|å®¢|ã€‚|ã€‚|è¶Š|è‘—|å|çš„|æ—…|å—|èœ|æ¸¸|æ™¯|ä»¥|ç‚¹|æ±¤|æ–™|åŒ…|ä¸º|æ‹¬|ä¸»|ç…|å‹ƒ|ï¼Œ|æ‹‰|é‚¦|å£|ã€|å‘³|ä¸‡|æ¸…|è£|ã€|æ·¡|æ°¸|ï¼Œ|ä½†|ç|ã€|å¹³|åˆ|ä¸|å£¤|ä¹|å’Œ|ç‹¬|ç‰¹|çš„|å—|èµ›|æ¾|æ²¹|å‘³|ã€‚

|è€|é“|æŒ|ï¼Œ|äºº|è¢«|èª‰|æ°‘|å‹|ä¸º|å¥½|çƒ­|ä¸–|ç•Œ|æƒ…|ï¼Œ|ç”Ÿ|ä¸Š|æœ€|ç¾|æ´»|å‘³|èŠ‚|å¥|çš„|ç¾|é£Ÿ|ä¹‹|æ‚ |ä¸€|é—²|ã€‚|ï¼Œ|è¢«|èª‰|ä¸º|åœ¨|è¶Š|å—|ï¼Œ|â€œ|ä¸œ|æ–¹|äºº|ä¹‹|å›½|ä»¬|â€ã€‚|å¦‚æœ|ä½ |è¿˜|æƒ³|ä½“|ä¿|éªŒ|ç•™|ä¸|ç€|è®¸|å¤š|ä¸€|æ ·|çš„|ä¸œ|ä¼ |å—|äºš|ç»Ÿ|é£|çš„|æƒ…|èŠ‚|ï¼Œ|è€|æ—¥|æŒ|æ˜¯|å’Œ|ä¸€ä¸ª|å¾ˆ|ä¹ |å¥½|çš„|é€‰æ‹©|ã€‚||ä¿—|ï¼Œ|å¦‚|æ³¼|æ°´|èŠ‚|ã€|ä¸­| ç§‹|èŠ‚|ã€|ç«|æŠŠ|èŠ‚|ç­‰|ï¼Œ|è¿™|äº›|èŠ‚|æ—¥|éƒ½|ä½“|ç°|äº†|è¶Š|å—|äºº|æ°‘|çš„|å‹¤|åŠ³|å’Œ|çƒ­|æƒ…|ã€‚

|æ€»|çš„|æ¥|è¯´|ï¼Œ|è¶Š|å—|æ˜¯|ä¸€ä¸ª|æ‹¥|æœ‰|ä¸°|å¯Œ|æ–‡|åŒ–|å’Œ|é£|åœŸ|äºº|æƒ…|çš„|å›½|å®¶|ï¼Œ|æ˜¯|ä¸€ä¸ª|å€¼|å¾—|ä¸€|æ¸¸|çš„|æ—…|æ¸¸|èƒœ|åœ°|ï¼Œ|ä¹Ÿ|æ˜¯|ä¸€ä¸ª|æ­£åœ¨|è“¬|å‹ƒ|å‘|å±•|çš„|ç»|æµ|ä½“|ã€‚||
&quot;&quot;&quot;
</code></pre>
<h2 id="%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2">æœåŠ¡éƒ¨ç½²</h2>
<p><a href="https://python.langchain.com/docs/langserve/"  target="_blank">ğŸ¦œï¸ğŸ“ æœ—æ–¯ |ğŸ¦œï¸ğŸ”— LangChain è¯­è¨€é“¾ --- ğŸ¦œï¸ğŸ“ LangServe | ğŸ¦œï¸ğŸ”— LangChain</a></p>
<p>LangServerå¯ä»¥æŠŠLangServeréƒ¨ç½²ä¸ºä¸€ä¸ªAPIçš„å½¢å¼, é›†æˆFastAPI, ä½¿ç”¨Pydanticè¿›è¡ŒéªŒè¯, åºåˆ—åŒ–, ç”Ÿæˆjsonæ¶æ„ä»¥åŠè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ç­‰, æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯</p>
<ul>
<li>å®‰è£…</li>
</ul>

<pre class="language-bash"><code class="language-bash">pip install --upgrade &quot;langserve[all]&quot;
# ä¹Ÿå¯ä»¥åˆ†å¼€
pip install --upgrade &quot;langserve[server]&quot;
pip install --upgrade &quot;langserve[client]&quot;
</code></pre>
<ul>
<li>CLIå·¥å…·å¿«é€Ÿåˆ›å»ºå·¥ç¨‹</li>
</ul>

<pre class="language-bash"><code class="language-bash">pip install -U langchain-cli
</code></pre>
<p>ä¹‹åå¯ä»¥ä½¿ç”¨å‘½ä»¤<code>langchain app new é¡¹ç›®åå­—</code></p>
<p><img src="https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502201725775.png" alt="image-20250220172546614" /></p>
<p>ä¹‹ååœ¨add_routesé‡Œé¢å®šä¹‰å¯ä»¥è¿è¡Œçš„å¯¹è±¡, åœ¨server.pyé‡Œé¢ç¼–è¾‘</p>
<ul>
<li>ä½¿ç”¨poetryæ·»åŠ ç¬¬ä¸‰æ–¹çš„åŒ…(langchain-openaiç­‰)</li>
</ul>

<pre class="language-python"><code class="language-python">pip install pipx
pipx install poetry
poetry add langchain
poetry add langchain-openai
</code></pre>
<h3 id="%E7%89%B9%E6%80%A7">ç‰¹æ€§</h3>
<ul>
<li>APIè°ƒç”¨çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆé”™è¯¯çš„ä¿¡æ¯</li>
<li>ä¸€ä¸ªå¸¦æœ‰JSONchemaå’ŒSwaggerçš„APIæ–‡æ¡£é¡µé¢, æ’å…¥ç¤ºä¾‹é“¾æ¥</li>
<li>é«˜æ•ˆçš„<code>/stream</code>, <code>/invoke</code>, <code>/batch</code>ç«¯ç‚¹, å•æœåŠ¡å™¨å¤šä¸ªå¹¶å‘è¯·æ±‚</li>
<li><code>/stream_log</code>ç«¯ç‚¹, ç”¨äºæµå¼ä¼ è¾“ä»£ç†çš„æ‰€æœ‰ä¸­é—´æ­¥éª¤</li>
<li><code>/stream_events</code>é«˜ç‰ˆæœ¬çš„æ—¶å€™ä½¿ç”¨æµå¼ä¼ è¾“</li>
<li>å®¢æˆ·ç«¯çš„SDKè°ƒç”¨çš„å®é™…æ•ˆæœå’Œæœ¬åœ°å¯è¿è¡Œå¯¹è±¡ä¸€æ ·condaconda</li>
</ul>
<h3 id="%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8">å®é™…ä½¿ç”¨</h3>
<p>æœåŠ¡å™¨ç«¯</p>

<pre class="language-python"><code class="language-python">from fastapi import FastAPI
from fastapi.responses import RedirectResponse
from langserve import add_routes
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser

# å»ºç«‹ä¸€ä¸ªFastAPIåº”ç”¨
app = FastAPI(
    title=&quot;LangChain æœåŠ¡å™¨&quot;,
    description=&quot;è¿™æ˜¯ä¸€ä¸ªåŸºäºFastAPIçš„LangChainæœåŠ¡å™¨&quot;,
    version=&quot;0.1.0&quot;,
)

# å°†æ ¹è·¯å¾„é‡å®šå‘åˆ°/docs
@app.get(&quot;/&quot;)
async def redirect_root_to_docs():
    return RedirectResponse(&quot;/docs&quot;)

# åœ¨è¿™é‡Œæ·»åŠ LangChainçš„è·¯ç”±
add_routes(app, 
           ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;)| StrOutputParser(),
           path=&quot;/openai&quot;)

if __name__ == &quot;__main__&quot;:
    import uvicorn

    uvicorn.run(app, host=&quot;0.0.0.0&quot;, port=8000)
</code></pre>
<p>å¯ä»¥ä½¿ç”¨<code>poetry run langchain serve --port=8000</code>æ‰“å¼€æœåŠ¡</p>
<p>å®¢æˆ·ç«¯ä½¿ç”¨, langchainæ¨¡å¼</p>

<pre class="language-python"><code class="language-python">from langchain.schema.runnable import RunnableMap
from langchain_core.prompts import ChatPromptTemplate
from langserve import RemoteRunnable

openai = RemoteRunnable(&quot;http://127.0.0.1:8000/openai&quot;)
prompt = ChatPromptTemplate.from_messages(
    [(&quot;system&quot;,  &quot;ä½ æ˜¯ä¸€ä¸ªçŒ«å¨˜&quot;), (&quot;user&quot;, &quot;{input}&quot;)]
)

chain = prompt | RunnableMap({
    &quot;openai&quot;: openai
}) # ç”¨äºå°†è¾“å…¥æ˜ å°„åˆ°ä¸åŒçš„Runnableä¸Š, å¯ä»¥ä½¿ç”¨chainè¿›è¡Œè¿œç¨‹è°ƒç”¨

print(&quot;åŒæ­¥è°ƒç”¨/openai/invoke&quot;)
response = chain.invoke({&quot;input&quot;: &quot;ä½ æ˜¯è°&quot;})
print(response)
&quot;&quot;&quot;
{'openai': 'å—¯ï¼Œæˆ‘æ˜¯ä¸€åªçŒ«å¨˜ï¼Œå¯ä»¥é™ªä½ èŠå¤©å’Œå›ç­”é—®é¢˜å“¦ã€‚æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ'}
&quot;&quot;&quot;
</code></pre>
<p>å®¢æˆ·ç«¯ä½¿ç”¨requestsæ¨¡å¼</p>

<pre class="language-python"><code class="language-python">import requests
import json

respond = requests.post(
    url=&quot;http://127.0.0.1:8000/openai/invoke&quot;,
    json={
        &quot;input&quot;: &quot;ä½ æ˜¯è°&quot;
    }
)
print(respond.json())
&quot;&quot;&quot;
{'output': 'æˆ‘æ˜¯ä¸€ä¸ªç”¨äººå·¥æ™ºèƒ½æŠ€æœ¯è®¾è®¡çš„è™šæ‹ŸåŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”ä½ çš„é—®é¢˜å¹¶ä¸ä½ è¿›è¡Œå¯¹è¯ã€‚æˆ‘ä¸æ˜¯ä¸€ä¸ªå…·æœ‰å®ä½“å½¢æ€çš„äººæˆ–ç”Ÿç‰©ï¼Œè€Œæ˜¯ä¸€ä¸ªç¨‹åºåœ¨è®¡ç®—æœºä¸­è¿è¡Œçš„è™šæ‹Ÿå®ä½“ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿ', 'metadata': {'run_id': '8955a316-8620-4082-ae73-7a68cfe91290', 'feedback_tokens': []}}
&quot;&quot;&quot;
</code></pre>
<p>å¦‚æœæ„å»ºçš„æ—¶å€™ä½¿ç”¨å‚æ•°</p>

<pre class="language-python"><code class="language-python">prompt = ChatPromptTemplate.from_template(
    &quot;ä½ æ˜¯ä¸€ä¸ªçŒ«å¨˜, ç”¨æˆ·å‘æ¥{message}, è¯·ä½ å›ç­”&quot;
) # ç”¨äºç”Ÿæˆä¸€ä¸ªèŠå¤©æ¨¡æ¿, å®é™…è°ƒç”¨çš„æ—¶å€™ä¼šå°†ç”¨æˆ·çš„è¾“å…¥å¡«å…¥{message}ä¸­
add_routes(app,
            prompt | ChatOpenAI(model=&quot;gpt-3.5-turbo-1106&quot;) | StrOutputParser(),
            path=&quot;/catgirl&quot;)
</code></pre>
<p>è®¿é—®çš„æ—¶å€™ä¹Ÿéœ€è¦è¿™ä¸ªå‚æ•°</p>

<pre class="language-python"><code class="language-python">print(&quot;åŒæ­¥è°ƒç”¨/catgirl/invoke&quot;)
response = chain.invoke({&quot;input&quot;: {&quot;message&quot;: &quot;ä½ æ˜¯è°&quot;}})
print(response)
</code></pre>

<pre class="language-python"><code class="language-python">respond = requests.post(
    url=&quot;http://127.0.0.1:8000/catgirl/invoke&quot;,
    json={
        &quot;input&quot;: {&quot;message&quot;: &quot;ä½ æ˜¯è°&quot;}
    }
)
print(respond.json())
</code></pre>
<ul>
<li>ä½¿ç”¨æµå¼è°ƒç”¨</li>
</ul>

<pre class="language-python"><code class="language-python">print(&quot;å¼‚æ­¥è°ƒç”¨/openai/stream&quot;)
for chunk in chain.stream({&quot;input&quot;: &quot;ä½ æ˜¯è°&quot;}):
    print(chunk, end=&quot;&quot;, flush=True)

print(&quot;å¼‚æ­¥è°ƒç”¨/catgirl/stream&quot;)
for chunk in chain.stream({&quot;input&quot;: {&quot;message&quot;: &quot;ä½ æ˜¯è°&quot;}}):
    print(chunk, end=&quot;&quot;, flush=True)
&quot;&quot;&quot;
å¼‚æ­¥è°ƒç”¨/openai/stream
{'openai': ''}{'openai': 'æˆ‘'}{'openai': 'æ˜¯'}{'openai': 'ä¸€ä¸ª'}{'openai': 'AI'}{'openai': 'åŠ©'}{'openai': 'æ‰‹'}{'openai': 'ï¼Œ'}{'openai': 'å¯ä»¥'}{'openai': 'å›'}{'openai': 'ç­”'}{'openai': 'ä½ '}{'openai': 'çš„'}{'openai': 'é—®é¢˜'}{'openai': 'å’Œ'}{'openai': 'ä¸'}{'openai': 'ä½ '}{'openai': 'èŠ'}{'openai': 'å¤©'}{'openai': 'ã€‚'}{'openai': 'ä½ '}{'openai': 'å¯ä»¥'}{'openai': 'å«'}{'openai': 'æˆ‘'}{'openai': 'çŒ«'}{'openai': 'å¨˜'}{'openai': 'å“¦'}{'openai': '~'}{'openai': 'æœ‰'}{'openai': 'ä»€'}{'openai': 'ä¹ˆ'}{'openai': 'é—®é¢˜'}{'openai': 'æƒ³'}{'openai': 'é—®'}{'openai': 'æˆ‘'}{'openai': 'å—'}{'openai': 'ï¼Ÿ'}{'openai': ''}
å¼‚æ­¥è°ƒç”¨/catgirl/stream
{'openai': ''}{'openai': 'å—¨'}{'openai': 'ï¼'}{'openai': 'æˆ‘'}{'openai': 'æ˜¯'}{'openai': 'ä¸€'}{'openai': 'åª'}{'openai': 'çŒ«'}{'openai': 'å¨˜'}{'openai': 'ï¼Œ'}{'openai': 'å¾ˆ'}{'openai': 'é«˜'}{'openai': 'å…´'}{'openai': 'è®¤'}{'openai': 'è¯†'}{'openai': 'ä½ '}{'openai': 'ï¼'}{'openai': 'æœ‰'}{'openai': 'ä»€'}{'openai': 'ä¹ˆ'}{'openai': 'é—®é¢˜'}{'openai': 'æƒ³'}{'openai': 'è¦'}{'openai': 'é—®'}{'openai': 'æˆ‘'}{'openai': 'å—'}{'openai': 'ï¼Ÿ'}{'openai': 'ğŸ±'}{'openai': ''}
&quot;&quot;&quot;
</code></pre>

<pre class="language-python"><code class="language-python">respond = requests.post(
    url=&quot;http://127.0.0.1:8000/openai/stream&quot;,
    json={
        &quot;input&quot;: &quot;ä½ æ˜¯è°&quot;
    }
)
for line in respond.iter_lines():
    print(line.decode(&quot;utf-8&quot;))
&quot;&quot;&quot;
event: metadata
data: {&quot;run_id&quot;: &quot;82b92785-d68a-4485-8ba1-634a35b22cba&quot;}

event: data
data: &quot;&quot;

event: data
data: &quot;æˆ‘&quot;

...

event: data
data: &quot;&quot;

event: end
&quot;&quot;&quot;
</code></pre>
<h2 id="%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7">æœåŠ¡ç›‘æ§</h2>
<p>å¯ä»¥ä½¿ç”¨LangSmith,</p>
<p>ä½¿ç”¨è¿™ä¸ªéœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡</p>

<pre class="language-bash"><code class="language-bash">setx LANGCHAIN_TRACING_V2 &quot;True&quot;
setx LANGCHAIN_API_KEY &quot;...&quot;
setx TAVILY_API_KEY	&quot;...&quot;
</code></pre>
<p>è¿˜å¯ä»¥ä½¿ç”¨verboseè¯¦ç»†æ‰“å°æ—¥å¿—</p>

<pre class="language-python"><code class="language-python">from langchain.globals import set_verbose
set_verbose(True)
</code></pre>
<h2 id="%E8%81%8A%E5%A4%A9%E7%AE%A1%E7%90%86">èŠå¤©ç®¡ç†</h2>
<h3 id="%E5%86%85%E5%AD%98">å†…å­˜</h3>
<p>å¯ä»¥é€šè¿‡å­—å…¸å®ç°</p>

<pre class="language-python"><code class="language-python">from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.chat_history import BaseChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory

prompt = ChatPromptTemplate.from_messages(
    [
        (&quot;system&quot;, &quot;You are a assistant helping a user with their homework. The user asks you to help them with their math homework.&quot;),
        MessagesPlaceholder(variable_name=&quot;history&quot;),# å†å²æ¶ˆæ¯å ä½ç¬¦
        (&quot;human&quot;, &quot;{input}&quot;),
    ]
)

model = ChatOpenAI(model = &quot;gpt-3.5-turbo-1106&quot;)
runable = prompt | model

store = {}

def get_chat_message_history(session_id: str) -&gt; BaseChatMessageHistory:
    if session_id not in store:
        store[session_id] = ChatMessageHistory()
    return store[session_id]

# é€šè¿‡RunnableWithMessageHistoryåŒ…è£…runableï¼Œä½¿å…¶èƒ½å¤Ÿè·å–å†å²æ¶ˆæ¯
with_message_history = RunnableWithMessageHistory(
    runable, 
    get_chat_message_history,
    input_messages_key=&quot;input&quot;,
    history_messages_key=&quot;history&quot;,
)
# RunnableWithMessageHistory must always be called with a config that contains
# the appropriate parameters for the chat message history factory.
response = with_message_history.invoke(
    input={
        &quot;input&quot;: &quot;ä»‹ç»ä¸€ä¸‹çº¿æ€§ä»£æ•°.&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;session_id&quot;: &quot;session_1&quot;}
    }
)

print(response)

response = with_message_history.invoke(
    input={
        &quot;input&quot;: &quot;å†è¯¦ç»†ä¸€ç‚¹.&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;session_id&quot;: &quot;session_1&quot;}
    }
)
print(response)
</code></pre>
<ul>
<li>å¦‚æœä½¿ç”¨æ›´å¤šçš„æŸ¥æ‰¾å‚æ•°, éœ€è¦è‡ªå®šä¹‰</li>
</ul>

<pre class="language-python"><code class="language-python">from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.chat_history import BaseChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory

from langchain_core.runnables import ConfigurableFieldSpec

prompt = ChatPromptTemplate.from_messages(
    [
        (&quot;system&quot;, &quot;You are a assistant helping a user with their homework. The user asks you to help them with their math homework.&quot;),
        MessagesPlaceholder(variable_name=&quot;history&quot;),# å†å²æ¶ˆæ¯å ä½ç¬¦
        (&quot;human&quot;, &quot;{input}&quot;),
    ]
)

model = ChatOpenAI(model = &quot;gpt-3.5-turbo-1106&quot;)
runable = prompt | model
# è®°å½•ä½¿ç”¨çš„å­—å…¸
store = {}

# ä½¿ç”¨ç”¨æˆ·IDå’Œå¯¹è¯IDä½œä¸ºé”®
def get_chat_message_history(user_id: str, conversation_id: str) -&gt; BaseChatMessageHistory:
    if (user_id, conversation_id) not in store:
        store[(user_id, conversation_id)] = ChatMessageHistory()
    return store[(user_id, conversation_id)]

# é€šè¿‡RunnableWithMessageHistoryåŒ…è£…runableï¼Œä½¿å…¶èƒ½å¤Ÿè·å–å†å²æ¶ˆæ¯
with_message_history = RunnableWithMessageHistory(
    runable, 
    get_chat_message_history,
    input_messages_key=&quot;input&quot;,
    history_messages_key=&quot;history&quot;,
    # é»˜è®¤åªç”¨ä¸€ä¸ªsession_id, è¿™é‡Œä½¿ç”¨user_idå’Œconversation_idä½œä¸ºé”®
    history_factory_config=[
        ConfigurableFieldSpec(
            id=&quot;user_id&quot;,
            annotation=str, # æ³¨è§£
            name=&quot;User ID&quot;,
            description=&quot;ç”¨æˆ·æ ‡è¯†.&quot;,
            is_shared=True,
            default=&quot;&quot;,
        ),
        ConfigurableFieldSpec(
            id=&quot;conversation_id&quot;,
            annotation=str, # æ³¨è§£
            name=&quot;Conversation ID&quot;,
            description=&quot;å¯¹è¯æ ‡è¯†.&quot;,
            is_shared=True, # å…±äº«, ç”¨äºåŒºåˆ†ä¸åŒç”¨æˆ·çš„å¯¹è¯
            default=&quot;&quot;,
        )
    ]
)
response = with_message_history.invoke(
    input={
        &quot;input&quot;: &quot;ä»‹ç»ä¸€ä¸‹çº¿æ€§ä»£æ•°.&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;user_id&quot;: &quot;123&quot;, &quot;conversation_id&quot;: &quot;1&quot;}
    }
)
print(response)

response = with_message_history.invoke(
    input={
        &quot;input&quot;: &quot;å†è¯¦ç»†ä¸€ç‚¹.&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;user_id&quot;: &quot;123&quot;, &quot;conversation_id&quot;: &quot;1&quot;}
    }
)
print(response)
</code></pre>
<h3 id="Redis%E5%AD%98%E5%82%A8">Rediså­˜å‚¨</h3>

<pre class="language-python"><code class="language-python">from langchain_community.chat_message_histories import RedisChatMessageHistory
# å®é™…æ”¹çš„ä½ç½®æ˜¯æŠŠè·å–å†å²è®°å½•çš„æ–¹å¼è¿›è¡Œæ”¹å˜
def get_message_history(session_id: str) -&gt; RedisChatMessageHistory:
    # è¿æ¥åˆ°æœ¬åœ°çš„Redisæ•°æ®åº“, ä½¿ç”¨1å·æ•°æ®åº“, session_idä½œä¸ºé”®
    return RedisChatMessageHistory(session_id, url=REDIS_URL)

REDIS_URL = &quot;redis://localhost:6379/1&quot;
</code></pre>
<p><img src="https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502221637786.png" alt="image-20250222163748007" /></p>
<p><img src="https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502221640666.png" alt="image-20250222164014405" /></p>
<h4 id="%E5%A4%84%E7%90%86%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95">å¤„ç†å†å²è®°å½•</h4>
<p>æ¶ˆæ¯å¦‚æœæ¯”è¾ƒé•¿, ä¼šæ¶ˆè€—token</p>

<pre class="language-python"><code class="language-python">from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_openai import ChatOpenAI
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser


temp_chat_history = ChatMessageHistory()
temp_chat_history.add_user_message(&quot;ä½ å¥½, æˆ‘åˆšæ‰åœ¨æ‰“ç¯®çƒ&quot;)
temp_chat_history.add_ai_message(&quot;ä½ å¥½&quot;)
temp_chat_history.add_user_message(&quot;ä½ å¥½, æˆ‘å«å°æ˜&quot;)
temp_chat_history.add_ai_message(&quot;ä½ å¥½&quot;)
temp_chat_history.add_user_message(&quot;å†è§&quot;)
temp_chat_history.add_ai_message(&quot;å†è§&quot;)
# print(temp_chat_history.messages) # æ¶ˆæ¯åˆ—è¡¨


prompt = ChatPromptTemplate.from_messages(
    [
        (&quot;system&quot;, &quot;You are a assistant helping a user&quot;),
        MessagesPlaceholder(variable_name=&quot;history&quot;),# å†å²æ¶ˆæ¯å ä½ç¬¦
        (&quot;human&quot;, &quot;{input}&quot;),
    ]
)

model = ChatOpenAI(model = &quot;gpt-3.5-turbo-1106&quot;)
runable = prompt | model


# æŠŠè¿å¤©è®°å½•é™åˆ¶åœ¨3æ¡æ¶ˆæ¯ä»¥å†…
def trim_message(chat_input):
    stored_messages = temp_chat_history.messages
    if len(stored_messages) &lt;= 4:
        return False
    temp_chat_history.clear()
    for message in stored_messages[-4:]:
        temp_chat_history.add_message(message)
    return True



with_message_history = RunnableWithMessageHistory(
    runable, 
    lambda session_id: temp_chat_history,
    input_messages_key=&quot;input&quot;,
    history_messages_key=&quot;history&quot;,
)

chain_with_trim = (
    # ä½¿ç”¨trim_messageå‡½æ•°å¯¹è¾“å…¥æ¶ˆæ¯è¿›è¡Œå¤„ç†
    # trim_messageä¼ å…¥çš„å‚æ•°å®é™…æ˜¯è¾“å…¥æ¶ˆæ¯
    RunnablePassthrough.assign(messages_trimmed=trim_message) 
    | with_message_history
    | StrOutputParser()
)

response = chain_with_trim.invoke(
    input={
        &quot;input&quot;: &quot;æˆ‘çš„åå­—æ˜¯å•¥?&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;session_id&quot;: &quot;session_1&quot;}
    }
)
print(response)

response = chain_with_trim.invoke(
    input={
        &quot;input&quot;: &quot;æˆ‘åˆšæ‰åœ¨å¹²å•¥?&quot;
    },
    config={
        &quot;configurable&quot;: {&quot;session_id&quot;: &quot;session_1&quot;}
    }
)
print(response)
&quot;&quot;&quot;
ä½ è¯´ä½ å«å°æ˜
ä½ åˆšæ‰åœ¨å’Œæˆ‘å¯¹è¯
&quot;&quot;&quot;
</code></pre>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-16-dify.html">
                            <span class="icon"></span>
                            <span class="label">2025-2-16-dify</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/note/æœºå™¨å­¦ä¹ /å®é™…åº”ç”¨/2025-2-23-langchain2.html">
                            <span class="label">2025-2-23-langchain2</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>é“¾æ¥</a><ul><li><a target="_blank" href="https://teedoc.neucrack.com">ç½‘ç«™ä½¿ç”¨ teedoc ç”Ÿæˆ</a></li>
<li><a target="_blank" href="https://neucrack.com">Copyright Â© 2021 Neucrack</a></li>
<li><a  href="/note/sitemap.xml">ç½‘ç«™åœ°å›¾</a></li>
</ul>
</li>
<li><a>æºç </a><ul><li><a target="_blank" href="https://github.com/XuSenfeng/note/">github</a></li>
<li><a target="_blank" href="https://github.com/teedoc/teedoc">æœ¬ç½‘ç«™æºæ–‡ä»¶</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://beian.miit.gov.cn">æ¸ICPå¤‡19015320å·</a></li>
<li><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030602004109">ç²¤å…¬ç½‘å®‰å¤‡44030602004109å·</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/note/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script type="text/javascript">
                var transLoaded = false;
                var loading = false;
                var domain = "translate.google.com";
                var domainDefault = domain;
                var storeDomain = localStorage.getItem("googleTransDomain");
                if(storeDomain){
                    domain = storeDomain;
                    console.log("load google translate domain from local storage:" + domain);
                }
                function getUrl(domain){
                    if(domain == "/")
                        return "/static/js/google_translate/element.js?cb=googleTranslateElementInit";
                    else
                        return "https://" + domain + "/translate_a/element.js?cb=googleTranslateElementInit";
                }
                var url = getUrl(domain);
                console.log("google translate domain:" + domain + ", url: " + url);
                function googleTranslateElementInit() {
                    new google.translate.TranslateElement({pageLanguage: "auto", layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
                }
                function loadJS( url, callback ){
                    var script = document.createElement('script');
                    fn = callback || function(){ };
                    script.type = 'text/javascript';
                    if(script.readyState){
                        script.onreadystatechange = function(){
                            if( script.readyState == 'loaded' || script.readyState == 'complete' ){
                                script.onreadystatechange = null;
                                fn();
                            }
                        };
                    }else{
                        script.onload = function(){
                            fn();
                        };
                    }
                    script.src = url;
                    document.getElementsByTagName('head')[0].appendChild(script);
                }
                function removeHint(){
                    var hint = document.getElementById("loadingTranslate");
                    if(hint){
                        hint.remove();
                    }
                }
                var btn = document.getElementById("google_translate_element");
                btn.onclick = function(){
                    if(transLoaded) return;
                    if(loading){
                        var flag = confirm("loading from " + domain + ", please wait, or change domain?");
                        if(flag){
                            newDomain = prompt("domain, default: " + domainDefault + ", now: " + domain);
                            if(newDomain){
                                domain = newDomain;
                                console.log(domain);
                                url = getUrl(domain);
                                loadJS(url, function(){
                                    localStorage.setItem("googleTransDomain", domain);
                                    removeHint()
                                    transLoaded = true;
                                });
                            }
                        }
                        return;
                    }
                    btn.innerHTML = '<span id="loadingTranslate"><img class="icon" src="/note/static/image/google_translate/translate.svg"/>Loading ...</span>';
                    loading = true;
                    loadJS(url, function(){
                        localStorage.setItem("googleTransDomain", domain);
                        removeHint()
                        transLoaded = true;
                    });
                }
                </script>
            
    
        <script src="/note/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/note/static/js/theme_default/main.js"></script>
    
        <script src="/note/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/note/static/css/theme_default/prism.min.js"></script>
    
        <script src="/note/static/js/search/search_main.js"></script>
    
        <script src="/note/static/js/plugin_blog/main.js"></script>
    
        <link rel="stylesheet" href="/note/static/js/add_hint/style.css" type="text/css"/>
    
        <script src="/note/static/js/add_hint/main.js"></script>
    
        <script src="/note/static/js/gitalk/gitalk.min.js"></script>
    
        <script src="/note/static/js/gitalk/main.js"></script>
    
        <script src="/note/static/js/custom.js"></script>
    
</body>

</html>