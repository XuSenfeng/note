# 驱动移植

## 模块自动加载

```bash
sudo cp my_module.ko /lib/modules/$(uname -r)/
```

在`/etc/modules`文件里面添加对应的模块

![image-20251202115330145](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251202115330145.png)

## 编译RTL8188EUS wifi模块

### 编译内核

在模块编译的时候需要使用Linux的内核, 需要编译好了, 可以直接下载野火的SDK包进行编译

>   [编译手册](https://doc.embedfire.com/linux/rk356x/build_and_deploy/zh/latest/building_image/lubancat_sdk/lubancat_gen_sdk.html), [烧录](https://doc.embedfire.com/linux/rk3588/quick_start/zh/latest/quick_start/flash_img/flash_img.html), [连接wifi](https://doc.embedfire.com/linux/rk3588/quick_start/zh/latest/quick_start/wireless/wifi/wifi.html)
>
>   我使用的是完全编译, 编译以后把update.img烧录到开发板里面

#### 问题解决

大部分的编译问题野火的脚modu本会给出解决方案, 仔细看报错就行了

编译的时候由于我自己安装的是zsh, 所以在识别bash的时候用的是zsh, 使用命令./build.sh的时候出现报错

```bash
Change root.....................
chroot: failed to run command '/usr/bin/zsh': No such file or directory
ERROR: Running /home/jiao/yh-linux/rk3588/device/rockchip/common/scripts/mk-rootfs.sh - build_debian failed!
ERROR: exit code 127 from line 219:
    RELEASE=$RK_DEBIAN_VERSION TARGET=$RK_ROOTFS_TARGET VERSION=$RK_ROOTFS_DEBUG RK_ROOTFS_IMAGE=$RK_ROOTFS_IMAGE SOC=$RK_CHIP ARCH=$ARCH ./mk-rootfs.sh
ERROR: call stack:
    mk-rootfs.sh: build_debian(219)
    mk-rootfs.sh: build_hook(399)
    mk-rootfs.sh: main(456)
ERROR: Running /home/jiao/yh-linux/rk3588/device/rockchip/common/build-hooks/99-all.sh - build_all failed!
ERROR: exit code 127 from line 21:
    "$RK_SCRIPTS_DIR/mk-rootfs.sh"
ERROR: call stack:
    99-all.sh: build_all(21)
    99-all.sh: build_hook(182)
    build-helper: try_func(63)
    build-helper: try_hook(96)
    build-helper: source(165)
    99-all.sh: main(193)
ERROR: Running /home/jiao/yh-linux/rk3588/device/rockchip/common/build-hooks/99-all.sh - try_func build_hook all failed!
ERROR: exit code 127 from line 67:
    build_hook
ERROR: call stack:
    build-helper: try_func(67)
    build-helper: try_hook(96)
    build-helper: source(165)
    99-all.sh: main(193)
```

解决以上的问题可以在脚本里面指定使用`/bin/bash`

![image-20251202114705905](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251202114705905.png)

>   你的代码目录/debian11/mk-bullseye-rootfs.sh

### 编译模块

我使用的是https://github.com/lwfinger/rtl8188eu这个模块, 下载以后编译即可

```bash
make all  ARCH=arm64 CROSS_COMPILE=~/yh-linux/rk3588/prebuilts/gcc/linux-x86/aarch64/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-rockchip1031-linux-gnu- KSRC=$KDIR
```

这里的KDIR是一个全局变量, 我设置为我的SDK Kernel的目录, 实际使用的编译器的路径也需要根据你自己的SDK目录改变, 我的野火的编译文件放在`~/yh-linux/rk3588/`目录下面, KDIR设置为`~/yh-linux/rk3588/kernel-5.10`

