# V5基本使用

https://docs.ultralytics.com/yolov5/

## 检测

### 默认dectect

使用`python dectect.py`文件即可使用示例, 可以添加一些自定义的参数

#### 关键参数

```python
--weights (str | list[str], optional): Model path or Triton URL. Defaults to ROOT / 'yolov5s.pt'.
--source (str, optional): File/dir/URL/glob/screen/0(webcam). Defaults to ROOT / 'data/images'.
--data (str, optional): Dataset YAML path. Provides dataset configuration information.
--imgsz (list[int], optional): Inference size (height, width). Defaults to [640].
--conf-thres (float, optional): Confidence threshold. Defaults to 0.25.
--iou-thres (float, optional): NMS IoU threshold. Defaults to 0.45.
--max-det (int, optional): Maximum number of detections per image. Defaults to 1000.
--device (str, optional): CUDA device, i.e., '0' or '0,1,2,3' or 'cpu'. Defaults to "".
--view-img (bool, optional): Flag to display results. Defaults to False.
--save-txt (bool, optional): Flag to save results to *.txt files. Defaults to False.
--save-csv (bool, optional): Flag to save results in CSV format. Defaults to False.
--save-conf (bool, optional): Flag to save confidences in labels saved via --save-txt. Defaults to False.
--save-crop (bool, optional): Flag to save cropped prediction boxes. Defaults to False.
--nosave (bool, optional): Flag to prevent saving images/videos. Defaults to False.
--classes (list[int], optional): List of classes to filter results by, e.g., '--classes 0 2 3'. Defaults to
    None.
--agnostic-nms (bool, optional): Flag for class-agnostic NMS. Defaults to False.
--augment (bool, optional): Flag for augmented inference. Defaults to False.
--visualize (bool, optional): Flag for visualizing features. Defaults to False.
--update (bool, optional): Flag to update all models in the model directory. Defaults to False.
--project (str, optional): Directory to save results. Defaults to ROOT / 'runs/detect'.
--name (str, optional): Sub-directory name for saving results within --project. Defaults to 'exp'.
--exist-ok (bool, optional): Flag to allow overwriting if the project/name already exists. Defaults to False.
--line-thickness (int, optional): Thickness (in pixels) of bounding boxes. Defaults to 3.
--hide-labels (bool, optional): Flag to hide labels in the output. Defaults to False.
--hide-conf (bool, optional): Flag to hide confidences in the output. Defaults to False.
--half (bool, optional): Flag to use FP16 half-precision inference. Defaults to False.
--dnn (bool, optional): Flag to use OpenCV DNN for ONNX inference. Defaults to False.
--vid-stride (int, optional): Video frame-rate stride, determining the number of frames to skip in between
    consecutive frames. Defaults to 1.
```

##### Weights训练好的模型

| Model                                                        | Size (pixels) | mAPval 50-95  | mAPval 50     | Speed CPU b1 (ms) | Speed V100 b1 (ms) | Speed V100 b32 (ms) | Params (M) | FLOPs @640 (B) |
| ------------------------------------------------------------ | ------------- | ------------- | ------------- | ----------------- | ------------------ | ------------------- | ---------- | -------------- |
| [YOLOv5n](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5n.pt) | 640           | 28.0          | 45.7          | **45**            | **6.3**            | **0.6**             | **1.9**    | **4.5**        |
| [YOLOv5s](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5s.pt) | 640           | 37.4          | 56.8          | 98                | 6.4                | 0.9                 | 7.2        | 16.5           |
| [YOLOv5m](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5m.pt) | 640           | 45.4          | 64.1          | 224               | 8.2                | 1.7                 | 21.2       | 49.0           |
| [YOLOv5l](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5l.pt) | 640           | 49.0          | 67.3          | 430               | 10.1               | 2.7                 | 46.5       | 109.1          |
| [YOLOv5x](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5x.pt) | 640           | 50.7          | 68.9          | 766               | 12.1               | 4.8                 | 86.7       | 205.7          |
|                                                              |               |               |               |                   |                    |                     |            |                |
| [YOLOv5n6](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5n6.pt) | 1280          | 36.0          | 54.4          | 153               | 8.1                | 2.1                 | 3.2        | 4.6            |
| [YOLOv5s6](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5s6.pt) | 1280          | 44.8          | 63.7          | 385               | 8.2                | 3.6                 | 12.6       | 16.8           |
| [YOLOv5m6](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5m6.pt) | 1280          | 51.3          | 69.3          | 887               | 11.1               | 6.8                 | 35.7       | 50.0           |
| [YOLOv5l6](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5l6.pt) | 1280          | 53.7          | 71.3          | 1784              | 15.8               | 10.5                | 76.8       | 111.4          |
| [YOLOv5x6](https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5x6.pt) + [[TTA\]](https://docs.ultralytics.com/yolov5/tutorials/test_time_augmentation/) | 1280 1536     | 55.0 **55.8** | 72.7 **72.7** | 3136 -            | 26.2 -             | 19.4 -              | 140.7 -    | 209.8 -        |

##### source

可以指定实际使用的输入文件, 可以是图片, 视频, 摄像头(`0`), 屏幕(`screen`), 可以使用list.txt指定一系列图片

##### conf-thres置信度

选框的置信度的阈值, 小于这个的不显示

##### iou-thres

IoU阈值

### 代码

```python
import torch

# Load a YOLOv5 model (options: yolov5n, yolov5s, yolov5m, yolov5l, yolov5x)
# 路径以及使用的模型, 第三个可以使用github以及local
# 这里加载的模型文件夹下面需要有一个hubconf.py文件
module = torch.hub.load("../yolov5", "yolov5s.py", source="local")  # local repo  # Default: yolov5s
# 可以使用下面的方法自定义路径
# model = torch.hub.load('.', 'custom', 'path/to/model.pt', source='local')  # local repo

# Define the input image source (URL, local file, PIL image, OpenCV frame, numpy array, or list)
img = "../yolov5/data/images/bus.jpg"   # Example image

# Perform inference (handles batching, resizing, normalization automatically)
results = model(img)

# Process the results (options: .print(), .show(), .save(), .crop(), .pandas())
results.print()  # Print results to console
results.show()  # Display results in a window
results.save()  # Save results to runs/detect/exp
```

torch.hub.load

实际返回的类型是`class Detections:`, 一般比较常用的属性

```python
self.pred = pred  # list of tensors pred[0] = (xyxy, conf, cls)
self.xyxy = pred  # xyxy pixels
self.xywh = [xyxy2xywh(x) for x in pred]  # xywh pixels
self.xyxyn = [x / g for x, g in zip(self.xyxy, gn)]  # xyxy normalized
self.xywhn = [x / g for x, g in zip(self.xywh, gn)]  # xywh normalized
```

可以使用`result.show()`显示图片

使用`results.crop(save=False)[3]['im'][:,:,::-1]`获取第四个结果的图片

```python
from PIL import Image
results.crop(save=False)[3]['im'][:,:,::-1]
Image.fromarray(results.crop(save=False)[3]['im'][:,:,::-1])
```



## 数据集

同样可以使用的labelimg

使用同样的文件格式

+   images: 存放使用的图片
+   +   train: 训练集的图片
    +   val: 验证集的图片
+   labels: 标签
+   +   train: 训练集的标签, 和训练集的图片一一对应
    +   val: 验证集的标签

默认的配置文件放在`yolov5/data`位置

```yaml
# Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]
path: ./datasets/bvn # dataset root dir
train: images/train # train images (relative to 'path') 128 images
val: images/val # val images (relative to 'path') 128 images
test: # test images (optional)

# Classes
names:
  0: man
  1: girl
  2: car
```

## 训练

可以使用`--data`参数指定使用的配置文件 ,使用train.py进行训练

输出的位置在`yolov5/runs/train/exp`, 可以使用`tensorboard --logdir runs`查看训练指标的变化

```bash
python ./detect.py --weights runs/train/exp/weights/best.pt --source ./calling20221009.mp4 --view-img
```

