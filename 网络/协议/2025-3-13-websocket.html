<!DOCTYPE html>

<html lang="zh-CN"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <meta name="html-generator" content="teedoc-plugin-jupyter-notebook-parser">
        
        <script src="/note/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/note/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/note/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/search/style.css" type="text/css"/>
        
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4d52982572d5512e9762879ebf063c86";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
        
        <meta name="blog-generator" content="teedoc-plugin-blog">
        
        <link rel="stylesheet" href="/note/static/css/gitalk/gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/gitalk/custom_gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/custom.css" type="text/css"/>
        
    
    
    <title>WebSocket - XvSenfeng's Note</title>
    
    <script type="text/javascript">js_vars = {"teedoc-plugin-ad-hint": {"type": "hint", "label": "â˜†", "content": "è¿™æ˜¯ä¸€ä¸ªæ”¯æŒå›½é™…åŒ–çš„æ¶ˆæ¯ç¤ºä¾‹</br>å–œæ¬¢é¡¹ç›®è¯·<a target=\"_blank\" href=\"https://github.com/teedoc/teedoc\">ç‚¹ä¸‹ â˜† star </a>å“¦~ğŸ¦€ğŸ¦€", "show_times": 2, "show_after_s": 432000, "date": "2021-11-16 14:40", "color": "#a0421d", "link_color": "#e53935", "link_bg_color": "#e6ae5c", "bg_color": "#ffcf89", "color_hover": "white", "bg_color_hover": "#f57c00", "close_color": "#eab971"}}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/note/">
                
                    <img class="site_logo" src="/note/static/image/logo.png" alt="XvSenfeng logo">
                
                
                    <h2>XvSenfeng</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/note/blog/">åšå®¢</a></li>
<li class=""><a  href="/note/Linux/">Linux</a></li>
<li class=""><a  href="/note/ä»£ç åˆ†æ/">ä»£ç åˆ†æ</a></li>
<li class=""><a  href="/note/ä½¿ç”¨è½¯ä»¶/">ä½¿ç”¨è½¯ä»¶</a></li>
<li class=""><a  href="/note/åµŒå…¥å¼/">åµŒå…¥å¼</a></li>
<li class=""><a  href="/note/æ‰‹æœºå®‰å“/">æ‰‹æœºå®‰å“</a></li>
<li class=""><a  href="/note/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a></li>
<li class=""><a  href="/note/ç¼–ç¨‹åŸºç¡€/">ç¼–ç¨‹åŸºç¡€</a></li>
<li class="active"><a  href="/note/ç½‘ç»œ/">ç½‘ç»œ</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/XuSenfeng/note/">github</a></li>
</ul>

                <ul class="nav_plugins"><li><a id="google_translate_element"><img class="icon" src="/note/static/image/google_translate/translate.svg"/>Translate</a></li></ul><ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">æœç´¢</span>
                            <div id="search_hints">
                                <span id="search_input_hint">è¾“å…¥å…³é”®è¯ï¼Œå¤šå…³é”®è¯ç©ºæ ¼éš”å¼€</span>
                                <span id="search_loading_hint">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™ã€‚ã€‚ã€‚</span>
                                <span id="search_download_err_hint">ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ</span>
                                <span id="search_other_docs_result_hint">æ¥è‡ªå…¶å®ƒæ–‡æ¡£çš„ç»“æœ</span>
                                <span id="search_curr_doc_result_hint">å½“å‰æ–‡æ¡£æœç´¢ç»“æœ</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/note/ç½‘ç»œ/index.html"><span class="label">README</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">åè®®</span><span class="sub_indicator"></span></a><ul class="show">
<li class="active with_link"><a href="/note/ç½‘ç»œ/åè®®/2025-3-13-websocket.html"><span class="label">2025-3-13-websocket</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">çˆ¬è™«</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/ç½‘ç»œ/çˆ¬è™«/2022-10-2-ç¯å¢ƒæ­å»º.html"><span class="label">2022-10-2-ç¯å¢ƒæ­å»º</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/ç½‘ç»œ/çˆ¬è™«/2022-9-20-pythonç›¸å…³çŸ¥è¯†.html"><span class="label">2022-9-20-pythonç›¸å…³çŸ¥è¯†</span><span class=""></span></a></li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>WebSocket</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="æœ€åä¿®æ”¹æ—¥æœŸï¼š 2025-12-14">
                                    2025-12-14
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/XuSenfeng/note/tree/master/doc/ç½‘ç»œ/åè®®/2025-3-13-websocket.md" target="_blank">
                                    ç¼–è¾‘æœ¬é¡µ
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <p>ä¼ ç»Ÿçš„HTTPåè®®æ˜¯ä¸€ä¸ªå•å‘çš„é€šä¿¡, ç”¨äºå®æ—¶åè®®, å¼€å§‹çš„æ—¶å€™ä½¿ç”¨HTTP, ä½†æ˜¯åç»­ä¿æŒTCPè¿æ¥, è¯·æ±‚çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯wsæˆ–è€…wss(å¯¹åº”http/https)</p>

<pre class="language-none"><code class="language-none">GET / HTTP/1.1
Host: localhost:8080
Origin: http://127.0.0.1:3000
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: w4v7O6xFTi36lq3RNcgctw==
</code></pre>
<p>åªå¯ä»¥ä½¿ç”¨GETè¯·æ±‚</p>
<ul>
<li><code>Connection: Upgrade</code>ï¼šè¡¨ç¤ºè¦å‡çº§åè®®</li>
<li><code>Upgrade: websocket</code>ï¼šè¡¨ç¤ºè¦å‡çº§åˆ°websocketåè®®ã€‚</li>
<li><code>Sec-WebSocket-Version: 13</code>ï¼šè¡¨ç¤ºwebsocketçš„ç‰ˆæœ¬ã€‚å¦‚æœæœåŠ¡ç«¯ä¸æ”¯æŒè¯¥ç‰ˆæœ¬ï¼Œéœ€è¦è¿”å›ä¸€ä¸ª<code>Sec-WebSocket-Version</code>headerï¼Œé‡Œé¢åŒ…å«æœåŠ¡ç«¯æ”¯æŒçš„ç‰ˆæœ¬å·ã€‚</li>
<li><code>Sec-WebSocket-Key</code>ï¼šä¸åé¢æœåŠ¡ç«¯å“åº”é¦–éƒ¨çš„<code>Sec-WebSocket-Accept</code>æ˜¯é…å¥—çš„ï¼Œæä¾›åŸºæœ¬çš„é˜²æŠ¤ï¼Œæ¯”å¦‚æ¶æ„çš„è¿æ¥ï¼Œæˆ–è€…æ— æ„çš„è¿æ¥ã€‚</li>
</ul>
<p>æœåŠ¡ç«¯å“åº”</p>

<pre class="language-none"><code class="language-none">HTTP/1.1 101 Switching Protocols
Connection:Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: Oy4NRAQ13jhfONC7bP8dTKb4PTU=
</code></pre>
<p>101æ˜¯åˆ‡æ¢åè®®</p>
<blockquote>
<p>å¤‡æ³¨ï¼šæ¯ä¸ªheaderéƒ½ä»¥<code>\r\n</code>ç»“å°¾ï¼Œå¹¶ä¸”æœ€åä¸€è¡ŒåŠ ä¸Šä¸€ä¸ªé¢å¤–çš„ç©ºè¡Œ<code>\r\n</code>ã€‚æ­¤å¤–ï¼ŒæœåŠ¡ç«¯å›åº”çš„HTTPçŠ¶æ€ç åªèƒ½åœ¨æ¡æ‰‹é˜¶æ®µä½¿ç”¨ã€‚è¿‡äº†æ¡æ‰‹é˜¶æ®µåï¼Œå°±åªèƒ½é‡‡ç”¨ç‰¹å®šçš„é”™è¯¯ç ã€‚</p>
</blockquote>
<p><code>Sec-WebSocket-Accept</code>æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚é¦–éƒ¨çš„<code>Sec-WebSocket-Key</code>è®¡ç®—å‡ºæ¥ã€‚</p>
<p>è®¡ç®—å…¬å¼ä¸ºï¼š</p>
<ol>
<li>å°†<code>Sec-WebSocket-Key</code>è·Ÿ<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>æ‹¼æ¥ã€‚</li>
<li>é€šè¿‡SHA1è®¡ç®—å‡ºæ‘˜è¦ï¼Œå¹¶è½¬æˆbase64å­—ç¬¦ä¸²ã€‚</li>
</ol>
<h2 id="%E6%95%B0%E6%8D%AE%E5%B8%A7%E6%A0%BC%E5%BC%8F">æ•°æ®å¸§æ ¼å¼</h2>
<ol>
<li>ä»å·¦åˆ°å³ï¼Œå•ä½æ˜¯æ¯”ç‰¹ã€‚æ¯”å¦‚<code>FIN</code>ã€<code>RSV1</code>å„å æ®1æ¯”ç‰¹ï¼Œ<code>opcode</code>å æ®4æ¯”ç‰¹ã€‚</li>
<li>å†…å®¹åŒ…æ‹¬äº†æ ‡è¯†ã€æ“ä½œä»£ç ã€æ©ç ã€æ•°æ®ã€æ•°æ®é•¿åº¦ç­‰ã€‚ï¼ˆä¸‹ä¸€å°èŠ‚ä¼šå±•å¼€ï¼‰</li>
</ol>

<pre class="language-none"><code class="language-none">  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
</code></pre>
<p><strong>FIN</strong>ï¼š1ä¸ªæ¯”ç‰¹ã€‚</p>
<p>å¦‚æœæ˜¯1ï¼Œè¡¨ç¤ºè¿™æ˜¯æ¶ˆæ¯ï¼ˆmessageï¼‰çš„æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼ˆfragmentï¼‰ï¼Œå¦‚æœæ˜¯0ï¼Œè¡¨ç¤ºä¸æ˜¯æ˜¯æ¶ˆæ¯ï¼ˆmessageï¼‰çš„æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼ˆfragmentï¼‰ã€‚</p>
<p><strong>RSV1, RSV2, RSV3</strong>ï¼šå„å 1ä¸ªæ¯”ç‰¹ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹å…¨ä¸º0ã€‚å½“å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯åå•†é‡‡ç”¨WebSocketæ‰©å±•æ—¶ï¼Œè¿™ä¸‰ä¸ªæ ‡å¿—ä½å¯ä»¥é0ï¼Œä¸”å€¼çš„å«ä¹‰ç”±æ‰©å±•è¿›è¡Œå®šä¹‰ã€‚å¦‚æœå‡ºç°éé›¶çš„å€¼ï¼Œä¸”å¹¶æ²¡æœ‰é‡‡ç”¨WebSocketæ‰©å±•ï¼Œè¿æ¥å‡ºé”™ã€‚</p>
<p><strong>Opcode</strong>: 4ä¸ªæ¯”ç‰¹ã€‚</p>
<p>æ“ä½œä»£ç ï¼ŒOpcodeçš„å€¼å†³å®šäº†åº”è¯¥å¦‚ä½•è§£æåç»­çš„æ•°æ®è½½è·ï¼ˆdata payloadï¼‰ã€‚å¦‚æœæ“ä½œä»£ç æ˜¯ä¸è®¤è¯†çš„ï¼Œé‚£ä¹ˆæ¥æ”¶ç«¯åº”è¯¥æ–­å¼€è¿æ¥ï¼ˆfail the connectionï¼‰ã€‚å¯é€‰çš„æ“ä½œä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>%x0ï¼šè¡¨ç¤ºä¸€ä¸ªå»¶ç»­å¸§ã€‚å½“Opcodeä¸º0æ—¶ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®ä¼ è¾“é‡‡ç”¨äº†æ•°æ®åˆ†ç‰‡ï¼Œå½“å‰æ”¶åˆ°çš„æ•°æ®å¸§ä¸ºå…¶ä¸­ä¸€ä¸ªæ•°æ®åˆ†ç‰‡ã€‚</li>
<li>%x1ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å¸§ï¼ˆframeï¼‰</li>
<li>%x2ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¸§ï¼ˆframeï¼‰</li>
<li>%x3-7ï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„éæ§åˆ¶å¸§ã€‚</li>
<li>%x8ï¼šè¡¨ç¤ºè¿æ¥æ–­å¼€ã€‚</li>
<li>%x9ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªpingæ“ä½œã€‚</li>
<li>%xAï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªpongæ“ä½œã€‚</li>
<li>%xB-Fï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„æ§åˆ¶å¸§ã€‚</li>
</ul>
<p><strong>Mask</strong>: 1ä¸ªæ¯”ç‰¹ã€‚</p>
<p>è¡¨ç¤ºæ˜¯å¦è¦å¯¹æ•°æ®è½½è·è¿›è¡Œæ©ç æ“ä½œã€‚ä»å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®æ—¶ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ©ç æ“ä½œï¼›ä»æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ•°æ®æ—¶ï¼Œä¸éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ©ç æ“ä½œã€‚</p>
<p>å¦‚æœæœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ•°æ®æ²¡æœ‰è¿›è¡Œè¿‡æ©ç æ“ä½œï¼ŒæœåŠ¡ç«¯éœ€è¦æ–­å¼€è¿æ¥ã€‚</p>
<p>å¦‚æœMaskæ˜¯1ï¼Œé‚£ä¹ˆåœ¨Masking-keyä¸­ä¼šå®šä¹‰ä¸€ä¸ªæ©ç é”®ï¼ˆmasking keyï¼‰ï¼Œå¹¶ç”¨è¿™ä¸ªæ©ç é”®æ¥å¯¹æ•°æ®è½½è·è¿›è¡Œåæ©ç ã€‚æ‰€æœ‰å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡ç«¯çš„æ•°æ®å¸§ï¼ŒMaskéƒ½æ˜¯1ã€‚</p>
<p><strong>Payload length</strong>ï¼šæ•°æ®è½½è·çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚ä¸º7ä½ï¼Œæˆ–7+16ä½ï¼Œæˆ–1+64ä½ã€‚</p>
<p>å‡è®¾æ•°Payload length === xï¼Œå¦‚æœ</p>
<ul>
<li>xä¸º0~126ï¼šæ•°æ®çš„é•¿åº¦ä¸ºxå­—èŠ‚ã€‚</li>
<li>xä¸º126ï¼šåç»­2ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ª16ä½çš„æ— ç¬¦å·æ•´æ•°ï¼Œè¯¥æ— ç¬¦å·æ•´æ•°çš„å€¼ä¸ºæ•°æ®çš„é•¿åº¦ã€‚</li>
<li>xä¸º127ï¼šåç»­8ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ª64ä½çš„æ— ç¬¦å·æ•´æ•°ï¼ˆæœ€é«˜ä½ä¸º0ï¼‰ï¼Œè¯¥æ— ç¬¦å·æ•´æ•°çš„å€¼ä¸ºæ•°æ®çš„é•¿åº¦ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œå¦‚æœpayload lengthå ç”¨äº†å¤šä¸ªå­—èŠ‚çš„è¯ï¼Œpayload lengthçš„äºŒè¿›åˆ¶è¡¨è¾¾é‡‡ç”¨ç½‘ç»œåºï¼ˆbig endianï¼Œé‡è¦çš„ä½åœ¨å‰ï¼‰ã€‚</p>
<p><strong>Masking-key</strong>ï¼š0æˆ–4å­—èŠ‚ï¼ˆ32ä½ï¼‰</p>
<p>æ‰€æœ‰ä»å®¢æˆ·ç«¯ä¼ é€åˆ°æœåŠ¡ç«¯çš„æ•°æ®å¸§ï¼Œæ•°æ®è½½è·éƒ½è¿›è¡Œäº†æ©ç æ“ä½œï¼ŒMaskä¸º1ï¼Œä¸”æºå¸¦äº†4å­—èŠ‚çš„Masking-keyã€‚å¦‚æœMaskä¸º0ï¼Œåˆ™æ²¡æœ‰Masking-keyã€‚</p>
<p>å¤‡æ³¨ï¼šè½½è·æ•°æ®çš„é•¿åº¦ï¼Œä¸åŒ…æ‹¬mask keyçš„é•¿åº¦ã€‚</p>
<p><strong>Payload data</strong>ï¼š(x+y) å­—èŠ‚</p>
<p>è½½è·æ•°æ®ï¼šåŒ…æ‹¬äº†æ‰©å±•æ•°æ®ã€åº”ç”¨æ•°æ®ã€‚å…¶ä¸­ï¼Œæ‰©å±•æ•°æ®xå­—èŠ‚ï¼Œåº”ç”¨æ•°æ®yå­—èŠ‚ã€‚</p>
<p>æ‰©å±•æ•°æ®ï¼šå¦‚æœæ²¡æœ‰åå•†ä½¿ç”¨æ‰©å±•çš„è¯ï¼Œæ‰©å±•æ•°æ®æ•°æ®ä¸º0å­—èŠ‚ã€‚æ‰€æœ‰çš„æ‰©å±•éƒ½å¿…é¡»å£°æ˜æ‰©å±•æ•°æ®çš„é•¿åº¦ï¼Œæˆ–è€…å¯ä»¥å¦‚ä½•è®¡ç®—å‡ºæ‰©å±•æ•°æ®çš„é•¿åº¦ã€‚æ­¤å¤–ï¼Œæ‰©å±•å¦‚ä½•ä½¿ç”¨å¿…é¡»åœ¨æ¡æ‰‹é˜¶æ®µå°±åå•†å¥½ã€‚å¦‚æœæ‰©å±•æ•°æ®å­˜åœ¨ï¼Œé‚£ä¹ˆè½½è·æ•°æ®é•¿åº¦å¿…é¡»å°†æ‰©å±•æ•°æ®çš„é•¿åº¦åŒ…å«åœ¨å†…ã€‚</p>
<p>åº”ç”¨æ•°æ®ï¼šä»»æ„çš„åº”ç”¨æ•°æ®ï¼Œåœ¨æ‰©å±•æ•°æ®ä¹‹åï¼ˆå¦‚æœå­˜åœ¨æ‰©å±•æ•°æ®ï¼‰ï¼Œå æ®äº†æ•°æ®å¸§å‰©ä½™çš„ä½ç½®ã€‚è½½è·æ•°æ®é•¿åº¦ å‡å» æ‰©å±•æ•°æ®é•¿åº¦ï¼Œå°±å¾—åˆ°åº”ç”¨æ•°æ®çš„é•¿åº¦ã€‚</p>
<h2 id="%E6%8E%A9%E7%A0%81%E8%AE%A1%E7%AE%97">æ©ç è®¡ç®—</h2>
<p>æ©ç é”®ï¼ˆMasking-keyï¼‰æ˜¯ç”±å®¢æˆ·ç«¯æŒ‘é€‰å‡ºæ¥çš„32ä½çš„éšæœºæ•°ã€‚æ©ç æ“ä½œä¸ä¼šå½±å“æ•°æ®è½½è·çš„é•¿åº¦ã€‚æ©ç ã€åæ©ç æ“ä½œéƒ½é‡‡ç”¨å¦‚ä¸‹ç®—æ³•ï¼š</p>
<p>é¦–å…ˆï¼Œå‡è®¾ï¼š</p>
<ul>
<li>original-octet-iï¼šä¸ºåŸå§‹æ•°æ®çš„ç¬¬iå­—èŠ‚ã€‚</li>
<li>transformed-octet-iï¼šä¸ºè½¬æ¢åçš„æ•°æ®çš„ç¬¬iå­—èŠ‚ã€‚</li>
<li>jï¼šä¸º<code>i mod 4</code>çš„ç»“æœã€‚</li>
<li>masking-key-octet-jï¼šä¸ºmask keyç¬¬jå­—èŠ‚ã€‚</li>
</ul>
<p>ç®—æ³•æè¿°ä¸ºï¼š original-octet-i ä¸ masking-key-octet-j å¼‚æˆ–åï¼Œå¾—åˆ° transformed-octet-iã€‚</p>
<h2 id="%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92">æ•°æ®ä¼ é€’</h2>
<p>ä¸€æ—¦WebSocketå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯å»ºç«‹è¿æ¥åï¼Œåç»­çš„æ“ä½œéƒ½æ˜¯åŸºäºæ•°æ®å¸§çš„ä¼ é€’ã€‚</p>
<p>WebSocketæ ¹æ®<code>opcode</code>æ¥åŒºåˆ†æ“ä½œçš„ç±»å‹ã€‚æ¯”å¦‚<code>0x8</code>è¡¨ç¤ºæ–­å¼€è¿æ¥ï¼Œ<code>0x0</code>-<code>0x2</code>è¡¨ç¤ºæ•°æ®äº¤äº’ã€‚</p>
<ol>
<li>æ•°æ®åˆ†ç‰‡</li>
</ol>
<p>WebSocketçš„æ¯æ¡æ¶ˆæ¯å¯èƒ½è¢«åˆ‡åˆ†æˆå¤šä¸ªæ•°æ®å¸§ã€‚å½“WebSocketçš„æ¥æ”¶æ–¹æ”¶åˆ°ä¸€ä¸ªæ•°æ®å¸§æ—¶ï¼Œä¼šæ ¹æ®<code>FIN</code>çš„å€¼æ¥åˆ¤æ–­ï¼Œæ˜¯å¦å·²ç»æ”¶åˆ°æ¶ˆæ¯çš„æœ€åä¸€ä¸ªæ•°æ®å¸§ã€‚</p>
<p>FIN=1è¡¨ç¤ºå½“å‰æ•°æ®å¸§ä¸ºæ¶ˆæ¯çš„æœ€åä¸€ä¸ªæ•°æ®å¸§ï¼Œæ­¤æ—¶æ¥æ”¶æ–¹å·²ç»æ”¶åˆ°å®Œæ•´çš„æ¶ˆæ¯ï¼Œå¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚FIN=0ï¼Œåˆ™æ¥æ”¶æ–¹è¿˜éœ€è¦ç»§ç»­ç›‘å¬æ¥æ”¶å…¶ä½™çš„æ•°æ®å¸§ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>opcode</code>åœ¨æ•°æ®äº¤æ¢çš„åœºæ™¯ä¸‹ï¼Œè¡¨ç¤ºçš„æ˜¯æ•°æ®çš„ç±»å‹ã€‚<code>0x01</code>è¡¨ç¤ºæ–‡æœ¬ï¼Œ<code>0x02</code>è¡¨ç¤ºäºŒè¿›åˆ¶ã€‚è€Œ<code>0x00</code>æ¯”è¾ƒç‰¹æ®Šï¼Œè¡¨ç¤ºå»¶ç»­å¸§ï¼ˆcontinuation frameï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å®Œæ•´æ¶ˆæ¯å¯¹åº”çš„æ•°æ®å¸§è¿˜æ²¡æ¥æ”¶å®Œã€‚</p>
<ol start="2">
<li>æ•°æ®åˆ†ç‰‡ä¾‹å­</li>
</ol>
<p>ç›´æ¥çœ‹ä¾‹å­æ›´å½¢è±¡äº›ã€‚ä¸‹é¢ä¾‹å­æ¥è‡ª<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers"  target="_blank">MDN</a>ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ¼”ç¤ºæ•°æ®çš„åˆ†ç‰‡ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¸¤æ¬¡å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯åå›åº”å®¢æˆ·ç«¯ï¼Œè¿™é‡Œä¸»è¦çœ‹å®¢æˆ·ç«¯å¾€æœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯ã€‚</p>
<p><strong>ç¬¬ä¸€æ¡æ¶ˆæ¯</strong></p>
<p>FIN=1, è¡¨ç¤ºæ˜¯å½“å‰æ¶ˆæ¯çš„æœ€åä¸€ä¸ªæ•°æ®å¸§ã€‚æœåŠ¡ç«¯æ”¶åˆ°å½“å‰æ•°æ®å¸§åï¼Œå¯ä»¥å¤„ç†æ¶ˆæ¯ã€‚opcode=0x1ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å‘é€çš„æ˜¯æ–‡æœ¬ç±»å‹ã€‚</p>
<p><strong>ç¬¬äºŒæ¡æ¶ˆæ¯</strong></p>
<ol>
<li>FIN=0ï¼Œopcode=0x1ï¼Œè¡¨ç¤ºå‘é€çš„æ˜¯æ–‡æœ¬ç±»å‹ï¼Œä¸”æ¶ˆæ¯è¿˜æ²¡å‘é€å®Œæˆï¼Œè¿˜æœ‰åç»­çš„æ•°æ®å¸§ã€‚</li>
<li>FIN=0ï¼Œopcode=0x0ï¼Œè¡¨ç¤ºæ¶ˆæ¯è¿˜æ²¡å‘é€å®Œæˆï¼Œè¿˜æœ‰åç»­çš„æ•°æ®å¸§ï¼Œå½“å‰çš„æ•°æ®å¸§éœ€è¦æ¥åœ¨ä¸Šä¸€æ¡æ•°æ®å¸§ä¹‹åã€‚</li>
<li>FIN=1ï¼Œopcode=0x0ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»å‘é€å®Œæˆï¼Œæ²¡æœ‰åç»­çš„æ•°æ®å¸§ï¼Œå½“å‰çš„æ•°æ®å¸§éœ€è¦æ¥åœ¨ä¸Šä¸€æ¡æ•°æ®å¸§ä¹‹åã€‚æœåŠ¡ç«¯å¯ä»¥å°†å…³è”çš„æ•°æ®å¸§ç»„è£…æˆå®Œæ•´çš„æ¶ˆæ¯ã€‚</li>
</ol>

<pre class="language-vbnet"><code class="language-vbnet">Client: FIN=1, opcode=0x1, msg=&quot;hello&quot;
Server: (process complete message immediately) Hi.
Client: FIN=0, opcode=0x1, msg=&quot;and a&quot;
Server: (listening, new message containing text started)
Client: FIN=0, opcode=0x0, msg=&quot;happy new&quot;
Server: (listening, payload concatenated to previous message)
Client: FIN=1, opcode=0x0, msg=&quot;year!&quot;
Server: (process complete message) Happy new year to you too!
</code></pre>
<h2 id="%E5%BF%83%E8%B7%B3">å¿ƒè·³</h2>
<p>WebSocketä¸ºäº†ä¿æŒå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯çš„å®æ—¶åŒå‘é€šä¿¡ï¼Œéœ€è¦ç¡®ä¿å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ä¹‹é—´çš„TCPé€šé“ä¿æŒè¿æ¥æ²¡æœ‰æ–­å¼€ã€‚ç„¶è€Œï¼Œå¯¹äºé•¿æ—¶é—´æ²¡æœ‰æ•°æ®å¾€æ¥çš„è¿æ¥ï¼Œå¦‚æœä¾æ—§é•¿æ—¶é—´ä¿æŒç€ï¼Œå¯èƒ½ä¼šæµªè´¹åŒ…æ‹¬çš„è¿æ¥èµ„æºã€‚</p>
<p>ä½†ä¸æ’é™¤æœ‰äº›åœºæ™¯ï¼Œå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯è™½ç„¶é•¿æ—¶é—´æ²¡æœ‰æ•°æ®å¾€æ¥ï¼Œä½†ä»éœ€è¦ä¿æŒè¿æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å¿ƒè·³æ¥å®ç°ã€‚</p>
<ul>
<li>å‘é€æ–¹-&gt;æ¥æ”¶æ–¹ï¼šping</li>
<li>æ¥æ”¶æ–¹-&gt;å‘é€æ–¹ï¼špong</li>
</ul>
<p>pingã€pongçš„æ“ä½œï¼Œå¯¹åº”çš„æ˜¯WebSocketçš„ä¸¤ä¸ªæ§åˆ¶å¸§ï¼Œ<code>opcode</code>åˆ†åˆ«æ˜¯<code>0x9</code>ã€<code>0xA</code>ã€‚</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/note/ç½‘ç»œ/index.html">
                            <span class="icon"></span>
                            <span class="label">README</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/note/ç½‘ç»œ/çˆ¬è™«/2022-10-2-ç¯å¢ƒæ­å»º.html">
                            <span class="label">2022-10-2-ç¯å¢ƒæ­å»º</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>é“¾æ¥</a><ul><li><a target="_blank" href="https://teedoc.neucrack.com">ç½‘ç«™ä½¿ç”¨ teedoc ç”Ÿæˆ</a></li>
<li><a target="_blank" href="https://neucrack.com">Copyright Â© 2021 Neucrack</a></li>
<li><a  href="/note/sitemap.xml">ç½‘ç«™åœ°å›¾</a></li>
</ul>
</li>
<li><a>æºç </a><ul><li><a target="_blank" href="https://github.com/XuSenfeng/note/">github</a></li>
<li><a target="_blank" href="https://github.com/teedoc/teedoc">æœ¬ç½‘ç«™æºæ–‡ä»¶</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://beian.miit.gov.cn">æ¸ICPå¤‡19015320å·</a></li>
<li><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030602004109">ç²¤å…¬ç½‘å®‰å¤‡44030602004109å·</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/note/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script type="text/javascript">
                var transLoaded = false;
                var loading = false;
                var domain = "translate.google.com";
                var domainDefault = domain;
                var storeDomain = localStorage.getItem("googleTransDomain");
                if(storeDomain){
                    domain = storeDomain;
                    console.log("load google translate domain from local storage:" + domain);
                }
                function getUrl(domain){
                    if(domain == "/")
                        return "/static/js/google_translate/element.js?cb=googleTranslateElementInit";
                    else
                        return "https://" + domain + "/translate_a/element.js?cb=googleTranslateElementInit";
                }
                var url = getUrl(domain);
                console.log("google translate domain:" + domain + ", url: " + url);
                function googleTranslateElementInit() {
                    new google.translate.TranslateElement({pageLanguage: "auto", layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
                }
                function loadJS( url, callback ){
                    var script = document.createElement('script');
                    fn = callback || function(){ };
                    script.type = 'text/javascript';
                    if(script.readyState){
                        script.onreadystatechange = function(){
                            if( script.readyState == 'loaded' || script.readyState == 'complete' ){
                                script.onreadystatechange = null;
                                fn();
                            }
                        };
                    }else{
                        script.onload = function(){
                            fn();
                        };
                    }
                    script.src = url;
                    document.getElementsByTagName('head')[0].appendChild(script);
                }
                function removeHint(){
                    var hint = document.getElementById("loadingTranslate");
                    if(hint){
                        hint.remove();
                    }
                }
                var btn = document.getElementById("google_translate_element");
                btn.onclick = function(){
                    if(transLoaded) return;
                    if(loading){
                        var flag = confirm("loading from " + domain + ", please wait, or change domain?");
                        if(flag){
                            newDomain = prompt("domain, default: " + domainDefault + ", now: " + domain);
                            if(newDomain){
                                domain = newDomain;
                                console.log(domain);
                                url = getUrl(domain);
                                loadJS(url, function(){
                                    localStorage.setItem("googleTransDomain", domain);
                                    removeHint()
                                    transLoaded = true;
                                });
                            }
                        }
                        return;
                    }
                    btn.innerHTML = '<span id="loadingTranslate"><img class="icon" src="/note/static/image/google_translate/translate.svg"/>Loading ...</span>';
                    loading = true;
                    loadJS(url, function(){
                        localStorage.setItem("googleTransDomain", domain);
                        removeHint()
                        transLoaded = true;
                    });
                }
                </script>
            
    
        <script src="/note/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/note/static/js/theme_default/main.js"></script>
    
        <script src="/note/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/note/static/css/theme_default/prism.min.js"></script>
    
        <script src="/note/static/js/search/search_main.js"></script>
    
        <script src="/note/static/js/plugin_blog/main.js"></script>
    
        <link rel="stylesheet" href="/note/static/js/add_hint/style.css" type="text/css"/>
    
        <script src="/note/static/js/add_hint/main.js"></script>
    
        <script src="/note/static/js/gitalk/gitalk.min.js"></script>
    
        <script src="/note/static/js/gitalk/main.js"></script>
    
        <script src="/note/static/js/custom.js"></script>
    
</body>

</html>