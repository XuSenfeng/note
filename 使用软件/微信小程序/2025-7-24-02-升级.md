# 进阶

## 发送网络数据

发送网络数据的时候必须有域名, 在微信公众平台设置

```html
<view>---网络请求---</view>

<view>ID: {{user.id}}</view>
<view>姓名: {{user.name}}</view>
<view>年龄: {{user.age}}</view>
<view>性别: {{user.sex}}</view>
<view>手机号: {{user.mobile}}</view>
<view>班级: {{user.classmate}}</view>

<button type="primary" bind:tap="handleLoadUser">获取用户信息</button>
```

```js
data: {
    user: {
    },
},

handleLoadUser(){
    wx.request({
        url: "http://127.0.0.1:8000/test1/stu/",
        method: "GET",
        data: {}, // 请求参数, 实际是放在url的?后面
        header: {}, // 请求头
        success: (res) => {
            this.setData({ user: res.data }); // 请求成功
        },
        fail: (err) => {
            console.log(err); // 请求失败
         },
         complete: () => {
            console.log("complete"); // 请求完成
        },
    });
},
```

+ 显示加载中

![image-20250803184445507](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508031844744.png)

```js
wx.showLoading({
    title: "加载中...",
    mask: true, // 是否显示透明蒙层，防止触摸穿透(用于防止用户点击穿透)
});
处理...
wx.hideLoading();
```

## 对话框

### 模态对话框

![image-20250803203037087](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508032030216.png)

```js
wx.showModal({
  title: "提示",
  content: "这是一个测试弹窗",
  complete: (res) => {
    console.log("complete"); // 弹窗关闭
    console.log(res);
    if (res.confirm) {
      console.log("用户点击了确定");
    } else if (res.cancel) {
      console.log("用户点击了取消");
    }
  },
  success: (res) => {
    console.log(res); // 弹窗成功
  },
  fail: (err) => {
    console.log(err); // 弹窗失败
  },
});
},
```

```html
<button type="primary" bind:tap="handleShowModel">测试弹窗</button>
```

### 消息框

![image-20250803203553045](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508032035184.png)

```html
<button type="primary" bind:tap="handleShowToast">测试Toast</button>
```

```js
wx.showToast({
  title: "这是一个测试Toast",
  icon: "success", // 图标, 可以设置为success, loading, none
  duration: 2000, // 存活时间
  mask: true, // 是否显示透明蒙层，防止触摸穿透(用于防止用户点击穿透)
  success: (res) => {
    console.log(res);
  },
  fail: (err) => {
    console.log(err);
  },
  complete: (res) => {
    console.log(res);
  },
});
```

## 存储

应用: 登陆以后, 后端返回一个用户登录的token, 把token记录到小程序端, 后续请求携带

微信小程序记录的数据可以直接是一个对象, 自动转换为json进行记录, 分为同步和异步存储

### 同步保存

![image-20250803204621104](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508032046213.png)

```js
  // 同步保存
  handleSave(){
    wx.setStorageSync("name", "张三");
    wx.setStorageSync("age", 18);
    wx.setStorageSync("sex", "男");
    wx.setStorageSync("communication", {
      "mobile": "13800138000",
      "email": "zhangsan@163.com",
      "address": "北京市海淀区",
    });
  },

  handleLoad(){
    const name = wx.getStorageSync("name");
    const age = wx.getStorageSync("age");
    const sex = wx.getStorageSync("sex");
    const communication = wx.getStorageSync("communication");
    console.log(name, age, sex, communication);
  },

  handleDelete(){
    wx.removeStorageSync("name");
    wx.removeStorageSync("age");
    wx.removeStorageSync("sex");
    wx.removeStorageSync("communication");
  },

  handleClear(){
    wx.clearStorageSync();
  },
```

### 异步操作

```js
async handleSave(){
  await wx.setStorage({
    key: "name",
    data: "张三",
  });
},
async handleLoad(){
  await wx.getStorage({
    key: "name",
    success: (res) => {
      console.log(res.data);
    },
  });
},
async handleDelete(){
  await wx.removeStorage({
    key: "name",
    success: (res) => {
      console.log(res.data);
    },
  });
},
async handleClear(){
  await wx.clearStorage({
    success: (res) => {
      console.log(res.data);
    },
  });
},
```

## 上拉下拉

### 上拉加载更多

![image-20250804161905778](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508041619907.png)

```js
  /**
   * 页面上拉触底事件的处理函数
   */
onReachBottom() {
    console.log("onReachBottom");
    wx.request({
        url: 'https://www.baidu.com',
        method: 'GET',
        success: (res) => {
            console.log(res);
            this.setData({
                good_list: this.data.good_list.concat(this.data.good_list)
            })
        },
        fail: (res) => {
            console.log(res);
        }
    })
},
```

### 下拉加载更多

![image-20250804175341414](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508041753521.png)

```js
  onPullDownRefresh() {
    this.setData({
      good_list: []
    })
    this.onShow(); // 刷新页面    
    wx.stopPullDownRefresh() // 结束刷新
  },
```

### scroll-view实现上下拉

```html
<view class="notice"> 
    <image src="/images/home/board.png" class="aspectFit" style="width: 200rpx; height: 200rpx;" />
    <scroll-view 
    scroll-y 
    class="notice-scroll">
      <view class="notice-item">
        <text>通知公告</text>
        <view wx:for="{{noticeList}}" wx:for-item="item" wx:key="index">
        <view>
          <view wx:if="{{item.isExternal}}" bind:tap="openExternalLink" data-url="{{item.link}}" class="notice-link">
            <text>{{item.title}}</text>
          </view>
          <navigator wx:elif="{{item.link}}" url="{{item.link}}" open-type="navigate" class="notice-link">
            <text>{{item.title}}</text>
          </navigator>
          <text wx:else>{{item.title}}</text>
        </view>
        </view>
      </view>
    </scroll-view>
</view>
```

> 使用`scroll-view `标签, 可以使用的参数有
>
> 1. `scroll-y`:垂直滑动
> 2. `lower-threshold`: 距离底部多少触发事件
> 3. `bindscrolltolower`: 绑定触发的事件
> 4. `refresher-enable`: 是不是可以下拉刷新
> 5. `refresher-default-style`: 下拉的颜色
> 6. `refresher-background`: 背景色
> 7. `bindrefresherrefresh`: 刷新处理函数
> 8. `enable-back-to-top`: 快速返回
> 9. `refresher-triggered={{arg}}`: 记录下拉是不是成功的标志位, 下拉的时候自动设置为true, 改为false结束刷新

## 生命周期

分为一个页面的周期和一个小程序的周期

+ 小程序周期

```js
/**
 * 当小程序初始化完成时，会触发 onLaunch（全局只触发一次）
 */
onLaunch() {
},

/**
 * 当小程序启动，或从后台进入前台显示，会触发 onShow
 */
onShow: function (options) {
},

/**
 * 当小程序从前台进入后台，会触发 onHide
 */
onHide: function () {
},

/**
 * 当小程序发生脚本错误，或者 api 调用失败时，会触发 onError 并带上错误信息
 */
onError: function (msg) {
}
```

+ 页面周期

```js
// pages/pet/state/state.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad(options) {
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady() {
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow() {
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide() {
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload() {
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh() {
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom() {
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage() {
  }
})
```

### 强制更新

在微信里面使用过小程序以后, 微信会把小程序拉到本地, 下次打开的时候优先使用本地的代码

为了同步代码的更新, 在app.js文件里面的onLaunch里面加入下面的代码

```js
onLaunch() {
    // 强制更新逻辑
    const updateManager = wx.getUpdateManager();
    updateManager.onCheckForUpdate(function (res) {
    // 请求完新版本信息的回调
    if (res.hasUpdate) {
        updateManager.onUpdateReady(function () {
        wx.showModal({
            title: '更新提示',
            content: '新版本已经准备好，是否重启应用？',
            showCancel: false,
            success: function (res) {
            if (res.confirm) {
                updateManager.applyUpdate();
            }
            }
        });
        });
        updateManager.onUpdateFailed(function () {
        wx.showModal({
            title: '更新失败',
            content: '新版本下载失败，请删除当前小程序，重新搜索打开。',
            showCancel: false
        });
        });
    }
    });
}
```

![image-20250805143620258](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051436377.png)

![image-20250805143751855](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051437946.png)

### 分享

需要在界面js里面加一个`onShareTimeline`

```js
  // 分享到好友
  onShareAppMessage() {
    return {
      title: '分享标题',
      query: 'name=XvSenfeng', // 访问的时候携带的参数
      imageUrl: '/images/order2.png', // 分享携带的图片
      path: '/pages/mainpage/mainpage', // 实际访问的路径
      success: function (res) {
        console.log('分享成功', res)
      },
      fail: function (res) {
        console.log('分享失败', res)
      }
    }
  },

  // 分享到朋友圈
  onShareTimeline() {
    return {
      title: '分享标题',
      query: 'name=XvSenfeng', // 访问的时候携带的参数
      imageUrl: '/images/order2.png'
    }
  }
```

还可以使用

```html
<button open-type="share"></button>
```

## 获取用户数据

### 头像

```html
<!--
pages/device/device.wxml 文件是用于小程序设备页面的视图层文件。

参数解释：
- class="btn"：为按钮设置自定义样式，样式定义在 device.wxss 文件中。
- open-type="chooseAvatar"：指定按钮的功能为选择头像，用户点击后可以选择或拍摄头像图片。
- bind:chooseavatar="chooseAvatar"：当用户选择头像后，触发 chooseAvatar 方法（在 device.js 文件中定义），用于处理头像选择后的逻辑。
- <image src="{{photo}}" class="photo"></image>：显示当前头像图片，photo 是页面 data 中的变量，class="photo" 用于设置图片样式。

-->
<button class="btn" open-type="chooseAvatar" bind:chooseavatar="chooseAvatar"> 
    <image src="{{photo}}" class="photo"></image>
</button>"
```

```css
/* pages/device/device.wxss */

.btn {
    background-color: transparent; /* 透明背景 */
    border: none; /* 无边框 */
    padding: 0; /* 无内边距 */
    margin: 0; /* 无外边距 */
    width: 100%; /* 宽度100% */
    height: 100%; /* 高度100% */
    display: flex; /* 弹性布局 */
}

.photo {
    width: 250rpx;
    height: 250rpx;
    border-radius: 50%;
}
```

```js
  data: {
    photo: '/images/bottom/cute_1.png'
  },
  chooseAvatar(e) {
    // console.log(e)
  }
```

> 实际获取到的数据如下

![image-20250805152710702](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051527833.png)

### 昵称

```html
<!--
参数解释：
- type="nickname"：输入框类型为昵称，适用于昵称输入。
- placeholder="请输入昵称"：输入框占位符，提示用户输入昵称。
- module:value="{{nickname}}"：将输入框的值与 data 中的 nickname 变量进行双向绑定。
- bind:tap="showName"：点击按钮时触发 showName 方法。
- type="primary" primary：设置按钮为主要按钮，显示为高亮样式。
-->
<input type="nickname" placeholder="请输入昵称" model:value="{{nickname}}" />

<button class="btn" bind:tap="showName" type="primary" primary>提交</button>
```

```js
showName() {
    console.log(this.data.nickname)
}
```

### 手机号

获取手机号以后发送到后端, 在后端实现登录注册, 返回token, 这个接口是非个人的, 付费使用

#### 快速验证

```html
<!--
参数解释：
- open-type="getPhoneNumber"：指定按钮的功能为获取用户手机号。
- bind:getphonenumber="onGetPhoneNumber"：当用户同意授权后，触发 onGetPhoneNumber 方法（需在 device.js 中实现）。
-->
<button class="btn" open-type="getPhoneNumber" bind:getphonenumber="onGetPhoneNumber">获取手机号</button>

```

```js
onGetPhoneNumber(e) {
    console.log(e)
},
```

> 获取的数据里面有一个`e.detail.code`可以使用用于获取手机号
>
> [用户信息 / 手机号 / 手机号快速验证](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html)

#### 实时验证(验证码)

```html
<!--
参数解释：
- open-type="getRealtimePhoneNumber"：指定按钮的功能为获取用户手机号（实时验证）。
- bind:getrealtimephonenumber="onGetRealtimePhoneNumber"：当用户同意授权后，触发 onGetRealtimePhoneNumber 方法（需在 device.js 中实现）。
-->
<button class="btn" open-type="getRealtimePhoneNumber" bind:getrealtimephonenumber="onGetRealtimePhoneNumber">获取实时验证手机号</button>
```

```python
onGetRealtimePhoneNumber(e) {
    console.log(e)
}
```

### openID

微信的OpenID是微信平台为每个用户分配的唯一标识符，用于在特定的公众号或小程序中唯一识别用户。

[用户信息 / 用户信息 / 获取插件用户openpid](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/basic-info/getPluginOpenPId.html)

#### 获取服务器的访问token

[接口调用凭证 / 获取接口调用凭据](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-access-token/getAccessToken.html)

1. 获取信息

![image-20250805173850640](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051738837.png)

2. 获取临时token

![image-20250805174234499](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051742653.png)

获取的token有效时间两个小时

#### 获取实际的数据

```js
onGetUserInfo(e) {
    // 使用 wx.login 获取登录凭证
    wx.login({
        success: (res) => {
            console.log('登录成功:', res)
            if (res.code) {
                // 可以将 code 发送到后端换取 openid 等信息
                console.log('登录凭证 code:', res.code)
            }
        },
        fail: (res) => {
            console.log('登录失败:', res)
        }
    })
},
```

![image-20250805174509188](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051745254.png)

![image-20250805175134376](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051751529.png)

## 客服功能

可以实现直接沟通

![image-20250805175453158](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202508051754335.png)

```html
<button open-type="contact" class="contact-btn theme-{{theme}}" data-type="关于">
```

> 使用contact为按钮的open type

## 拍照

调用手机的照相机

[媒体组件 / camera](https://developers.weixin.qq.com/miniprogram/dev/component/camera.html)

```html
<!-- camera.wxml -->
<camera device-position="back" flash="off" binderror="error" style="width: 100%; height: 300px;"></camera>
<button type="primary" bindtap="takePhoto">拍照</button>
<view>预览</view>
<image mode="widthFix" src="{{src}}"></image>
```

```js
// camera.js
Page({
  takePhoto() {
    const ctx = wx.createCameraContext()
    ctx.takePhoto({
      quality: 'high',
      success: (res) => {
        this.setData({
          src: res.tempImagePath
        })
      }
    })
  },
  error(e) {
    console.log(e.detail)
  }
})
```

## 获取其他页面

```js
var pages = getCurrentPages() // 获取当前开启的页面
var prevPages = pages[pages.length - 2] // 获取上一级
```

## 录音

[媒体 / 录音 / RecorderManager](https://developers.weixin.qq.com/miniprogram/dev/api/media/recorder/RecorderManager.html)
