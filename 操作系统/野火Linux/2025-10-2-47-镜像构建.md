# 镜像合成

## 整个镜像

![image-20251002103617559](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510021036830.png)

 `sudo apt install xz-utils debootstrap multistrap`

`git clone git@gitee.com:LubanCat/build_sd_img.git`

默认./all 下为野火2022-12-24 的镜像组件，如果需要修改可以根据以下进行修改

### 使用脚本合成

1.修改rootfs

./all/rootfs下默认是没有内容的，需要把自己的rootfs解压到./all/rootfs目录,或者将野火官方的带qt的文件系统解压到./all/rootfs下,野火官方的文件系统可以从网盘 i.MX6ULL系列\3-Debian镜像\ebf_debian_2022_12_24\usb烧录文件\mfgtools-release\Profiles\Linux\OS Firmware\release中获取console-armhf-rootfs-lubancat-buster.tar为纯净版文件系统，qt-armhf-rootfs-lubancat-buster.tar为带qt的文件系统,解压到./all/rootfs下即可

2.修改kernel

把生成的zImage拷贝到./all/boot/kernel文件夹下更名替换vmlinuz-4.19.35-imx6,注意boot文件夹不能超过40M

3.修改uboot

把生成的u-boot-dtb.imx更名替换./all/uboot/目录下的u-boot-mmc.imx,注意编译时需要选择mmc版的uboot配置文件编译

4.修改设备树

把生成的设备树imx6ull-mmc-npi.dtb替换.all/rootfs/usr/lib/linux-image-4.19.35-imx6/imx6ull-mmc-npi.dtb

5.修改设备树插件

把生成的设备树插件xxx.dtbo添加或替换.all/rootfs/usr/lib/linux-image-4.19.35-imx6/overlays/下，并在./all/boot/uEnv.txt进行相应的修改

构建：

执行sudo ./build_sd_img.sh 8 构建SD卡镜像 参数8为内存卡大小为8G，同时也为镜像内可用大小，但总大小最小要求为rootfs文件夹的大小+40M 参数也可以为小数，比如0.5，即打包500M大小的镜像

构建前请确认./all/rootfs目录已经放了文件系统，参考以上 1.修改rootfs 确认。

`sudo ./build_sd_img.sh 1`使用这个命令进行构建

> 参数 1 为内存卡大小为1G，同时也为镜像内可用大 小，该参数支持小数，比如输入0.5即构建500M大小的镜像包
>
> 建议在打包的时候参数尽量小，避免烧录镜像至sd卡的时间过长，我们在烧录完成后再对分区 进行扩容即可

### 扩容

将sd卡插入板卡并以sd卡启动方式启动，执行下面命令对分区进行扩容

```bash
#sd卡的主分区是/dev/mmcblk0
 sudo parted /dev/mmcblk0
 #以GB作为单位查看分区信息
unit GB print
 #对mmcblk0的第2分区进行扩容,该分区存放跟文件系统
resizepart 2
 #按提示输入yes进行确认
yes
 #输入参数-1表示完全使用剩余空间-1
 #退出交互
quit
 #调整文件系统大小
sudoresize2fs /dev/mmcblk0p2
```



