# CAN协议

## 基础概念

CAN 的全称为 Controller Area Network，也就是控制局域网络，简称为 CAN

![image-20251119124349660](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119124349660.png)

各个单元通过 CAN总线连接在一起，每个单元都是独立的 CAN节点。同一个 CAN网络中所有单元的通信速度必须一致，不同的网络之间通信速度可以不同。比如图中125Kbps的CAN网络下所有的节点速度都是 125Kbps的，整个网络由一个网关与其他的网络连接

1.   多主控制

在总线空闲时，所有单元都可以发送消息（多主控制），而两个以上的单元同时开始发送消息时，根据标识符（Identifier 以下称为 ID）决定优先级。ID 并不是表示发送的目的地址，而是表示访问总线的消息的优先级。两个以上的单元同时开始发送消息时，对各消息 ID 的每个位进行逐个仲裁比较。仲裁获胜（被判定为优先级最高）的单元可继续发送消息，仲裁失利的单元则立刻停止发送而进行接收工作

2.   系统的柔软性

与总线相连的单元没有类似于“地址”的信息。因此在总线上增加单元时，连接在总线上的其它单元的软硬件及应用层都不需要改变

3.   信速度快，距离远

最高 1Mbps（距离小于 40M），最远可达 10KM（速率低于5Kbps）。

4.   具有错误检测、错误通知和错误恢复功能

所有单元都可以检测错误（错误检测功能），检测出错误的单元会立即同时通知其他所有单元（错误通知功能），正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送此消息直到成功发送为止（错误恢复功能）。

5.   故障封闭功能

CAN 可以判断出错误的类型是总线上暂时的数据错误（如外部噪声等）还是持续的数据错误（如单元内部故障、驱动器故障、断线等）。由此功能，当总线上发生持续数据错误时，可将引起此故障的单元从总线上隔离出去。

6.   连接节点多

CAN 总线是可同时连接多个单元的总线。可连接的单元总数理论上是没有限制的。但实际上可连接的单元数受总线上的时间延迟及电气负载的限制。降低通信速度，可连接的单元数增加；提高通信速度，则可连接的单元数减少

### 电器属性

CAN 总线使用两根线来连接各个单元：CAN_H 和 CAN_L，CAN 控制器通过判断这两根线上的**电位差**来得到总线电平，CAN总线电平分为显性电平和隐性电平两种。显性电平表示逻辑“0”，此时 CAN_H 电平比 CAN_L 高，分别为 3.5V 和 1.5V，电位差为 2V。隐形电平表示逻辑“1”，此时 CAN_H和 CAN_L电压都为 2.5V左右，电位差为 0V。CAN总线就通过显性和隐形电平的变化来将具体的数据发送出去

![image-20251119124924683](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119124924683.png)

CAN总线上没有节点传输数据的时候一直处于隐性状态，也就是说总线空闲状态的时候一直处于隐性。CAN 网络中的所有单元都通过 CAN_H 和 CAN_L 这两根线连接在一起

![image-20251119125032080](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119125032080.png)

### 协议内容

过 CAN总线传输数据是需要按照一定协议进行的，CAN协议提供了 5种帧格式来传输数据：数据帧、遥控帧、错误帧、过载帧和帧间隔

中数据帧和遥控帧有标准格式和扩展格式两种，标准格式有 11位标识符(ID)，扩展格式有 29个标识符(ID)

![image-20251119125239882](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119125239882.png)

### 速率

CAN总线以帧的形式发送数据，但是最终到总线上的就是“0”和“1”这样的二进制数据，这里就涉及到了通信速率，也就是每秒钟发送多少位数据，前面说了CAN2.0最高速度为 1Mbps/S。对于CAN总线，一个位分为 4段

1.   同步段(SS)
2.   传播时间段(PTS)
3.   相位缓冲段 1(PBS1)
4.   相位缓冲段 2(PBS2)

这些段由Tq(Time Quantum)组成，Tq是CAN总线的最小时间单位。帧由位构成，一个位由 4个段构成，每个段又由若干个Tq组成，这个就是位时序。1 位由多少个Tq 构成、每个段又由多少个 Tq 构成等，可以任意设定位时序。通过设定位时序，多个单元可同时采样，也可任意设定采样点。

![image-20251119131956760](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119131956760.png)

![image-20251119132219801](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119132219801.png)

## IMX6ULL CAN

I.MX6ULL 带有 CAN 控制器外设，叫做 FlexCAN，FlexCAN 符合 CAN2.0B 协议。FlexCAN 完全符合 CAN 协议，支持标准格式和扩展格式，支持 64 个消息缓冲。

1.   支持CAN2.0B协议，数据帧和遥控帧支持标准和扩展两种格式，数据长度支持 0~8字节，可编程速度，最高 1Mbit/S。
2.   灵活的消息邮箱，最高支持 8个字节。
3.   每个消息邮箱可以配置为接收或发送，都支持标准和扩展这两种格式的消息。
4.   每个消息邮箱都有独立的接收掩码寄存器。
5.   强大的接收 FIFO ID过滤。
6.   未使用的空间可以用作通用 RAM。
7.   可编程的回测模式，用于进行自测。
8.   可编程的优先级组合。

FlexCAN 支持四种模式：正常模式(Normal)、冻结模式(Freeze)、仅监听模式(Listen-Only)和回环模式(Loop-Back)，另外还有两种低功耗模式：禁止模式(Disable)和停止模式(Stop)。

1.   正常模式**(Normal)**在正常模式下，FlexCAN正常接收或发送消息帧，所有的CAN协议功能都使能。

2.   冻结模式**(Freeze)**当 MCR 寄存器的 FRZ 位置 1 的时候使能此模式，在此模式下无法进行帧的发送或接收，CAN总线同步丢失。

3.   仅监听模式**(Listen-Onley)**当 CTRL 寄存器的 LOM 位置 1 的时候使能此模式，在此模式下帧发送被禁止，所有错误

     计数器被冻结， CAN控制器工作在被动错误模式，此时只会接收其他CAN单元发出的ACK消息。

4.   回环模式**(Loop-Back)**当 CTRL 寄存器的 LPB 位置 1 的时候进入此模式，此模式下 FlexCAN 工作在内部回环模式，一般用来进行自测。从模式下发送出来的数据流直接反馈给内部接收单元。

FlexCAN支持CAN协议的这些位时序，控制寄存器CTRL用于设置这些位时序，CTRL寄存器中的PRESDIV、PROPSEG、PSEG1、PSEG2和RJW这5个位域用于设置CAN位时序

+   PRESDIV为CAN分频值，也即是设置CAN协议中的Tq值![image-20251119132911456](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119132911456.png)
+   **SS**：同步段(Synchronization Segment)，在 I.MX6ULL 参考手册中叫做 SYNC_SEG，此段固定为1个 Tq长度，因此不需要我们去设置。
+   **PTS**：传播时间段(Propagatin Segment)，FlexCAN的 CTRL寄存器中的 PROPSEG位域设置此段，可以设置为 0\~7，对应1\~8个Tq。
+   **PBS1**：相位缓冲段 1(Phase Buffer Segment 1)，FlexCAN 的 CRTL 寄存器中的 PSEG1 位域设置此段，可以设置为0\~7，对应1\~8个 Tq。
+   **PBS2**：相位缓冲段 2(Phase Buffer Segment 2)，FlexCAN 的 CRTL 寄存器中的 PSEG2 位域设置此段，可以设置为1\~7，对应2\~8个 Tq。
+   **SJW**：再同步补偿宽度(reSynchronization Jump Width)，FlexCAN的 CRTL寄存器中的RJW位域设置此段，可以设置 0\~3，对应1\~4个Tq。

`SYNC+SEG+(PROP_SEG+PSEG1+2)+(PSEG2+1)`就是总的Tq

![image-20251119133458374](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119133458374.png)

![image-20251119133518569](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119133518569.png)

## 设备树

Documentation/devicetree/bindings/net/can/fsl-flexcan.txt

### 引脚

```json
pinctrl_flexcan1: flexcan1grp{
  fsl,pins = <
    MX6UL_PAD_UART3_RTS_B__FLEXCAN1_RX	0x1b020
    MX6UL_PAD_UART3_CTS_B__FLEXCAN1_TX	0x1b020
  >;
};
```

配置两个引脚的复用

```json
flexcan1: can@02090000 {
  compatible = "fsl,imx6ul-flexcan", "fsl,imx6q-flexcan";
  reg = <0x02090000 0x4000>;
  interrupts = <GIC_SPI 110 IRQ_TYPE_LEVEL_HIGH>;
  clocks = <&clks IMX6UL_CLK_CAN1_IPG>,
     <&clks IMX6UL_CLK_CAN1_SERIAL>;
  clock-names = "ipg", "per";
  stop-mode = <&gpr 0x10 1 0x10 17>;
  status = "disabled";
};

&flexcan1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_flexcan1>;
	xceiver-supply = <&reg_can_3v3>;
	status = "okay";
};
```

>   CAN收发器的电压为 3.3V

### 对应驱动

NXP 官方提供的 linux 内核默认已经集成了 I.MX6ULL 的 FlexCAN 驱动

```
-> Networking support
	-> <*> CAN bus subsystem support //打开CAN总线子系统
```

接着使能Freescale系CPU的 FlexCAN外设驱动

```
-> Networking support
  -> CAN bus subsystem support
    -> CAN Device Drivers
      -> Platform CAN drivers with Netlink support
        -> <*> Support for Freescale FLEXCAN based chips //选中
```

在使能以后可以在网络部分查看到这个网卡

```c
ifconfig -a //查看所有网卡
```

## 使用

busybox自带的 ip命令并不支持对can的操作, can实际被虚拟出一个网卡，因此我们需要重新移植 ip命令，也就是iproute2

使用can-utils这个工具来对 can0网卡进行测试, 编程里面使用的是socket编程