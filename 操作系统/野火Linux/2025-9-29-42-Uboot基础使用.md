# Uboot

不仅支持嵌入式Linux系统的引导，还支持NetBSD,VxWorks, QNX, RTEMS, ARTOS, LynxOS, Android 等嵌入式操作系统的引导

一般来说BootLoader必须提供系统上电时的初始化代码，在系统上电时初始化相关环境后，Boot Loader 需要引导完整的操作系统，然后将控制器交给操作系统。简单来说BootLoader是一段小 程序，它在系统上电时执行，通过这段小程序可以将硬件设备进行初始化，如CPU、SDRAM、 Flash、串口、网络等，初始化完毕后调用操作系统内核。

## 基础使用

启动的时候随意按一个按键即可进入boot

### 基础命令

在没有命令名冲突的情况下可以使用命令的前几个字母作为命令的输入

![image-20250929205522833](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292055963.png)

#### mmc命令

![image-20250929205629354](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292056405.png)

![image-20250929205856104](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292058140.png)

uboot 能够对ext2/3/4 以及 fat 文件系统设备进行访问，可使用fstype命令判断存储介质分区使用 的是什么类型的文件系统。

![image-20250929205945430](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292059455.png)

#### 文件系统

![image-20250929210407759](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292104794.png)

+ fatmkdir：创建目录
+ fatrm：删除文件
+ fatwrite: 把内存上的数据存储到FAT分区的一个文件里

![image-20250929210818807](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292108840.png)

## 启动过程

bootcmd与bootargs可以说是uboot最重要的两个环境参数，uboot执行完毕之后，如果没有按下 回车，则会自动执行bootcmd命环境参数里的内容，而bootargs则是传递给内核的启动参数

> 参数的配置可以从include/configs/mx6ullfire.h文件里面查看

```
=> printenv bootcmd
bootcmd=run distro_bootcmd
=> printenv distro_bootcmd
distro_bootcmd=for target in ${boot_targets}; do run bootcmd_${target}; done
=> printenv boot_targets  
boot_targets=mmc0 mmc1 
```

> mmc0表示的sd卡的存储设备，mmc1表示的emmc设备, 当sd卡插在板子时， 若sd卡装有系统则会优先从sd卡内启动

bootcmd_mmc0与bootcmd_mmc1均设置各自devtype、mmcdev、bootpart、rootfpart环境参数 的值，最后运行boot环境参数

```
=> printenv bootcmd_mmc0
bootcmd_mmc0=if test -n "${SDBOOT}"; then setenv devtype mmc; setenv mmcdev 0; setenv bootpart 0:1 ; setenv rootfpart 0:2 ; run boot; fi
=> printenv bootcmd_mmc1
bootcmd_mmc1=setenv devtype mmc; setenv mmcdev 1; setenv bootpart 1:1 ; setenv rootfpart 1:2 ; run boot
```

最后执行的boot命令如下

```python
	"boot=mmc check;${devtype} dev ${mmcdev};mmc rescan; " \
		"echo loading [${devtype} ${bootpart}] /uEnv.txt ...; "\
		"if run loaduEnv; then " \ # 加载uEnv.txt文件的配置
			"run importbootenv;" \ # 运行importbootenv，从内存地址中导入环境参数
			"if test ${second_flash} = emmc; then " \ # 判断启动的介质设置dtb、storage、init环境参数
					"setenv dtb ${mmc_dtb};"  \
					"setenv storage_media init=/opt/scripts/tools/eMMC/init-eMMC-flasher-v3.sh;"  \
				"else " \
					"setenv dtb ${nand_dtb};"  \
					"setenv storage_media init=/opt/scripts/tools/Nand/init-Nand-flasher-v1.sh;"  \
				"fi; " \
			"if test -n ${flash_firmware}; then "  \
					"echo setting flash firmware...;"  \
					"setenv flashtype ${storage_media};"  \
			"fi;" \
			"run args_mmc_old;" \ # args_mmc_old 的作用主要用于设置bootargs环境参数
			"echo loading vmlinuz-${uname_r} ...; "\
            # 将kernel内核加载到内存地址0x80800000
			"load ${devtype} ${bootpart} 0x80800000 /kernel/vmlinuz-${uname_r};"\ 
			"echo loading ${dtb} ...; "\
            # 将主设备树加载到内存地址0x83000000处
			"load ${devtype} ${rootfpart} 0x83000000 /usr/lib/linux-image-${uname_r}/${dtb};"\ 
            # ，将设备树插件的内容解析合成到主设备树上，dtfile命令并不是原来uboot就有的，
		   # 为了方便用户使用/boot/uEnv.txt 文件使用设备树插件而添加的，有兴趣的读者可自行查看相关源码。
			"dtfile 0x83000000 0x87000000  /uEnv.txt ${loadaddr};"   \
            # 将虚拟文件系统加载到0x88000000中
			"load ${devtype} ${bootpart} 0x88000000 /kernel/initrd.img-${uname_r};"\
			"echo debug: [${bootargs}] ... ;" \
			"echo debug: [bootz] ...  ;" \
		   # 启动linux内核
			"bootz 0x80800000 0x88000000:${filesize} 0x83000000;"	\
		"fi;\0" \
```

这里面的loaduEnv是` loaduEnv=load${devtype} ${bootpart} ${loadaddr} /uEnv.txt;`, 加载一下这个文件

```c
"args_mmc_old=setenv bootargs console=ttymxc0 " \
    "root=/dev/mmcblk${mmcdev}p2 rw " \
    "rootfstype=ext4 " \
    "rootwait ${cmdline} ${flashtype}\0" \
```

## 环境参数

uboot 中环境参数为我们提供一种不修改uboot源码的情况下，能够修改kernel启动倒计时、ip地 址、以及向内核传递不同的参数等

默认情况下使用`setenv`命令修改环境参数重启后就会消失，若想要掉电保存需要执行`saveenv`将环境参数保存到存储介质。

> [The U-Boot Documentation — Das U-Boot unknown version documentation](https://docs.u-boot.org/en/latest/)

## 编译

![image-20250929215934240](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202509292159312.png)

野火提供的imx6ulluboot分为nand版本和emmc版本，以编译emmc版本为例

```bash
 sudo make distclean
 # 编译 emmc 版本 uboot, 加载板级配置文件，具体的板级配置文件在uboot根目录下的configs目录下
 sudo make ARCH=arm CROSS_COMPILE=arm-none-eabi- mx6ull_fire_mmc_defconfig
 # 编译 uboot
 sudo make ARCH=arm CROSS_COMPILE=arm-none-eabi-
```

#### 生成的文件

+ u-boot：初步链接后得到的uboot文件
+ u-boot-nodtb.bin：是在u-boot的基础上，经过objcopy去除符号表信息之后的可执行程序， 具体代码如下
+ u-boot.dtb：uboot的设备树，是由arm-none-eabi-gcc和dtc编译出来的，详细的可以分析编 译过程，这里就不展开分析了
+ u-boot.bin：是在u-boot-nodtb.bin后追加了u-boot.dtb形成的
+ u-boot-dtb.imx：是u-boot.bin添加了3KB头部信息和尾部信息(结尾添加了1298字节的 00,00实际没什么作用)组成的镜像

编译生成的u-boot-dtb.imx 文件就是我们想要文件

## 烧录

### Windows

MFGTool 工具是 NXP 官方推荐的一个使用USBOTG来升级镜像的软件工具，它是NXP针对 i.MX 系列处理器专门使用的烧录工具

可以用来升级linux，单独烧录某一系统分区，独立地烧 录spi flash、nor flash、sd card、nand flash，emmc 等

MFGtool工具的烧录步骤分为两个阶段：BurnStarp和Updater。第一阶段是烧录前的准 备工作，配置设备USB的vid和pid，来选择烧录的设备。第二阶段是MFGtools开始烧录到结束 烧录的过程，这个阶段的烧录过程是严格根据ucl2.xml文件来处理的，实际上是将bootloader加 载到ram，然后在运行时将编译好的文件系统和镜像文件烧录到开发板上，烧录的位置由用户指 定，可以是sdcard、nandflash，emmc等

入到mfgtool 目录中的`mfgtools-release\Profiles\Linux\OS Firmware\release` 目录将相应文 件替换即

将mfgtools-release\Profiles\Linux\OS Firmware 目录下的 ucl2.xml 替换

“cfg.ini”文件默认为EMMC的烧写配置文件，若想要烧写NAND版本镜像，将cfg.ini 重命名为cfg-emmc.ini，并将cfg-nand.ini 文件重命名为cfg.ini 即可

emmc 版本：将1/4/5/7打到ON档，其他拨码开关打到OFF档。

>  也可以选择通过按键方式进入烧录模式，按键法可以不用拨码，拨码状态在之前的EMMC 或者NAND都可以
>
> 1. 上电 
> 2. 按下MODE按键
> 3. 按下复位(RESET)按键
> 4. 松开复位(RESET)按键
> 5. 松开MODE按键

### Ubuntu

1. 将sd卡通过读卡器连接到虚拟机前，使用lsblk命令查看当前磁盘设备
2. 将sd卡通过读卡器连接到电脑上，并选择连接到虚拟机上
3. 再次使用lsblk命令插件磁盘设备，如下所示
4. 执行以下烧录命令，将u-boot-dtb.imx烧写到/dev/sdb中

```bash
sudo dd iflag=dsync oflag=dsync if=u-boot-dtb.imx of=/dev/sdb seek=2
```

将sd卡插到开发板上将拨码开关设置sd卡启动打开电源即可启动uboot。