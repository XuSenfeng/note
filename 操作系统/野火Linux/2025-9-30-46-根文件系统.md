# 根文件系统

根文件系统首先是内核启动时所mount的第一个文件系统，内核代码映像文件保存在根文件系 统中，而系统引导启动程序会在根文件系统挂载之后从中把一些基本的初始化脚本和服务等加 载到内存中去运行

[IMX6ULL - Linux根文件系统(rootfs)构建 - 树·哥 - 博客园](https://www.cnblogs.com/zzssdd2/p/15485283.html)

## 目录简介

+ **/bin** 目录, 该目录下的命令可以被root与一般账号所使用，由于这些命令在挂接其它文件系统之前就可以 使用，所以/bin 目录必须和根文件系统在同一个分区中。/bin目录下常用的命令有：cat、chgrp、 chmod、cp、ls、sh、kill、mount、umount、mkdir 等。我们之后在利用Busybox制作根文件系统时， 在生成的bin目录下，可以看到一些可执行的文件，也就是可用的一些命令。
+ **/sbin** 目录: 该目录下存放系统命令，即只有系统管理员（俗称最高权限的root）能够使用的命令，系统命令 还可以存放在/usr/sbin,/usr/local/sbin 目录下，/sbin 目录中存放的是基本的系统命令，它们用于启 动系统和修复系统等，与/bin目录相似，在挂接其他文件系统之前就可以使用/sbin，所以/sbin目 录必须和根文件系统在同一个分区中。/sbin目录下常用的命令有：shutdown、reboot、fdisk、fsck、 init 等，本地用户自己安装的系统命令放在/usr/local/sbin目录下。
+ **/dev** 目录 该目录下存放的是设备与设备接口的文件，设备文件是Linux中特有的文件类型，在Linux系 统下，以文件的方式访问各种设备，即通过读写某个设备文件操作某个具体硬件。比如通过” dev/ttySAC0”文件可以操作串口0，通过”/dev/mtdblock1”可以访问MTD设备的第2个分区。比 较重要的文件有/dev/null,/dev/zero, /dev/tty, /dev/lp* 等。
+ **/etc** 目录 该目录下存放着系统主要的配置文件，例如人员的账号密码文件、各种服务的其实文件等。一般 来说，此目录的各文件属性是可以让一般用户查阅的，但是只有root有权限修改。对于PC上的 Linux 系统，/etc目录下的文件和目录非常多，这些目录文件是可选的，它们依赖于系统中所拥有 的应用程序，依赖于这些程序是否需要配置文件。在嵌入式系统中，这些内容可以大为精减。
+ **/lib** 目录 该目录下存放共享库和可加载（驱动程序），共享库用于启动系统。运行根文件系统中的可执行 程序，比如：/bin/sbin目录下的程序。
+ **/home** 目录 系统默认的用户文件夹，它是可选的，对于每个普通用户，在/home目录下都有一个以用户名命 名的子目录，里面存放用户相关的配置文件。
+ **/root** 目录 系统管理员（root）的主文件夹，即是根用户的目录，与此对应，普通用户的目录是/home下的某 个子目录。
+ **/usr** 目录 /usr 目录的内容可以存在另一个分区中，在系统启动后再挂接到根文件系统中的/usr目录下。里 面存放的是共享、只读的程序和数据，这表明/usr目录下的内容可以在多个主机间共享，这些主 要也符合FHS标准的。/usr中的文件应该是只读的，其他主机相关的，可变的文件应该保存在其 他目录下，比如/var。/usr目录在嵌入式中可以精减。
+ **/var** 目录 与/usr 目录相反，/var目录中存放可变的数据，比如spool目录（mail,news），log文件，临时文件
+ **/proc** 目录 这是一个空目录，常作为proc文件系统的挂接点，proc文件系统是个虚拟的文件系统，它没有 实际的存储设备，里面的目录，文件都是由内核临时生成的，用来表示系统的运行状态，也可以 操作其中的文件控制系统。
+ **/mnt** 目录 用于临时挂载某个文件系统的挂接点，通常是空目录，也可以在里面创建一引起空的子目录，比 如/mnt/cdram /mnt/hda1 。用来临时挂载光盘、移动存储设备等。
+ **/tmp** 目录 用于存放临时文件，通常是空目录，一些需要生成临时文件的程序用到的/tmp目录下，所以/tmp 目录必须存在并可以访问

> 而/boot 这个目录则取决于你所使用的BootLoader是否能够重新获得内核映象从你的根文件系统在内核 启动之前。一般说来，只有/bin，/dev，/etc，/lib，/proc，/var，/usr这些需要的，而其他都是可选 的

![image-20251001154501253](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510011545317.png)

## Ubuntu根文件系统

Ubuntu 针对不同的 CPU 架构提供相应的 ubuntu base 根文件系统，目前提供的架构有 amd64、 arm64、armhf、i386、s390x、ppc64

https://manpages.debian.org/bullseye/multistrap/multistrap.1.en.html

### 下载

[Ubuntu Base 20.04.5 LTS (Focal Fossa)](https://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/)

![image-20251001154841521](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510011548576.png)

### 初始化

```bash
tar -vxf ubuntu-base-20.04.1-base-armhf.tar.gz 
ls /usr/bin/qemu-arm-static  ./usr/bin
cp /usr/bin/qemu-arm-static  ./usr/bin/
sudo cp ./etc/apt/sources.list ./etc/apt/sources.list.back
sudo echo "nameserver 8.8.8.8" > ./etc/resolv.conf
sudo vim ./etc/apt/sources.list
```

> ```
> deb https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
> deb-src https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
> 
> deb https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
> deb-src https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
> 
> deb https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
> deb-src https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
> 
> # deb https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
> # deb-src https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
> 
> deb https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
> deb-src https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
> ```
>
> 使用上面的

`sudo cp /usr/bin/qemu-arm-static ./usr/bin/`

`sudo cp -b /etc/resolv.conf ./etc/resolv.conf`

使用下面的脚本

```bash
#!/bin/bash
function mnt() {
    echo "MOUNTING"
    sudo mount -t proc /proc ${2}proc
    sudo mount -t sysfs /sys ${2}sys
    sudo mount -o bind /dev ${2}dev
    sudo mount -o bind /dev/pts ${2}dev/pts        
    sudo chroot ${2}
}
function umnt(){
    echo "UNMOUNTING"
    sudo umount ${2}proc
    sudo umount ${2}sys
    sudo umount ${2}dev/pts
    sudo umount ${2}dev
}
if [ "$1" == "-m" ] && [ -n "$2" ] ;
then
    mnt $1 $2
elif [ "$1" == "-u" ] && [ -n "$2" ];
then
    umnt $1 $2
else
    echo ""
    echo "Either 1'st, 2'nd or bothparameters were missing"
    echo ""
    echo "1'st parameter can be one ofthese: -m(mount) OR -u(umount)"
    echo "2'nd parameter is the full pathof rootfs directory(with trailing '/')"
    echo ""
    echo "For example: ch-mount -m/media/sdcard/"
    echo ""
    echo 1st parameter : ${1}
    echo 2nd parameter : ${2}
fi
```

使用命令进入

`sudo bashch-mount.sh -m ./`

之后可以使用`apt update`进行更新以及软件的安装

## Debian

### multistrap 失败

我们这里使用目前Debian社区较为推荐的Multistrap构建Debian根文件系统，与传统的deboot strap 不同，multistrap 在包的选择上更具灵活性

```bash
touch ./config_file
mkdir ./rootfs
vim ./config_file
```



```c
[General]
#directory=target-rootfs
cleanup=true
noauth=true
unpack=true
debootstrap=Debian Net Utils Ebf
aptsources=Debian
noauth=true # GPG error
[Debian]
packages=apt kmod lsof
#source=https://mirrors.sjtug.sjtu.edu.cn/debian/
source=https://mirrors.tuna.tsinghua.edu.cn/debian/
keyring=debian-archive-keyring
suite=buster
components=main contrib non-free
[Net]
# Basic packages to enable the networking
packages=netbase net-tools ethtool udev iproute2 iputils-ping ifupdownisc-dhcp-client ssh
#source=https://mirrors.sjtug.sjtu.edu.cn/debian/
source=https://mirrors.tuna.tsinghua.edu.cn/debian/
[Utils]
# General purpose utilities
packages=locales vim adduser less wget dialog usbutils
#source=https://mirrors.sjtug.sjtu.edu.cn/debian/
source=https://mirrors.tuna.tsinghua.edu.cn/debian/
[Lhf]
packages=python3 mate-desktop-environment
source=http://mirrors.bfsu.edu.cn/debian
suite=buster
components=main contrib non-free
[Ebf]
packages= ifupdown rsyslog htop iputils-ping
source=http://mirrors.bfsu.edu.cn/debian
suite=buster
components=main
```

> 其中之需要将需要的安装包添加到[Ebf]中的packages即可
>
> ```
> directory=target-rootfs    # 目标根文件系统目录
> cleanup=true              # 清理临时文件
> noauth=true               # 跳过GPG验证（可能因网络问题）
> unpack=true               # 解压包文件
> debootstrap=Debian Net Utils Ebf  # 按顺序执行这些段
> aptsources=Debian         # 使用Debian段的配置作为APT源
> ```
>
> **[Debian] 段**
>
> 基础系统包：
>
> - `apt` - 包管理工具
> - `kmod` - 内核模块管理
> - `lsof` - 列出打开文件
>
> **[Net] 段**
>
> 网络相关包：
>
> - `netbase` - 基本网络配置
> - `net-tools`, `iproute2` - 网络工具
> - `ssh` - SSH客户端/服务器
> - `isc-dhcp-client` - DHCP客户端
>
> **[Utils] 段**
>
> 实用工具：
>
> - `vim` - 文本编辑器
> - `wget` - 下载工具
> - `locales` - 本地化支持
>
> **[Lhf] 段**
>
> 桌面环境：
>
> - `python3`
> - `mate-desktop-environment` - MATE桌面
>
> **[Ebf] 段**
>
> 额外系统工具：
>
> - `rsyslog` - 系统日志
> - `htop` - 进程查看器

运行下面的命令`multistrap -a armhf -d ./rootfs/ -f ./config_file`

###  debootstrap

[debootstrap 制作根文件系统 - 红豆の布丁 - 博客园](https://www.cnblogs.com/huaibovip/p/debootstrap-fs.html)

```bash
sudo apt-get install debian-archive-keyring
sudo apt-get install  qemu qemu-user-static  binfmt-support debootstrap
```

当前debootstrap支持的发行版本可以在`/usr/share/debootstrap/scripts`查看，而各发行版代号可以到`http://en.wikipedia.org/wiki/List_of_Ubuntu_releases`查看。

> Debian 发行版
>
> Debian的代号来自《玩具总动员》角色：
>
> **稳定版 (按发布时间顺序)：**
>
> - `potato` - Debian 2.2 (2000年)
> - `woody` - Debian 3.0 (2002年)
> - `sarge` - Debian 3.1 (2005年)
> - `etch` - Debian 4.0 (2007年)
> - `lenny` - Debian 5.0 (2009年)
> - `squeeze` - Debian 6.0 (2011年)
> - `wheezy` - Debian 7 (2013年)
> - `jessie` - Debian 8 (2015年)
> - `stretch` - Debian 9 (2017年)
> - `buster` - Debian 10 (2019年)
> - `bullseye` - Debian 11 (2021年)
> - `bookworm` - Debian 12 (2023年)
>
> **开发版本：**
>
> - `sid` - 不稳定版 (永远的代号)
> - `testing` - 测试版 (滚动代号)
> - `unstable` - 不稳定版 (同sid)
> - `stable` - 稳定版 (滚动代号，当前指向bookworm)
> - `oldstable` - 旧稳定版 (滚动代号，当前指向bullseye)
> - `oldoldstable` - 旧旧稳定版 (滚动代号，当前指向buster)
>
> **特殊版本：**
>
> - `jessie-kfreebsd` - 基于FreeBSD内核的Debian变体
>
> Ubuntu 发行版
>
> Ubuntu的代号采用"形容词+动物"格式，首字母相同：
>
> **按发布时间顺序：**
>
> - `warty` - Ubuntu 4.10 (2004年)
> - `hoary` - Ubuntu 5.04 (2005年)
> - `breezy` - Ubuntu 5.10 (2005年)
> - `dapper` - Ubuntu 6.06 LTS (2006年)
> - `edgy` - Ubuntu 6.10 (2006年)
> - `feisty` - Ubuntu 7.04 (2007年)
> - `gutsy` - Ubuntu 7.10 (2007年)
> - `hardy` - Ubuntu 8.04 LTS (2008年)
> - `intrepid` - Ubuntu 8.10 (2008年)
> - `jaunty` - Ubuntu 9.04 (2009年)
> - `karmic` - Ubuntu 9.10 (2009年)
> - `lucid` - Ubuntu 10.04 LTS (2010年)
> - `maverick` - Ubuntu 10.10 (2010年)
> - `natty` - Ubuntu 11.04 (2011年)
> - `oneiric` - Ubuntu 11.10 (2011年)
> - `precise` - Ubuntu 12.04 LTS (2012年)
> - `quantal` - Ubuntu 12.10 (2012年)
> - `raring` - Ubuntu 13.04 (2013年)
> - `saucy` - Ubuntu 13.10 (2013年)
> - `trusty` - Ubuntu 14.04 LTS (2014年)
> - `utopic` - Ubuntu 14.10 (2014年)
> - `vivid` - Ubuntu 15.04 (2015年)
> - `wily` - Ubuntu 15.10 (2015年)
> - `xenial` - Ubuntu 16.04 LTS (2016年)
> - `yakkety` - Ubuntu 16.10 (2016年)
> - `zesty` - Ubuntu 17.04 (2017年)
> - `artful` - Ubuntu 17.10 (2017年)
> - `bionic` - Ubuntu 18.04 LTS (2018年)
> - `cosmic` - Ubuntu 18.10 (2018年)
> - `disco` - Ubuntu 19.04 (2019年)
> - `eoan` - Ubuntu 19.10 (2019年)
>
> Kali Linux 发行版
>
> Kali基于Debian，专门用于渗透测试：
>
> - `kali` - 早期版本
> - `kali-dev` - 开发版
> - `kali-last-snapshot` - 最后快照
> - `kali-rolling` - 滚动发行版

```bash
sudo debootstrap --arch=armhf bionic linux-rootfs http://mirrors.ustc.edu.cn/ubuntu-ports/
sudo cp -a /usr/bin/qemu-arm-static ~/build/linux-rootfs/usr/bin/qemu-arm-static
```

> 安装ubuntu18.4
>
>  –variant=minbase：指定构建基础的ubuntu发行版本
>
> --include=${DEBOOTSTRAP_LIST// /,}：DEBOOTSTRAP_LIST为需要安装的包列表
>
> ${PACKAGE_LIST_EXCLUDE:+ --exclude=${PACKAGE_LIST_EXCLUDE// /,}}：PACKAGE_LIST_EXCLUDE为不需要安装的包列表
>
> --arch=$DISTRIB_ARCH：DISTRIB_ARCH为构建的目标架构，针对arm架构可以选择：arm64, armhf
>
> --components=${DEBOOTSTRAP_COMPONENTS}：DEBOOTSTRAP_COMPONENTS代表仓库中的：main restricted universe multiverse
>
> --foreign $DISTRIB_RELEASE：DISTRIB_RELEASE为发行版本类型，如bionic focal
>
> $ROOTFS_TEMP：构建文件的生成地址
>
> $apt_mirror：拉取包的源地址，如国内源：https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/
>

## 烧录

### USB烧录

在使用mfgtool可以查看一下当前cfg.ini 使用的是哪一个根文件系统，我这里使用的是 console-armhf rootfs-lubancat-buster.tar

我们将上面章节获得的根文件夹打包`tar -cvf ./rootfs/./console-armhf-rootfs-lubancat-buster.tar`

[6. 烧写系统 — [野火\]快速使用手册——基于i.MX6ULL开发板 文档](https://doc.embedfire.com/linux/imx6/quick_start/zh/latest/quick_start/install_debian/install_debian.html)

### SD卡

`tar-cvf ./rootfs/ ./rootfs.tar`

替换build_sd_img.sh文件夹里面的文件

等脚本运行完在当前目录会出现一个名为imx6ull.img.xz的文件
