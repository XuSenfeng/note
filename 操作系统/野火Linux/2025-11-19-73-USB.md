# USB

USB 只能主机与设备之间进行数据通信，USB 主机与主机、设备与设备之间是不能通信的。因此两个正常通信的USB接口之间必定有一个主机，一个设备。为此使用了不同的插头和插座来区分主机与设备，比如主机提供 USB A 插座，从机提供 Mini USB、Micro USB 等插座。

在一个 USB 系统中，仅有一个 USB 主机，但是可以有多个 USB 设备，包括 USB 功能设备和USB HUB，最多支持 127个设备。一个USB主控制器支持128个地址，地址 0是默认地址，只有在设备枚举的时候才会使用，地址0不会分配给任何一个设备。所以一个 USB主控制器最多可以分配127个地址。整个USB的拓扑结构就是一个分层的金字塔形

![image-20251119155250924](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119155250924.png)

>   从 Root Hub 开始，一共有 7 层，金字塔顶部是 Root Hub，这个是USB控制器内部的。图中的 Hub就是连接的USB集线器，Func就是具体的USB设备
>
>   USB 主机和从机之间的通信通过管道(Pipe)来完成，管道是一个逻辑概念，任何一个 USB设备一旦上电就会存在一个管道，也就是默认管道，USB 主机通过管道来获取从机的描述符、配置等信息。在主机端管道其实就是一组缓冲区，用来存放主机数据，在设备端管道对应一个特定的端点

USB分为HOST(主机)和从机(或DEVICE)，有些设备可能有时候需要做HOST，有时候又需要做 DEVICE，配两个USB口当然可以实现，但是太浪费资源了。如果一个USB 接口既可以做 HOST又可以做 DEVICE那就太好了，使用起来就方便很多。为此，USBOTG 应运而生，OTG 是 On-The-Go 的缩写，支持 USB OTG 功能的 USB 接口既可以做 HOST，也可以做 DEVICE。那么问题来了，一个 USB 接口如何知道应该工作在 HOST 还是 DEVICE呢？这里就引入了 ID线这个概念

+   **ID=1**：OTG设备工作在从机模式。
+   **ID=0**：OTG设备工作在主机模式。

>   TypcC使用的是新增的C1C2引脚确定主机从机的

## IMX6ULL

I.MX6ULL内部集成了两个独立的 USB控制器，这两个 USB控制器都支持 OTG功能。I.MX6ULL内部USB控制器特性如下：

1.   有两个 USB2.0控制器内核分别为 Core0和 Core1，这两个 Core分别连接到 OTG1 和OTG2。
2.   两个USB2.0控制器都支持HS、FS和 LS模式，不管是主机还是从机模式都支持 HS/FS/LS，硬件支持OTG信号、会话请求协议和主机协商协议，支持8个双向端点。
3.   支持低功耗模式，本地或远端可以唤醒。
4.   每个控制器都有一个DMA。

每个 USB OTG 控制器都可以运行在高速模式(HS 480Mbps)、全速模式(LS 12Mbps)和低速模式(1.5Mbps)。正常模式下每个 OTG 控制器都可以工作在主机(HOST)或从机(DEVICE)模式下，每个 USB 控制器都有其对应的接口

+   正常模式下每个 OTG 控制器都可以工作在主机(HOST)或从机(DEVICE)模式下，每个 USB 控制器都有其对应的接口。
+   低功耗模式顾名思义就是为了节省功耗，USB2.0 协议中要求，设备在上行端口检测到空闲状态以后就可以进入挂起状态。在从机(DEVICE)模式下，端口停止活动3ms以后OTG控制器内核进入挂起状态。在主机(HOST)模式下，OTG控制器内核不会自动进入挂起状态，但是可以通过软件设置。不管是本地还是远端的USB主从机都可以通过产生唤醒序列来重新开始 USB通信

两个USB控制器都兼容**EHCI**

**EHCI**：全称是 Enhanced Host Controller Interface，是 Inter主导的一个用于 USB2.0 的 USB控制器标准。I.MX6ULL的两个USB控制器都是2.0的，因此兼容EHCI标准。EHCI仅提供 USB2.0的高速功能，至于全速和低速功能就由OHCI或UHCI来提供

## 电路

 Mini USB 插头有 5 个触点，也就是 5 根线，线序从左往右依次是 1~5。第 1根线为 VCC(5V)，第2根线为D-，第 3根线为 D+，第 4根线为ID，第5根线为GND。可以看出Mini USB插头相比 USB A插头多了一个 ID线，这个ID线用于实现OTG功能，通过 ID线来判断当前连接的是主设备(HOST)还是从设备(SLAVE)。

![image-20251119175034944](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119175034944.png)

![image-20251119175110790](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119175110790.png)

从机**(DEVICE)**模式：图67.2.2.1中USB_OTG_VBUS是Mini USB的电源线，只有插入 Mini USB 线以后 USB_OTG_VBUS 才有效(5V)。插入 Mini USB 线就表示开发板此时要做从机(此时不考虑接OTG线的情况)，USB_OTG_VBUS就是电脑供的5V电压，由于分压电阻 R111和 R31 的作用，此时 USB_OTG1_ID 的电压就是 4.5V 左右，很明显这一个高电平。前面我们讲了，当ID线为高的时候就表示 OTG工作在从机模式。

主机**(HOST)**模式：主机模式下必须将 Mini USB 线拔出来，将 USB 设备连接到对应的 USB HOST接口上。Mini USB线拔出来以后USB_OTG_VBUS就没有电压了，此时USB_OTG1_ID线就被R31这个 100K电阻下拉到地，因此USB_OTG1_ID线的电压就为 0，当ID线为0的时候就表示OTG工作在主机模式。

![image-20251119175235613](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/mac-picture/image-20251119175235613.png)

当OTG作为从机(DEVICE)的时候USB线接入此接口。当OTG作为主机的时候需要使用 Type-C OTG线, Type-C 的 CC1 和 CC2 引脚就是完成传统的 USB ID 线功能的

从机**(DEVICE)**模式：图 67.2.3.1中R111这一个 49.9K的电阻，默认将 USB_OTG1_ID线拉高，前面我们讲了，当 ID 线为高的时候就表示 OTG 工作在从机模式。此时由于 USB_OTG1_ID为高电平，因此 MOS1(SI2302)导通，因此 MT9700HT5的EN脚就接地，此时 MT9700HT5的OUT引脚就没有输出，所以 USB_OTG_VBUS电压关闭。USB_OTG_VBUS电压用于在OTG 做 HOST 功能的时候，向外部设备提供 5V 电源。很明显，在 OTG 做从机的时候，OTG就不需要向外界提供 USB_OTG_VBUS电源了。这里使用 MT9700HT5这个芯片来实 VBUS电源的开关控制。

主机**(HOST)**模式：如果要使用 OTG 的 HOST 功能，那么必须要使用到 Type-C OTG 线。**Type-C OTG线会将CC1和CC2拉低**，因此USB_OTG1_ID线也会被拉低，当ID线为0的时候就表示 OTG 工作在主机模式。此时由于 USB_OTG1_ID 为低，因此 MOS1(SI2302)不导通，因此 MT9700HT5 的 EN 脚就会被 R31 这个 10K 电阻上拉到 5V，所以 MT9700HT5 的 OUT引脚就会输出5V电压，也就是说USB_OTG_VBUS此时是5V，可以向外部设备提供5V电源。

## 使用

使能

```
-> Device Drivers
  -> HID support
    -> HID bus support (HID [=y])
      -> <*> Generic HID driver //使能通用HID驱动
      
-> Device Drivers
  -> HID support
    -> USB HID support
      -> <*> USB HID transport layer //USB键盘鼠标等 HID设备驱动
```

HID设备里面包括鼠标键盘等

使能U盘

```
-> Device Drivers
  -> SCSI device support
    -> <*> SCSI disk support //选中此选项
```

### otg从机

USB 设备驱动，按照设备端关联的 USB 控制器 是工作在 主模式 还是 从模式，分为 USB 设备主机侧驱动 (主模式驱动)，或者 USB 设备从机侧驱动 (从模式驱动)。同时，工作在 主模式 的 USB 控制器，称为 USB 主机控制器 (UHC: USB Host Controller)，工作在 从模式 的 USB 控制器，称为 USB 设备控制器 (UDC: USB Device Controller)。有的 USB 控制器，只能工作在 主模式 或 从模式 中的某一种；而有的则既可以工作在 主模式，也可以工作在 从模式，模式通过 OTG 切换。当然，在同一时刻，USB 控制器 要么工作在 主模式，要么工作在 从模式。

 Linux 下将 USB 设备从机侧驱动 ，称为 `USB Gadget` 驱动。USB Gadget 驱动 是通过 USB 来模拟其它类型的设备，如 USB Gadget UAC 驱动 用来模拟声卡外设；USB Gadget Serial 驱动 用来模拟串口外设，等等等等。这里所谓模拟，是指通过 USB 来模拟这些设备的行为，而这些对于连接对端的 USB 主机 是透明的。对于 USB Gadget 驱动 ，类似于 U 盘设备的固件，但它们并不完全等同，因为毕竟只是通过 USB 模拟设备行为。

#### 模拟U盘

```
-> Device Drivers
  -> SCSI device support
    -> <*> SCSI disk support //选中此选项, U盘使用SCSI协议

-> Device Drivers
  -> USB support (USB_SUPPORT [=y])
    -> USB Gadget Support (USB_GADGET [=y]
      -> [M]USB Gadget Drivers (<choice> [=m]) //选中 USB Gadget驱动
        ->[M]Mass Storage Gadget //大容量存储
```

将驱动编译为模块, 重新编译Linux内核，会得到三个.ko驱动模块

```
drivers/usb/gadget/libcomposite.ko
drivers/usb/gadget/function/usb_f_mass_storage.ko
drivers/usb/gadget/legacy/g_mass_storage.ko
```

```bash
depmod
modprobe libcomposite.ko
modprobe usb_f_mass_storage.ko
modprobe g_mass_storage.ko file=/dev/sda1 removable=1
# 退出操作
rmmod g_mass_storage.ko
```

在linux下面的文件系统一般是ext4的格式, windows是不可以识别的, 所以可以使用一个U盘模拟

#### 模拟声卡

```
-> Device Drivers
  -> USB support (USB_SUPPORT [=y])
    -> USB Gadget Support (USB_GADGET [=y]
      -> [M]USB Gadget Drivers //选中USB Gadget驱动
        ->[M] Audio Gadget //选中音频
          ->UAC 1.0 (Legacy) //选中UAC
```

使用的模块有三个

```
drivers/usb/gadget/libcomposite.ko
drivers/usb/gadget/function/usb_f_uac1.ko
drivers/usb/gadget/legacy/g_audio.ko
```

全部加载即可模拟声卡
