# Uboot启动

## 第二阶段

![image-20251009223704936](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510092237979.png)

### board_init_r函数

运行init_sequence_r里面的成员函数

```c
staticinit_fnc_t init_sequence_r[]= {
    initr_trace, /*初始化与跟踪调试相关部分*/
    initr_reloc, /*标记重定位完成*/
    initr_caches, /*使能cache*/
    initr_reloc_global_data, /*初始化重定位后的gd成员*/
    initr_barrier, /*imx6ull未用到*/
    initr_malloc, /*初始化malloc*/
    log_init, /*log初始化*/
    initr_bootstage, /*Needsmalloc() buthasitsowntimer*/
    initr_console_record, /*初始化控台*/
    bootstage_relocate,
    initr_dm, /*设备模型初始化, 加载设备树, 
    		绑定根节点到 gd->dm_root 中
    		获取soc下面的clocks节点以及firmware节点*/
    board_init, /*板级初始化*/
    efi_memory_init, /*efi_memory初始化*/
	stdio_init_tables, /*标准输入输出及标准错误等初始化*/
	initr_serial, /*串口初始化*/
	initr_announce, /*跟调试相关*/
	power_init_board, /*电源芯片初始化*/
	initr_nand, /*nandflash初始化*/
	initr_mmc, /*mmc初始化*/
	initr_env, /*环境变量初始化 => env_relocate => env_load*/
	initr_secondary_cpu, /*其他cpu初始化，由于imx6ull为单核cpu故忽略*/
	stdio_add_devices, /*输入输出设备初始化*/
	initr_jumptable, /*初始化跳转表*/
	console_init_r, /*控制台初始化*/
	interrupt_init, /*中断初始化*/
	initr_enable_interrupts, /*中断使能*/
	/* PPC has audelay(20)here datingfrom2002.Why?*/
	initr_ethaddr, /*网络初始化*/
	board_late_init, /*板子后续初始化*/
	initr_fastboot_setup,
	initr_net, /*网络初始化*/
	initr_check_fastboot,
	run_main_loop, /*运行主循环*/
};
```

run_main_loop => main_loop

#### bootdelay_process

环境变量中搜索bootdelay这个环境变量（字符串形式），如果有配置该环境变量则会将字符串转换成长整型数值

从环境变量中获取bootcmd

若stored_bootdelay!=-1，且bootcmd有值，同时在启动过程中没有检测到任何 打断启动过程的输入，则运行启动命令列表run_command_list中的一系列命令,即默认的 bootcmd命令，其中stored_bootdelay会在abortboot函数主每过一秒钟减1

如果我们在启动倒计时bootdelay减为0之前 按下了按键打断其自启动过程，就会进入cli_loop函数，此函数负责不断循环检测并处理 用户输入的命令

## 加载内核

因为内核是要运行在 DDR中的，因此就要将内核重定位到DDR中。前面我们讲了很多环境变量、设备树等，这些都 要传递给linux内核，Linux会读取这些参数，并且根据这些参数进行配置

对于linux内核而言， 这就不一样了，他需要u-boot帮他搭建好内核运行所必须的环境，配置各种寄存器，和硬件紧密 联系的是u-boot，而Linux地重定位也是由u-boot完成

是u-boot可以 从3个地方获取linux内核，如NAND启动/EMMC启动、SD卡启动、USB启动等。我们开发板 上板载了启动方式选择地拨码开关，根据下面表格设置拨码开关就可以实现从不同介质中加载 Linux 内核到DDR中运行, ，imx6ull在启动内核前会判断启动引脚地电平状态，根据启动引脚地 电平状态选择不同的启动方式

不管是那种启动方式，最终都要将内核镜像加载到DDR中运行，当使用网络（tftp与nfs）启动时，还应该在u-boot的命令终端上配置相应的环境变量，如本机ip、服务器ip、网关、子网掩码 等，特别提示：需要设置板子ip与服务器ip在同一个网段上才可以实现网络数据访问

当u-boot执行bootcmd的命令后，最终会调用do_bootz函数启动Linux内核
