# 备份量产

![image-20251002180401679](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510021804743.png)

## 备份

### fire-config

1. 首先需要准备一张空 白的 sd 卡，将sd卡插入到板子上并重启开发板。使用lsblk可看到用于演示的sd卡大小
2. 在`sudo fire-config`里面进行设置
3. Advanced => SD Burning

### 命令行

需要使用到两张SD卡，一张空白的SD镜像，一张装有系统镜像，同时需要板子支 持SD卡启动

1. 在需要备份的开发板中插入装有系统的SD卡，选SD卡启动。 
2. 将空白SD卡通过读卡器插到开发板上。
3. 将开发板的内容备份到空白SD卡上。



## SD卡文件打包

### Ubuntu

1. 将已经搭建好环境的SD卡从开发板取出并插到读卡器上，然后将读卡器接入PC机（ubuntu 中），在桌面版本的ubuntu中会自动挂载SD卡的内容

可以使用`df -h`查看镜像的大小

2. 使用mkdir命令创建一个新的目录，用于存放从带镜像的SD卡中拷贝的镜像。然后使用 dd 命令将带镜像的SD中的镜像拷贝到新创建的目录中

```bash
# 创建新目录
mkdir image_backup
 # 将带镜像的 SD 卡中的镜像拷贝到创建的目录中
sudo dd if=/dev/sdb of=./image_backup/imx6ull_backup.img count=1100 bs=1024k conv=sync
```

> + if= 文件名：输入文件名，缺省为标准输入。即指定源文件。
> + of= 文件名：输出文件名，缺省为标准输出。即指定目的文件。< of=./image_backup/imx6ull_bakcup.img, 这里的.img 是镜像的格式，转成.img格式的文件后方便后续使用etcher烧录镜像>
> + bs=bytes：同时设置读入/输出的块大小为bytes个字节，此处填的是1024，表示1M大小
> + count=blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数，此处设置的是1100，表示1100个bs，也就是1100M
> + conv= sync：将每个输入块填充到ibs个字节，不足部分用空（NUL）字符补齐
>
> 若备份的镜像烧录后仍无法正常运行，请将 bs=1024k 改为 bs=1M 并去 掉conv 参数, 即 `sudo dd if=/dev/sdb of=./image_backup/imx6ull_backup.img count=1100 bs=1M`

得到img文件后，就可以将这个img文件烧录到其它卡上了

### Win

 https://win32diskimager.org/

在windows下新建一个空文件，后缀为img，例如backup.img，将需要备份镜像的SD卡插到 windows 上并打开Win32磁盘映像工具，然后点击文件夹图标，找到刚刚创建的backup.img 文件并确认，并确认SD卡盘符，取消“仅读取已分配区”的勾选，最后点击读取按钮，如 果弹出是否覆盖backup.img的对话框，点击是

![image-20251002195010084](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202510021950131.png)

## 根文件系统备份

### 使用脚本

执行野火提供的系统备份脚本，该备份脚本已经在野火最新发布的系统 镜像中提供，具体路径为`/opt/scripts/tools/backup/backup_rootfs.sh`

`sudo /opt/scripts/tools/backup/backup_rootfs.sh /dev/sda`

```bash
#!/bin/bash -e
# 设置脚本执行错误和退出时应当执行的函数，这里主要是卸载和删除临时挂载目录
_exit_trap() {
    umount ${tmp_rootfs_dir}
    rmdir ${tmp_rootfs_dir}
}

_err_trap() {
    umount ${tmp_rootfs_dir}
    rmdir ${tmp_rootfs_dir}
}
# 判断系统是否安装了exfat-fuse和exfat-utils两个工具包为方便
# 在windows 平台上从u盘拷贝出根文件系统，u盘应当格式化为exfat文件系统，该文件系
# 统格式可以直接被windows平台识别。但是，在linux系统中挂载和格式化exfat文件系统，
# 则需要使用上面的两个工具。如果系统未安装这两个工具包，应该使用apt工具进行安装
dpkg -l | grep exfat-fuse || deb_pkgs="${deb_pkgs}exfat-fuse "
dpkg -l | grep exfat-utils || deb_pkgs="${deb_pkgs}exfat-utils "

if [ "${deb_pkgs}" ] ; then
    echo "Installing: ${deb_pkgs}"
    sudo apt-get update
    sudo apt-get -y install ${deb_pkgs}
fi
# 设置u盘挂载时使用的临时文件夹
tmp_rootfs_dir=/mnt/rootfs_backup
# 判断执行脚本的传参，这里需要传入u盘相关设备文件
if [ $# -gt 0 ]; then
        DEV="$1"
else
    echo "please input a storage device!"
    exit 0
fi
# 以exfat格式化u盘设备
mkfs.exfat -n rootfs $DEV
# 捕捉脚本执行错误和退出的信号，如果捕捉成功，则执行相应处理函数
trap _exit_trap EXIT
trap _err_trap ERR

if [ ! -d ${tmp_rootfs_dir} ] ; then
    mkdir ${tmp_rootfs_dir}
fi

mount -t exfat $DEV $tmp_rootfs_dir
# 用tar工具打包当前根文件系统。注意，当前系统目录有一系列虚拟文件系统和
# 临时文件，用户无需备份，用–exclude参数排除这部分目录和文件即可。打包得到的根文件
#系统命令为rootfs.tar
tar -cvf ${tmp_rootfs_dir}/rootfs.tar --exclude={/dev/*,/proc/*,/sys/*,/tmp/*,/run/*,/mnt/*,/media/*,/lost+found,/boot} /*

cd /boot

tar -cvf ${tmp_rootfs_dir}/boot.tar .

cd -
```

系统备份成功后，拔下u盘，查入到windows电脑上，可查看到rootfs.tar与boot.tar文件分别对应系统根文件系统和/boot分区的两个文件