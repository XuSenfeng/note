# 镜像文件

## boot ROM文件

选择一下内部的启动方式, 启动boot ROM程序

+ 初始化时钟以及外部DDR3

> DDR3是一种计算机内存（随机存取存储器，DRAM）的类型，全称为“Double Data Rate 3 Synchronous Dynamic Random-Access Memory”。它是DDR系列内存的第三代技术，广泛用于台式机、笔记本电脑和服务器中。

+ 从外部的存储介质加载代码

> + 空偏移: 实际的代码的偏移位置, 和不同的存储介质有关
> + Image vector table: 记录关键数据的位置, IVT表, 记录Boot Data数据以及Device Configeration Data两个的位置
> + Boot data: 启动数据, 镜像的加载地址以及大小
> + Device Configeration Data: 记录代码的外设寄存器配置信息, 时钟以及DDR3的配置
> + bin: 实际的程序
>
> 启动的时候首先获取一下Image vector table的信息

![image-20250712191220612](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507121912720.png)

空偏移, 不同介质不同, 第一次读取的大小也不同

![image-20250712191354310](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507121913350.png)

IVT表

![image-20250712191526735](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507121915797.png)

header: 表的长度

entry: 代码的入口

dcd: dcd数据的位置

self: 自己的位置

![image-20250712191707037](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507121917088.png)

![image-20250712202052912](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122020969.png)

Header记录大小以及版本

![image-20250712202154430](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122021517.png)

Tag: DCD命令, 一般是写寄存器

Length: 命令的大小

Parameter: 写寄存器的方法(写值, 清除, 设置位)

Address: 寄存器地址

Value: 具体的值

## 烧录方法

这里使用官方的SDK镜像文件进行测试

他的SDk工具里面可以在bin文件上面加入上一章提到的数据结构

[Applications Processors with Power-Efficient ARM Cortex-A7 | NXP Semiconductors](https://www.nxp.com/products/i.MX6ULL?&tab=Design_Tools_Tab&)

![image-20250712204339487](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122043555.png)

![image-20250712211439833](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122114873.png)

可以使用`tools/imgutil`工具进行

![image-20250712212323469](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122123532.png)

![image-20250712212740426](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122127467.png)

```bash
#!/bin/bash
# 帮助信息
function usage()
{
  echo "Usage: $0 target"
  echo "       target: ram -- the image will be loaded to RAM and run, the application must be built with ram link file"
  echo "       target: flash -- the image will be run on flash directly, the application must be build with flash link file"
  echo "       target: sd -- the image will be loaded from SD to RAM and run, the application must be build with ram link file"
  echo "Example: $0 ram"
}
# 参数不匹配的时候
if [ "$#" -ne 1 ]; then
  usage $0
  exit 1
fi
# 获取一下实际的系统
SYSTEM=`uname -s`
if [ $SYSTEM == "Linux" ]; then
    DCD_BUILDER=dcdgen.bin
    IMG_BUILDER=imgutil.bin
else
    DCD_BUILDER=dcdgen.exe
    IMG_BUILDER=imgutil.exe
fi
# dcd.config是寄存器的配置, 生成bin文件
../bin/$DCD_BUILDER dcd.config dcd.bin
# 不同的设备使用不同的配置
if [ "$1" == "ram" ]; then
    ../bin/$IMG_BUILDER --combine base_addr=0x80000000 ivt_offset=0x1000 app_offset=0x2000 dcd_file=dcd.bin app_file=sdk20-app.bin ofile=sdk20-app.img image_entry_point=0x80002000
elif [ "$1" == "flash" ]; then
    ../bin/$IMG_BUILDER --combine base_addr=0x60000000 ivt_offset=0x1000 app_offset=0x2000 dcd_file=dcd.bin app_file=sdk20-app.bin ofile=sdk20-app.img image_entry_point=0x60002000
elif [ "$1" == "sd" ]; then
    ../bin/$IMG_BUILDER --combine base_addr=0x80000000 ivt_offset=0x400 app_offset=0x2000 dcd_file=dcd.bin app_file=sdk20-app.bin ofile=sdk20-app.img image_entry_point=0x80002000
else
    echo "Unsupported target $1"
    usage $0
fi
```

野火重新这部分, 加入烧录部分

```bash
#!/bin/bash

function usage()
{
  echo "Usage: $0 file"
  echo "	file : the image which you want to burn "
  echo "Example: $0 helloworld.bin"
}
# 根据使用的用户, 如果是root报错
cur_user=`env | grep USER | cut -d "=" -f 2`
echo $cur_user
if [ $cur_user == "root" ]; then
	echo -e "\033[31mThe cur_user is $cur_user. Please run the script with a normal user.\033[0m"
	exit 1
fi 

if [ "$#" -ne 1 ]; then
  usage $0
  exit 1
fi




SYSTEM=`uname -s`
if [ $SYSTEM == "Linux" ]; then
    DCD_BUILDER=dcdgen.bin
    IMG_BUILDER=imgutil.bin
else
		exit 1
fi


cat /proc/partitions
while true
do
# 读取实际的SD卡路径
read -p "Please Input the card ID [a~z]: (Input 'exit' for quit):" dev_index
    case $dev_index in  
    [[:lower:]]) break
    ;;
    exit) exit 0
    ;;

    * ) echo -e "\033[31mInvalid parameter!\033[0m"
				echo -e "\033[31mThe parameter should be between a~z, enter 'exit' to quit.\033[0m"
				echo -e "\033[34mUsage: If the SD card device corresponds to /dev/sdd, enter d\033[0m"
		continue
    ;;

    esac  
done
sd_idnex=sd$dev_index
echo $sd_index
# 查看磁盘是不是存在
if [ ! -e /dev/$sd_idnex ]; then 
	echo "mkimage : /dev/$sd_idnex : No such file or directory"
	exit 1
fi
# 查看一下程序是不是可以执行
if [ ! -x $DCD_BUILDER ]; then
	chmod +x $DCD_BUILDER
fi

if [ ! -x $IMG_BUILDER ]; then
	chmod +x $IMG_BUILDER
fi

./$DCD_BUILDER dcd.config dcd.bin
./$IMG_BUILDER --combine base_addr=0x80000000 ivt_offset=0x400 app_offset=0x2000 dcd_file=dcd.bin app_file=$1 ofile=sdk20-app.img image_entry_point=0x80002000
# 下载
sudo dd if=sdk20-app.img of=/dev/$sd_idnex bs=512 conv=fsync

```

> 1. **`--combine`**
>     指定操作模式为"组合"，表示将多个组件合并成一个完整镜像
> 2. **`base_addr=0x80000000`**
>     - 内存加载基地址（Load Address）
>     - 表示镜像将被加载到内存的 `0x80000000` 位置
>     - 这是 i.MX6ULL 的 DDR SDRAM 起始地址
> 3. **`ivt_offset=0x400`**
>     - IVT（中断向量表）在镜像中的偏移量
>     - 计算实际内存地址：`0x80000000 + 0x400 = 0x80000400`
>     - IVT 是 i.MX 启动过程的核心数据结构
> 4. **`app_offset=0x2000`**
>     - 应用程序在镜像中的偏移量（8KB 位置）
>     - 计算实际内存地址：`0x80000000 + 0x2000 = 0x80002000`
>     - 这是应用程序代码的起始位置
> 5. **`dcd_file=dcd.bin`**
>     - DCD（设备配置数据）文件路径
>     - 包含 DDR 控制器、时钟等外设的初始化配置
>     - 由 BootROM 在启动阶段自动加载执行
> 6. **`app_file=$1`**
>     - 输入的应用程序二进制文件（通常是编译后的 `.bin` 文件）
>     - `$1` 表示脚本的第一个命令行参数
> 7. **`ofile=sdk20-app.img`**
>     - 输出的完整镜像文件名
> 8. **`image_entry_point=0x80002000`**
>     - 程序入口点地址
>     - 必须与 `app_offset` 计算出的地址一致：`0x80000000 + 0x2000`
>
> ### 生成的镜像结构：
>
> | 内存地址       | 偏移量 | 内容             | 大小   |
> | :------------- | :----- | :--------------- | :----- |
> | 0x80000000     | 0x0000 | 镜像起始         |        |
> | ...            | ...    | (填充区)         |        |
> | 0x80000400     | 0x0400 | **IVT 结构**     | 32字节 |
> | 0x80000420     | 0x0420 | **DCD 数据**     | 可变   |
> | ...            | ...    | (填充区)         |        |
> | **0x80002000** | 0x2000 | **应用程序代码** | 可变   |
> | ...            | ...    | 镜像结束         |        |

![image-20250712215445997](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122154054.png)

> 断开连接的SD卡识别到虚拟机里面
>
> ![image-20250712215525817](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507122155864.png)