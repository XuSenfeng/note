## 路由

Route路由, 是一种映射关系!!!**路由是把客户端请求的url地址和用户请求的应用程序**[这里意指django里面的视图]进行一对一绑定映射的一种关系。当然在项目中，我们常常说的路由一般是一个类。 这个类完成了路由要做的事情。

### 路由分层

经过上面的学习，我们可以发现，每次编写视图函数都需要到路由文件中进行url地址绑定，但是随着项目的开发，以后我们的视图函数肯定是越来越多的。

为了避免将来视图函数太多导致无法明确区分哪些路由属于哪一个子应用的。我们可以现在刚开始项目的时候，把路由代码放回到对应的各个子应用目录下，单独存放。这就是django提供的路由分层。

1. 在子应用home下创建子路由文件,一般路由文件名建议是`urls.py`
2. 把子应用home下面的视图绑定代码转到`home/urls.py

![image-20250725110846739](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507251108800.png)

![image-20250725111232536](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202507251112613.png)

### 路由原理

在django中所有的路由最终都被保存到一个变量 `urlpatterns.`, urlpatterns必须声明在主应用下的urls.py总路由中。这是由配置文件settings设置的ROOT_URLCONF指定的。

在django运行中，当客户端发送了一个http请求到服务端，服务端的web服务器则会从http协议中提取url地址, 从程序内部找到项目中添加到urlpatterns里面的所有路由信息的url进行遍历匹配。如果相等或者匹配成功，则调用当前url对应的视图方法。

在给urlpatterns路由列表添加路由的过程中,django一共提供了2个函数用于绑定路由与视图关系。

```python
from django.urls import path        # 普通路由
from django.urls import re_path   # 正则路由，会把url地址看成一个正则模式与客户端的请求url地址进行正则匹配
```

> 正则表达式里面的参数, 会作为函数参数一起传进来

```python
from django.urls import path, re_path
from . import views
urlpatterns = [
    # re_path(r"^info/(?P<参数名1>正则)/(?P<参数名2>正则).....$", views.info1),
    re_path(r"^info/(?P<id>\d+)/(?P<page>0[1-9]+)$", views.info1),
    re_path(r"^mobile/(?P<mobile>1[3-9]\d{9})$", views.info2),
]
```

### 路径问题

假设你的项目中定义了以下两个URL路由（在`urls.py`中）：

```
python# 不加斜杠
path('article', views.article_view),
# 加斜杠
path('article/', views.article_view),
```

#### 访问示例

- 用户访问 **`/article`**
- 用户访问 **`/article/`**

在Django的配置中，无论你定义哪个路由，Django都能“智能”地重定向到正确的视图（除非你有特殊的`APPEND_SLASH = False`配置）。这意味着两个URL都能访问到`article_view`。

#### 静态文件的相对路径问题

假设在你的HTML模板中，你引用静态文件如下：

```
<img src="images/logo.png" />
```

**此时，问题来了：**

- 如果你的页面路径是`/article`（没有尾斜杠）

- 相对路径`images/logo.png`会被解析为：

    ```
    /images/logo.png
    ```

    或者，如果你页面的完整路径是`/article`（没有尾斜杠），浏览器会尝试解析为：

    ```
    /article/images/logo.png
    ```

    这就很可能导致路径错误，尤其是在你的静态文件目录实际上是在根路径下（比如`/static/images/logo.png`），此时相对路径会引发404错误。

#### 加斜杠与不加斜杠的影响

- **加斜杠**：
    URL地址`/article/`中的相对路径`images/logo.png`会被解析为：

    ```
    /article/images/logo.png
    ```

    这通常不是你想要的（除非你的路径结构恰好如此），并且会导致静态文件路径不正确。

- **不加斜杠**：
    URL为`/article`，同样，静态文件路径会被相对解析为：

    ```
    /article/images/logo.png
    ```

    也可能错误（尤其当你希望静态文件在根目录或者特定静态目录时）。

#### 解决方案

- **推荐**：在静态文件路径或URL中使用绝对路径或模板标签（如`{% static 'images/logo.png' %}`），这样无论URL是否加尾斜杠，静态资源路径都不会出错。
- **在路由设计中**：避免在路由定义中依赖不加斜杠的特性，或者在模板中加上`/`前缀，确保路径不出错。

### 路由转换器

也可以叫路由验证器，有2个作用：

1. 把路由参数进行类型转换
2. 可以起到验证路由匹配的作用（让字符串路由path发挥正则路由re_path的作用）

```python
from django.urls import path

from . import views

urlpatterns = [
    path("articles/2003/", views.special_case_2003),
    path("articles/<int:year>/", views.year_archive),
    path("articles/<int:year>/<int:month>/", views.month_archive),
    path("articles/<int:year>/<int:month>/<slug:slug>/", views.article_detail),
]
```

下面的路径转换器在默认情况下是有效的：

- `str` - 匹配除了 `'/'` 之外的非空字符串。如果表达式内不包含转换器，则会默认匹配字符串。
- `int` - 匹配 0 或任何正整数。返回一个 `int` 。
- `slug` - 匹配任意由 ASCII 字母或数字以及连字符和下划线组成的短标签。比如，`building-your-1st-django-site` 。
- `uuid` - 匹配一个格式化的 UUID 。为了防止多个 URL 映射到同一个页面，必须包含破折号并且字符都为小写。比如，`075194d3-6885-417e-a8a8-6c931e272f00`。返回一个 [`UUID`](https://docs.python.org/3/library/uuid.html#uuid.UUID) 实例。

> str包含UUID, 所有在使用的时候str写在后面

- `path` - 匹配非空字段，包括路径分隔符 `'/'` 。它允许你匹配完整的 URL 路径而不是像 `str` 那样匹配 URL 的一部分。

#### 自定义转换器

 在当前子应用下新建`converters.py`下编写的，这里是我们刚学习，所以为了方便直接在路由urls.py下编写，代码：

```python
from django.urls.converters import StringConverter, register_converter


class MobileConverter(StringConverter):
    regex = r"1[3-9]\d{9}" # 匹配使用的表达式, 这里是匹配一个电话号


# register_converter(路由转换类, "调用别名")
register_converter(MobileConverter, "mob")
```

可以使用` path("sms/<mob:mobile>", views.info5),`