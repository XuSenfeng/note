---
layout: post
title: "异常处理机制" 
date:   2024-8-4 15:39:08 +0800
tags: RISC-V
---

# 异常处理机制

![image-20240804172035813](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041720858.png)

分析该表可知：每种异常有一个唯一的编号，编号从0开始，interrupt字段表明该类型的异常是否是外设中断。另外，同步/异常指明：

+ 同步”是指可以准确地定位到某一条执行的指令，例如一条 ebreak 或 ecall 指令，每次执行到该指令均会触发进入异常。
+ 异步”是指不能准确定位于某条指令，每次异常发生时的指令PC 值有可能不同。
+ “精确异步”是指异常发生后可以精确地定位到某一条指令的边界，即某条指令执行之后的状态，例如外部的中断。
+ 而“非精确异步”是指无法精确定位到某一条指令的边界，有可能是某条指令执行了一半被打断后的状态，例如访存错误。访问存储器需要时间，微处理器访存时一般不会一直等待访存结束，而是继续执行指令，此时再出现访存错误异常时，微处理器已经执行了后续的指令，无法精确定位。

## 处理流程

青稞处理器中，异常处理流程如下所示，可以看到分三步：进入异常、执行异常处理程序、退出异常。

![image-20240804172243067](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041722098.png)

> 在发生异常的时候会通过中断向量表进入处理程序, 使用CSR寄存器记录信息, 同时进入机器模式

### 相关寄存器

在实际处理的时候, 会使用mtvec寄存器里面记录的向量表的位置

![image-20240804174120153](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041741196.png)

> 统一的入口地址的时候, 所有的函数使用同一个函数进行处理

![image-20240804174511414](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041745448.png)

![image-20240804174432941](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041744967.png)

当进入异常或中断时，微处理器会自动更新相关的 CSR 寄存器，包括机器模式异常原因寄存器 mcause、机器模式异常指针寄存器 mepc、机器模式异常值寄存器 mtval、机器模式状态寄存器 mstatus

+ 更新 mcause

当进入异常或中断时，微处理器会自动更新相关的 CSR 寄存器，包括机器模式异常原因寄存器 mcause、机器模式异常指针寄存器 mepc、机器模式异常值寄存器 mtval、机器模式状态寄存器 mstatus。

![image-20240804175342469](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041753500.png)

> 低位为异常编码，用于指示具体的原因。

+ 更新 mepc

标准定义退出异常或中断后微处理器的返回地址保存在 mepc 中。所以当发生异常或中断后，硬 件自动更新 mepc 值为当前遇到异常时的指令 PC 值，或中断前下一条预执行的指令 PC 值。异常或中 断处理结束后，微处理器使用其保存的值作为返回地址，回到中断的位置继续执行。

![image-20240804175428671](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041754705.png)

> .mepc 是一个可读可写的寄存器，软件也可以修改该值，达到修改返回后运行的 PC 指针位置的 目的。
>
> 当发生中断时，即异常原因寄存器 mcause[31]=1 时，mepc 的值更新为中断时下一条未执行的 指令 PC 值。
>
> 而发生异常时，异常原因寄存器 mcause[31]=0 时，mepc 的值更新为当前异常的指令 PC 值。因 此这时异常返回时，如果直接使用 mepc 的值返回，还是继续执行之前产生异常的指令，此时还会继 续进异常。通常我们处理好异常后，可以修改 mepc 的值为下一条未执行指令的值后再返回。例如我 们因 ecall/ebreak 引起异常，处理异常后，由于 ecall/ebreak（c.ebreak 为 2 字节）为 4 字节指令， 此时只需要软件修改 mepc 的值为 mepc+4(c.ebreak 为 mepc+2)后返回即可。

+ 更新 mtval
![image-20240804175514294](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041755322.png)

进入异常和中断时，硬件将自动更新 mtval 的值，该值即为引起异常的值。该值一般是：

1. 如果存储器访问引起的异常，硬件会将异常时存储器访问的地址存入 mtval。
2. 如果是非法指令引起的异常，硬件会将该指令的指令编码存入 mtval。
3. 如果是硬件断点引起的异常，硬件会将断点处 PC 值存入 mtval。
4. 对于其他的异常，硬件将 mtval 的值设为 0，例如 ebreak，ecall 指令引起的异常。
5. 进入中断时，硬件将 mtval 的值设为 0。

+ 更新 mstatus
![image-20240804175559244](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041755283.png)

> FS 域用于描述和维护浮点单元状态，所以该域只有在含有硬件浮点功能的青稞 V4F 微处理器上 才有意义。当其值为 0 时，表示浮点单元为关闭状态，且如果此时使用浮点指令，将触发异常；若其 值为 1 或 2，当执行了浮点指令后，该域会被更新为 3。若用户在使用 V4F 微处理器时，不期望使用 硬件浮点功能，可在机器模式下，手动清除该两位，以关闭硬件浮点并降低功耗。 MPP 域用于保存进入异常或中断前的特权模式，用于退出异常或中断后的特权模式恢复，MIE 为 全局中断使能位，当进入异常或中断时，MPIE 的值被更新为 MIE 值，需要注意的是青稞 V4 系列微处 理器中，在最后一级嵌套中断前 MIE 不会被更新为 0，以保证机器模式下的中断嵌套继续执行。当退 出异常或中断后，微处理器恢复为 MPP 保存的机器模式，并且 MIE 恢复为 MPIE 的值。 青稞 V4 微处理器支持机器模式和用户模式，若需要使微处理器仅工作在机器模式，可在启动文 件的初始化中把 MPP 设置为 0x3，即返回后，始终保持在机器模式。

进入异常和中断时，硬件会更新 mstatus 中的某些位：

1. MPIE 更新为进入异常和中断前的 MIE 值，异常和中断结束后，MPIE 用于恢复 MIE。
2. .MPP 更新为进入异常和中断前的特权模式，异常和中断结束后，MPP 用于恢复之前的特权模式。
3. 青稞 V4 微处理器支持机器模式下的中断嵌套，进入异常和中断后，MIE 不会被清零。

### 实际获取

可以使用封装好了的函数

```c
void HardFault_Handler(void)
{
  uint32_t mcause = __get_MCAUSE();
  printf("mcause = %d\r\n", mcause);
  while (1)
  {
  }
}
```

在处理的最后使用mret进行返回, 这一个会使用mepc更新PC寄存器, 更新一下CS寄存器以及工作模式

在写这一个中断处理函数的时候如果使用的是C语言, 需要使用

使用硬件压栈的中断函数需要使用 MRS 或者其提供的工具链进行编译且中断函数需要采用 `__attribute__((interrupt("WCH-Interrupt-fast")))`声明。

.使用软件压栈的中断函数采用`__attribute__((interrupt()))`声明。

![image-20240804182522941](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041825971.png)

![image-20240804182757318](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041827358.png)

> 使用"WCH-Interrupt-fast"的时候会改变这一个函数的返回指令, 使用interrupt()为空的时候会加上一系列的压栈以及出栈指令, 青稞v4可以使用硬件实现这一个功能
>
> 硬件压栈支持嵌套，嵌套深度最大为 3 级。硬件压栈溢出后，若仍然允许更高优先级 的中断执行，则“现场”被保存至用户堆栈区。
>
> 使用INTSYSCR寄存器进行控制
>
> ![image-20240804183317394](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408041833448.png)