---
layout: post
title: "调试" 
date:   2024-1-18 15:39:08 +0800
tags: Cotex-M3
---

# 调试

## 简介

### 侵入式调试

1. 停机以及单步执行程序
2. 硬件断点
3. 断点指令（BKPT）
4. 数据观察点，作用于单一地址、一个范围的地址，以及数据的值。
5. 访问寄存器的值（既包括读，也包括写）
6. 调试监视器异常
7. 基于ROM的调试（闪存地址重载(flash patching) ）

### 非侵入式调试

1. 在内核运行的时候访问存储器
2. 指令跟踪，需要通过可选的嵌入式跟踪宏单元（ETM）
3. 数据跟踪
4. 软件跟踪（通过ITM（指令跟踪单元））
5. 性能速写（profiling）（通过数据观察点以及跟踪模块）

CM3的调试系统基于ARM亲手打造且吐血推荐的“CoreSight（内核景象）”调试架构

## CoreSight技术概览

### 处理器调试接口

以前的ARM处理器都提供JTAG接口，通过它来控制对寄存器和存储器的访问。在CM3中全变了——对处理器上总线逻辑的控制使用另外的总线接口，即通过所谓的“调试访问端口(DAP)”。

把JTAG或串行线协议都转换成DAP总线接口协议，再控制DAP来执行调试动作。

CM3支持两种调试主机接口（debug host interface）:第一个是广为使用的JTAG接口，另一个则是新的“串行线(Serial Wire, SW)调试接口”。

 CM3主要针对低成本的单片机市场。单片机往往没有很富裕的管脚资源。而JTAG协议需要使用4根脚，而SW则只需要两根。

### DP模块, AP模块和DAP模块

![image-20240119200941923](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192009188.png)

通过DP接口模块（通常是SWJ  -DP或SW -DP），先把外部信号转换成一个通用的32位调试总线信号（图表中的DAP总线）

SWJ  -DP支持SW与JTAG两种协议，而SW -DP则只支持SW。

CoreSight产品中还可以使用一种JTAG   -DP，它只支持JTAG协议。

DAP总线上的地址是32位的，其中高8位用于选择访问哪一个设备，由此可见，最多可以在DAP总线上面挂256个设备。 在CM3处理器的内部，只用掉了一个设备的地址，还剩下的255个都可以用于连接访问端口（AP）到DAP总线上

在把数据从DAP接口传递给CM3处理器后，下一步就连接到了一个称为“AHB-AP”的AP设备上，它相当于一个总线桥，用于把DAP总线的命令转换为AHB总线上的数据传送，再插入到CM3内部的总线网络中。这么一来，CM3的整个寻址空间就都在覆盖范围之内了，连NVIC中的调试控制寄存器组也包括在内。

在CoreSight系列产品中，AP设备可以有好几种类型，包括APB  -AP和JTAG   -AP。APB-AP顾名思义，是用于产生APB总线数据传送动作的，而JTAG   -AP则用于控制传统的、基于JTAG的测试接口，例如ARM7上的调试接口

### 跟踪接口

1. 指令跟踪：由ETM（嵌入式跟踪宏单元）产生
2. 数据跟踪：由DWT产生
3. 调试消息：由ITM产生，提供形如printf的消息输入，送到调试器的GU I中

尽管在CM3中拥有多个跟踪源，但CM3内建了一个归并硬件, 跟踪输出接口可以直接连接到专为CM3设计的TPIU上，然后就可以供PC控制的外部硬件捕捉仪来跟踪数据。

### 性质

CoreSight的调试设计有很多优势：

+ 即使在处理器运行时，也可以查看存储器和外设的寄存器的内容
+ 使用单一调试器，就可以控制多核系统的调试接口。例如，如果使用JTAG，则只需要一个TAP控制器，不管芯片中有几个处理机都一样。
+ 内部的调试接口是基于单总线的方式设计的，因此非常有弹性，也简化了为芯片的其它部分设计附加的测试逻辑。
+ 它使得多条“跟踪数据流”可以由单一的“跟踪捕获设备”来收集，送到PC机上之后再还原出先前的各条数据流。

CM3中的调试系统是基于CoreSight的，但是又有一些“变异”：

+ CM3的跟踪组件是重新设计的，有些在CM3中的ATB接口是8位的，而纯种的CoreSight的都是32位的。
+ CM3的调试系统没有实现TrustZone——ARM提供的一种技术，用于在嵌入式产品中提供安全特性。
+ 调试组件所需的空间挤到了系统的存储器映射中。而在标准的CoreSight系统中，是为调试总线另开了一个地址空间的。

![image-20240119202324513](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192023572.png)

![image-20240119202345402](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192023446.png)

## 调试模式

CM3中的调试操作模式分为两种。第一种称为“halt”（停机模式），在进入此模式时，处理器完全停止程序的执行。第二种则称为“debug monitor exception”（调试监视器模式），此时处理器执行相应的调试监视器异常服务例程，由它来执行调试任务，并且依然允许更高优先级的异常抢占它。调试监视器的异常号为12，优先级可编程。除了调试事件可以触发异常外，手工设置其悬起位也可以触发本异常

![image-20240119202745381](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192027424.png)

需要把NVIC调试停机控制及状态寄存器（DHCSR）的C_DEBUGEN位置位。这个位只能由调试器来设置，没有调试器是不能把CM3停机的。在C_DEBUGEN置位后，就可以设置DHCSR.C_HALT位来喊停处理器。此C_HALT位可以由软件置位。

试停机控制及状态寄存器DHCSR（地址：0xE０00_EDF0）

![image-20240119202924707](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192029761.png)

DHCSR中的控制位是在上电复位时得到复位的。系统复位（例如，往NVIC应用程序中断及复位寄存器中写命令）不会影响到它们

正常情况下，只有调试器会操作DHCSR，应用程序不要乱动它，以免使调试工具出现问题。

调试及监视器控制寄存器DEMCR（地址：0xE０00_EDFC）

![image-20240119203100136](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202401192031192.png)















