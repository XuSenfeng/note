---
layout: post
title: "IAP技术" 
date:   2023-11-7 15:39:08 +0800
tags: stm32
---

**这个是B站"不烧板子"的视频学习记录,大部分笔记也是直接复制的**

# IAP技术

##  **ICP**: In-Circuit Programming

在电路中编程。使用厂家配套的软件或仿真器进行程序烧录，目前主流的有JTAG接口和SWD接口，常用的烧录工具为J-Link、ST-Link等。

## ISP: In-System Programing

在系统编程的时候, 以STM32为例, 内置了一个bootloader, 可以通过BOOT引脚电平来运行这一段程序, 再通过ISP编程工具下载进去, 下载之后更正BOOT到正常的状态使得MCU运行下载的程序

## IAP: In-Application  Programming

在应用中编程。IAP可以使用微控制器支持的任一种通信接口（如I/O端口、USB、CAN、UART、I2C、SPI等）下载程序或数据到FLASH中。IAP允许用户在程序运行时重新烧写FLASH中的内容。但需要注意，IAP要求至少有一部分程序（Bootloader）已经使用ICP或ISP烧到FLASH中。

![image-20231107121723850](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202311071217913.png)

无论是ICP技术还是ISP技术，都需要连接下载线，设置跳线帽等操作。一般来说，产品的电路板都会密封在外壳中，在这时若要使用ICP或ISP的方式对程序进行更新，则必然要拆装外壳，如果产品的数量比较多，将花费很多不必要的时间。

采用IAP编程技术，可以在一定程度上避免上述的情况。一般情况下，产品的外壳都会留有通信接口，若能通过这种通信方式对程序进行升级，则可以省去拆装的麻烦。在此基础上，若引入远距离或无线数据传输方案，更可以实现远程编程或无线编程。

## 2 IAP方案设计

### 2.1 IAP简介

IAP技术的核心在于BootLoader程序的设计，这段程序预先烧录在单片机中，正常的APP程序可以使用BootLoader程序中的IAP功能写入，也可以两部分代码一起写入，以后需要程序更新时通过IAP进行代码更新。每次板卡上电都会首先执行BootLoader程序，在程序内判断进行固件升级还是跳转到正常的APP程序。

![202311071223689.png](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202311071223689.png)

是否进行固件升级的判断可以从硬件和软件两个方面进行考虑。

1. 硬件实现：通过拨码开关、跳线帽等方式设定单片机某一引脚电平状态，程序通过读取引脚电平判断是否需要升级。此种方式需要接触板卡进行操作，当板卡被封闭在外壳中或安装于不便于操作位置时很难实现。
2. 软件实现-1：软件内设定一标志位（变量），通过判断标志位状态判断是否需要升级。该标志位状态掉电不能改变，故需要存储在外部EEPROM或单片机内部FLASH中。若存储在外部EEPROM，则需要增加额外的电路；若存储在单片机内部FLASH，由于FLASH每次写入都需要擦除一整页，会造成资源浪费。
3. 软件实现-2：单片机每次上电首先进入BootLoader程序，在BootLoader中等待一定时间，若上位机软件在该时间段内发起通讯，则停留在BootLoader程序中等待固件升级；若该时间段内无通讯，则跳转到正常的APP程序。该方式每次上电都要等待一定时间，需要考虑是否可以接受。
4. ……

在IAP过程中，单片机通过特定的通讯方式从上位机软件接收程序数据，并执行FLASH擦写操作对APP部分的程序进行更新。

IAP过程中传输的数据文件一般为后缀名为bin的文件，该文件内容与正常烧录进FLASH中的数据内容一致，便于程序升级。但是MDK软件并不能直接生成bin文件，需要进行一些配置。

![image-20231107122511789](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202311071225851.png)

```bash
fromelf.exe  --bin -o ..\OBJ\TIMER.bin ..\OBJ\TIMER.axf  //“TIMER”需要改成自己程序的名字
```

由于我把fromelf.exe所在目录添加到了环境变量，所以可以直接这样写。如未添加环境变量，则需要写清楚详细路径，该文件一般在MDK软件的安装目录下。

![image-20231107122932799](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202311071229840.png)

### 2.2 FLASH空间划分

BootLoader程序和APP 程序存放在 STM32 FLASH 的不同地址范围，一般从最低地址区开始存放 BootLoader，紧跟其后的就是 APP 程序。在FLASH足够大的情况下，还可以分配多个APP程序区域，便于恢复默认程序或者执行多段功能不同的程序。

