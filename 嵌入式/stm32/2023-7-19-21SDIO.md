---
layout: post
title: "SDIO" 
date:   2023-7-19 15:39:08 +0800
tags: stm32
---

# SDIO

## 协议简介

常见的SD卡可以使用两种模式的通讯, SPI或者SDIO模式

SD卡: 安全数字存储卡, 内存<=2GB叫做SD, 2GB<=内存<=32GB叫做SDHC, 32<=内存叫做SDXC, stm32最大支持32GB

SDIO: 安全数字输入输出接口, 可以驱动MMC卡, SD卡, SD I/O卡(接在一些设备上用于通讯, 不是存储器), CE-ATA设备是一种硬盘使用的, 是一种总线

### 物理结构

![image-20230719112332523](E:\a学习\笔记\img\image-20230719112332523.png)

实际上是NOR Flash, 以块进行读写, 根据命令进行读写

![image-20230719112749337](E:\a学习\笔记\img\image-20230719112749337.png)

>   内部的寄存器
>
>   CID: 每个厂商申请, 可以用于区分不同的SD卡
>
>   RCA: 实际上也可以用于区分设备
>
>   CSR: 判断卡的状态
>
>   SSR: 保存卡的信息

![image-20230719113154012](E:\a学习\笔记\img\image-20230719113154012.png)

>   协议可以连接多个, stm32只能连接一个

>   SD卡一共有9-pin, 三根电源线, 一根时钟线, 一根命令线, 四根数据线
>
>   CLK: 时钟线, 主机产生, 上升的时候有效
>
>   CMD: 命令控制线, SDIO发送命令控制SD卡, 命令应答的时候也是通过这条线
>
>   D0-3: 数据线, 传输读写数据, 可以吧D0拉低表示忙状态
>
>   V~DD~, V~SS1~, V~SS2~: 电源以及地

>   SD卡使用两种频率通讯, 一个是识别时候的频率FOD, 最高400KHz, 另一个是数据传输模式下的FPP默认25MHz, 最高50MHz

>   传输协议: 基于命令的, 先发送一个0, 结束的时候发送一个1, 有响应的命令返回数值

>   读写操作: 数据块一般为512字节, 需要CRC位保证数据传输成功, 硬件产生
>
>   ![image-20230719115905304](E:\a学习\笔记\img\image-20230719115905304.png)
>
>   在读之前需要检测忙标志
>
>   ![image-20230719120254087](E:\a学习\笔记\img\image-20230719120254087.png)
>
>   ![image-20230719120356780](E:\a学习\笔记\img\image-20230719120356780.png)
>
>   用于SSR寄存器

### 命令

广播命令: 对连接的所有的卡发出的信号

寻址命令: 包含卡的地址

+   命令格式

![image-20230719123550551](E:\a学习\笔记\img\image-20230719123550551.png)

>   固定48位, 传输标志是确定传输方向的
>
>   CRC算法计算进行校验
>
>   基本命令64个

![image-20230719124517148](E:\a学习\笔记\img\image-20230719124517148.png)

有一些扩展的命令, 特定应用命令, ACMD, 需要在发送之前发送CMD55, 之后发送ACMD命令, 如果发现不是ACMD, 执行标准命令

#### 实际的命令

![image-20230719125621779](E:\a学习\笔记\img\image-20230719125621779.png)

>   SDIO 总共有 7 个响应类型 (代号：R1~R7)，其中 SD 卡没有 R4、R5 类型响应。特定的命令对应 有特定的响应类型，比如当主机发送 CMD3 命令时，可以得到响应 R6。与命令一样，SD 卡的 响应也是通过 CMD 线连续传输的。根据响应内容大小可以分为短响应和长响应。短响应是 48bit 长度，只有 R2 类型是长响应，其长度为 136bit。各个类型响应具体情况如表 SD 卡响应类型 。

![image-20230719130207910](E:\a学习\笔记\img\image-20230719130207910.png)

>   读取sdsc地址以直接为单位, sdhc卡是块为地址

>   通过CMD7进行选定一张卡
>
>   擦除命令需要使用三个命令

### 操作模式

在初始化的时候有一个初始化模式, 叫做卡识别模式, 之后使用数据传输模式

stm32支持的模式是2.0, 使用的时候需要区分卡使用的模式且卡的容量需要区分

系统复位以后主机处于卡识别模式, 寻找可用的SDIO同时SD卡也处于卡识别模式, 直到被识别到, SD卡接收到SEND_RCA(CMD3)之后进入传输模式

![image-20230721152719980](E:\a学习\笔记\img\image-20230721152719980.png)

>   无效模式, 使用CMD15进入
>
>   空闲状态, CMD1
>
>   准备状态, 环境正常之后进入
>
>   识别状态, 可以接受命令
>
>   待机状态, 低功耗
>
>   传输状态, 读写之前
>
>   发送数据状态, 传输的时候
>
>   接收数据状态, 
>
>   编程状态, 这个是写入的时候, 传输的数据不一定立刻写入
>
>   断开连接状态, 换卡, 断开连接

![image-20230721161545433](E:\a学习\笔记\img\image-20230721161545433.png)

>   CMD8确认卡的状态

>   CMD41询问卡的信息

![image-20230721162125582](E:\a学习\笔记\img\image-20230721162125582.png)

## stm32的实现

SDIOCLK=72MHz

![image-20230721183344035](E:\a学习\笔记\img\image-20230721183344035.png)

使用两个时钟, 一个是SDIO适配时钟, 另一个是AHB总线时钟二分频, SDIO适配器时钟提供SDIO主机功能, 提供SD时钟, 发送命令进行数据交换, APB2接口用于访问器访问SDIO适配器并且可以产生中断和DMA

![image-20230721183807207](E:\a学习\笔记\img\image-20230721183807207.png)

>   输出的时钟可以使用两种, FIFO是一个32个字的存储单元, 使用DMA进行传输

![image-20230721184139651](E:\a学习\笔记\img\image-20230721184139651.png)

![image-20230721192352934](E:\a学习\笔记\img\image-20230721192352934.png)

+   SDIO_POWER: 电源控制寄存器

![image-20230721190317841](E:\a学习\笔记\img\image-20230721190317841.png)

+   SDIO_CLKCR: 时钟控制寄存器

![image-20230721190414369](E:\a学习\笔记\img\image-20230721190414369.png)

+   SDIO_ARG: 参数寄存器

![image-20230721190452248](E:\a学习\笔记\img\image-20230721190452248.png)

+   SDIO_CMD: 命令寄存器

![image-20230721190107858](E:\a学习\笔记\img\image-20230721190107858.png)

+   SDIO_RESPCMD: 命令响应寄存器

![image-20230721190552042](E:\a学习\笔记\img\image-20230721190552042.png)

+   SDIO_RESPx: 响应寄存器

![image-20230721190709273](E:\a学习\笔记\img\image-20230721190709273.png)

+   SDIO_DTIMER: 数据定时器寄存器

![image-20230721190745284](E:\a学习\笔记\img\image-20230721190745284.png)

+   SDIO_DLEN: 数据长度寄存器

![image-20230721190820520](E:\a学习\笔记\img\image-20230721190820520.png)

+   SDIO_DCTRL: 数据控制寄存器

![image-20230721190903000](E:\a学习\笔记\img\image-20230721190903000.png)

+   SDIO_DCOUNT: 数据计数器寄存器

![image-20230721190946068](E:\a学习\笔记\img\image-20230721190946068.png)

+   SDIO_STA: 状态寄存器

+   SDIO_ICR: 清除中断寄存器
+   SDIO_MASK: 中断屏蔽寄存器
+   SDIO_FIFOCNT: 计数器寄存器
+   SDIO_FIFO: FIFO寄存器











