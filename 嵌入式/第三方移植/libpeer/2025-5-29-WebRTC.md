# WebRTC

Web Real-Time Communication实时网络通信协议, 是一个P2P的实时通信, 点对点通信

WebRTC虽然冠以“web”之名，但并不受限于传统互联网应用或浏览器的终端运行环境。实际上无论终端运行环境是 浏览器、桌面应用、移动设备（Android或iOS）还是IoT设备，只要IP连接可到达且符合WebRTC规范就可以互通。 这一点释放了大量智能终端（或运行在智能终端上的app）的实时通信能力，打开了许多对于实时交互性要求较高的 应用场景的想象空间，譬如在线教育、视频会议、视频社交、远程协助、远程操控等等都是其合适的应用领域。

+ 点对点视频聊天
+ 多人在线会议
+ 直播

可以实现两个客户端之间之间通信, , 只需要服务器交换一部分数据

1. 如何发现对方, 双方需要交换一部分媒体信息, 网络数据(信令signaling), 有一个信令服务器(房间服务器)
2. 不同编码的音视频如何沟通, 交换两方都支持的解码
3. 怎么联系上对面, 网络协商, 了解对方的网络情况, 不是外网的地址需要使用NAT进行网络地址转换

使用ICE机制建立一下网络连接, 通过一系列的技术, 比如STUN, TURN之类的获取候选地址, 私有的和共有的, 通过STUN和TURN获取候选地址, 测试以后使用最佳的地址进行通信

> 获取媒体信息SDP, 网络信息candidate, 通过信令服务器交换

![image-20250529214324017](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202505292143434.png)

绿色部分，核心层，分为四层：
C++层，PeerConnection对等连接，其中包含很多API：传输质量，传输数据，传输统计报告，音视频设备管理，采集，等
session层，上下文管理
音视频引擎和传输（音频：编码器/防抖动/回音消除和降噪，视频：编码器/防抖动buffer/图像增强，传输：底层UDP，应用层RTP/SRTP/RTCP）
音频的采集和渲染，视频的采集（没有视频渲染，需要浏览器应用层自己做）【虚线部分允许浏览器自己进行重载】

+ 上图的框架对于不同的开发人员关注点不同： 

（1）紫色部分是Web应用开发者API层 

（2）蓝色实线部分是面向浏览器厂商的API层 

（3）蓝色虚线部分浏览器厂商可以自定义实现

## 网络连接

我们的电脑和电脑之前或大或小都是在某个局域网中，需要NAT（Network Address Translation，网络 地址转换），显示情况如下图

![image-20250529220020946](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202505292200101.png)

实际是映射到一个外网ip和端口

在解决WebRTC使用过程中的上述问题的时候，我们需要用到STUN和TURN。 

### STUN 

STUN（Session Traversal Utilities for NAT，NAT会话穿越应用程序）是一种网络协议，它允许位于NAT（或多重 NAT）后的客户端找出自己的公网地址，查出自己位于哪种类型的NAT之后以及NAT为某一个本地端口所绑定的 Internet端端口。这些信息被用来在两个同时处于NAT路由器之后的主机之间创建UDP通信。该协议由RFC 5389定义。

在遇到上述情况的时候，我们可以建立一个STUN服务器，这个服务器做什么用的呢？主要是给无法在公网环境下的 视频通话设备分配公网IP用的。这样两台电脑就可以在公网IP中进行通话

使用一句话说明STUN做的事情就是：告诉我你的公网IP地址+端口是什么。搭建STUN服务器很简单，媒体流传输是 按照P2P的方式。 那么问题来了，STUN并不是每次都能成功的为需要NAT的通话设备分配IP地址的，P2P在传输媒体流时，使用的本地带宽，在多人视频通话的过程中，通话质量的好坏往往需要根据使用者本地的带宽确定。那么怎么办？TURN可以 很好的解决这个问题

### TURN

TURN的全称为Traversal Using Relays around NAT，是STUN/RFC5389的一个拓展，主要添加了Relay功能。如果 终端在NAT之后， 那么在特定的情景下，有可能使得终端无法和其对等端（peer）进行直接的通信，这时就需要公网 的服务器作为一个中继， 对来往的数据进行转发。这个转发的协议就被定义为TURN

![image-20250529222833998](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202505292228157.png)

在STUN分配公网IP失败后，可以通过TURN服务器请求公网IP地址作为中继地址。这种方式的带宽由服务器端承 担，在多人视频聊天的时候，本地带宽压力较小，并且，根据Google的说明，TURN协议可以使用在所有的环境中。 （单向数据200kbps 一对一通话） 

以上是WebRTC中经常用到的2个协议，STUN和TURN服务器我们使用 coturn开源项目来搭建。 

> 补充：ICE跟STUN和TURN不一样，ICE不是一种协议，而是一个框架（Framework），它整合了STUN和TURN。 coturn开源项目集成了STUN和TURN的功能。 在WebRTC中用来描述 网络信息的术语叫candidate