# ADC驱动

纯粹的 ADC驱动也是IIO驱动框架的

## 驱动

I.MX6ULL 有 2 个 ADC，但是对应一个 ADC 控制器

### 设备树

```json
adc1: adc@02198000 {
  compatible = "fsl,imx6ul-adc", "fsl,vf610-adc";
  reg = <0x02198000 0x4000>;
  interrupts = <GIC_SPI 100 IRQ_TYPE_LEVEL_HIGH>;
  clocks = <&clks IMX6UL_CLK_ADC1>;
  num-channels = <2>;
  clock-names = "adc";
  status = "disabled";
};
```

>   -   **compatible**：兼容性属性，必须的，可以设置为“fsl,vf610-adc”。
>   -   **reg**：ADC控制器寄存器信息。
>   -   **interrupts**：中断属性，ADC1和ADC2各对应一个中断信息。
>   -   **clocks**：时钟属性。
>   -   **clock-names**：时钟名字，可选“adc”。
>   -   **vref-supply**：此属性对应vref参考电压句柄

对应的驱动文件`drivers/iio/adc/vf610_adc.c`, 可以找到对应的绑定文档`Documentation/devicetree/bindings/iio/adc/vf610-adc.txt`

实际使用的时候添加自己的设备树配置就可以了

+   添加ADC使用的GPIO1_IO01引脚配置信息

```c
pinctrl_adc1: adc1grp {
    fsl,pins = <
    MX6UL_PAD_GPIO1_IO01__GPIO1_IO01 0xb0
    >;
};
```

+   接下来在imx6ull-alientek-emmc.dts文件中的在 regulators节点下添加参考电源子节点

```json
reg_vref_adc: regulator@2 {
    compatible = "regulator-fixed";
    regulator-name = "VREF_3V3";
    regulator-min-microvolt = <3300000>;
    regulator-max-microvolt = <3300000>;
};
```

+   最后在imx6ull-alientek-emmc.dts文件中向 adc1节点追加一些内容

```c
&adc1 {
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_adc1>;
    num-channels = <2>;
    vref-supply = <&reg_vref_adc>;
    status = "okay";
};
```

>   num-channels用于设置IIO系统里面实际暴漏的通道的数量

### 驱动使能

```c
-> Device Drivers
  -> Industrial I/O support
    -> Analog to digital converters
      -> <*> Freescale vf610 ADC driver //选中
```

+   **n_voltage1_raw**：ADC1通道 1原始值文件。
+   **in_voltage_scale**：ADC1 比例文件(分辨率)，单位为 mV。实际电压值`(mV)=in_voltage1_raw* in_voltage_scale`