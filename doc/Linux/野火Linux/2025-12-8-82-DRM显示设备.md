# DRM显示设备

- 现代Linux的图形显示系统
- 管理所有显示相关的硬件：GPU、显示器、内存等

```
1. 显示控制 -> 管理多个显示器
2. GPU管理 -> 让程序使用显卡加速
3. 内存管理 -> 高效分配显存
4. 多程序支持 -> 多个程序可以同时使用显卡
```

DRM更能适应当前日益更新的显示硬件。 比如FB原生不支持多层合成，不支持VSYNC，不支持DMA-BUF，不支持异步更新，不支持fence机制等等， 而这些功能DRM原生都支持。同时DRM可以统一管理GPU和Display驱动，使得软件架构更为统一，方便管理和维护

![image-20251208152503592](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202512081525686.png)

可以看到DRM的图像系统可以分为两部分

- 应用层– **libdrm**
- 内核驱动层— **GEM**, **KMS**

libdrm: 对底层接口进行封装，向上层提供通用的API接口，主要是对各种IOCTL接口进行封装。

KMS(Kernel Mode Setting): 即Mode setting：更新画面和设置显示参数。

1. 更新画面：显示buffer的切换，多图层的合成方式，以及每个图层的显示位置。
2. 设置显示参数：包括分辨率、刷新率、电源状态（休眠唤醒）等。

GEM(Graphic Execution Manager): 主要负责显示buffer的分配和释放，内存管理与同步

## 显示

对于DRM而言，在framebuffer与显示器之间有四个部件， framebuffer的数据经过几个部件的联合处理最终把图像输出到显示器中

> 请求一个planes, 向里面的framebuffer写入图片数据, CRTC对数据进行合成

![image-20251208152712062](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202512081527168.png)

+ DRM Frambuffer

DRM Framebuffer也是一片存放图像的内存区域， 且需要设置图像的格式(RGB888,YUV,C8等)以及画布的大小

+ CRTC(Cathode Ray Tube Controller)阴极射线显像管控制器

在DRM显示系统中CRTC会配置display timings和显示分辨率(Planes提供)来扫描framebuffer上的内容，传给Encoder

display timings: 扫描framebuffer的时序，因为LCD屏的显示并不像0.96寸的屏幕那样， 直接把所有的显示数据写进去就可以显示东西，LCD屏需要一定的时序才能正确显示东西， 因此，CRTC在这里就有着很重要的作用，生成视频模式定时信号,输出内容到Encoder中，Encoder和Connector则只作为数据的转换和传输

+ Planes

图层: 包含向CRTC发送数据的缓存块的内存对象， 每个CRTC必须关联一个Planes，它是CRTC决定采用哪种视频模式的根据—显示分辨率（宽度和高度），像素大小，像素格式，刷新率等

1. DRM_PLANE_TYPE_PRIMARY: 主要图层，显示背景或者图像内容，每个CRTC中含一个
2. DRM_PLANE_TYPE_OVERLAY： 用于显示叠加、缩放，每个CRTC中含一个以上
3. DRM_PLANE_TYPE_CURSOR： 用于显示鼠标，每个CRTC中含0-N个

> - **PRIMARY**：基础显示能力。
> - **OVERLAY**：通常具备**缩放、旋转、Alpha透明度混合**等高级能力。
> - **CURSOR**：极低延迟、可高速移动（硬件光标）。

| 图层类型    | 角色比喻             | 关键特性                                                     | 数量（每 CRTC）              | 典型用途                                                  |
| :---------- | :------------------- | :----------------------------------------------------------- | :--------------------------- | :-------------------------------------------------------- |
| **PRIMARY** | **“背景画布”图层**   | 主显示层，是必须存在的基石。通常分辨率固定（等于显示模式），功能基础。 | **有且仅有 1 个**            | 显示桌面背景、主应用程序窗口。                            |
| **OVERLAY** | **“悬浮小部件”图层** | 拥有“超能力”，如**缩放、旋转、半透明叠加**。非常灵活。       | **0 到 N 个**（取决于硬件）  | 播放悬浮小视频窗口、系统状态图标、OSD菜单、游戏抬头显示。 |
| **CURSOR**  | **“鼠标箭头”图层**   | 专为极低延迟设计，由硬件直接控制移动，不经过复杂的图形流水线。 | **0 到 N 个**（通常 1-2 个） | **只显示鼠标光标**，确保光标移动绝对流畅，不卡顿。        |

+ Encoder

译为编码器。它的作用就是将 pixel 像素编码（转换）为显示器所需要的信号

+ Connector

对应于物理连接器 (VGA, DVI, FPD-Link, HDMI, DisplayPort, S-Video …) 他会连接将一个物理显示输出设备 (monitor, laptop panel, …) 。 与当前物理连接的输出设备相关的信息（如连接状态，EDID数据，DPMS状态或支持的视频模式）也存储在 Connector 内