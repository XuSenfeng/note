# MISC设备

misc的意思是混合、杂项的，因此 MISC驱动也叫做杂项驱动，也就是当我们板子上的某些外设无法进行分类的时候就可以使用 MISC 驱动。MISC 驱动其实就是最简单的字符设备驱动，通常嵌套在 platform 总线驱动中，实现复杂的驱动

所有的 MISC 设备驱动的主设备号都为 10，不同的设备使用不同的从设备号。随着 Linux字符设备驱动的不断增加，设备号变得越来越紧张，尤其是主设备号，MISC 设备驱动就用于解决此问题。**MISC 设备会自动创建 cdev**，不需要像我们以前那样手动创建，因此采用 MISC设备驱动可以简化字符设备驱动的编写

我们需要向 Linux注册一个miscdevice设备

## 使用

使用misc_register替换整个字符设备的注册部分, 在device_platform的注册prob函数里面

### 数据结构

```c
struct miscdevice  {
	int minor; // 次设备号
	const char *name;
	const struct file_operations *fops; // 字符设备驱动
	struct list_head list;
	struct device *parent;
	struct device *this_device;
	const struct attribute_group **groups;
	const char *nodename;
	umode_t mode;
};
```

我们需要设置 minor、name 和 fops 这三个成员变量, Linux 系统已经预定义了一些 MISC 设备的子设备号，这些预定义的子设备号定义在 `include/linux/miscdevice.h`文件中, 子设备号设置为`MISC_DYNAMIC_MINOR`是自动赋值

name就是此MISC设备名字，当此设备注册成功以后就会在/dev目录下生成一个名为 name 的设备文件。fops 就是字符设备的操作集合

### 注册函数

```c
extern int misc_register(struct miscdevice *misc);
extern int misc_deregister(struct miscdevice *misc);
```

注册函数可以理解为下面几个函数的集合

```c
alloc_chrdev_region(); /* 申请设备号 */
cdev_init(); /* 初始化 cdev */
cdev_add(); /* 添加 cdev */
class_create(); /* 创建类 */
device_create(); /* 创建设备 */
```

