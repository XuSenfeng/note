# Ubuntu22

[编译Ubuntu22.04笔记 | VR小杰的技术文档中心](https://wiki.vrxiaojie.top/TSPI-tai-shan-pai-RK3566/立创泰山派RK3566开发板/泰山派编译Ubuntu22.04/编译Ubuntu22.04笔记.html)

## 替换Kernel

需要使用5.10.0 -1012.12的kernel

下载完成后，解压

```
unzip jammy.zip
```

将tspi目录下原来的kernel重命名为kernel_old。

```
mv ./tspi/kernel ./tspi/kernel_old
```

将解压出的文件夹移动到泰山派SDK目录下，并重命名为kernel

```
mv linux-rockchip-jammy/ tspi/kernel
```

### 复制泰山派设备树文件

将之前的kernel_old 下的tspi开头的设备树文件复制到新的kernel下

```
cp ~/tspi/kernel_old/arch/arm64/boot/dts/rockchip/tspi* ~/tspi/kernel/arch/arm64/boot/dts/rockchip
```

```
cd ~/tspi/kernel/arch/arm64/boot/dts/rockchip
```

编辑Makefile，

```
vim ~/tspi/kernel/arch/arm64/boot/dts/rockchip/Makefile
```

新增一行：

```
dtb-$(CONFIG_ARCH_ROCKCHIP) += tspi-rk3566-user-v10-linux.dtb
```

并保存退出

### 修改menuconfig

```bash
make ARCH=arm64 menuconfig # 使用这个进行menuconfig
```

搜索 **AP6**，按下1进入对应配置页面

修改固件以及NVRAM路径，这里是指Ubuntu系统内的路径，后文会说如何将固件复制进去。 Firmware path和NVRAM path分别修改为

```
/lib/firmware/fw_bcm43438a1.bin
/lib/firmware/nvram_ap6212a.txt
```

![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301910487.png)

> **博通（Broadcom）AP6212A WiFi + 蓝牙模块（基于 BCM43438 芯片）** 运行的核心配套文件，是 WiFi 驱动能正常工作的 “刚需文件”，缺一不可, 是运行在 WiFi 芯片自身微处理器上的底层程序, Linux 内核驱动（比如博通的`brcmfmac.ko`）加载后，会把这个固件文件 “下载” 到 WiFi 芯片的内存中，芯片才能从 “裸硬件” 变成能工作的 WiFi 模块
>
> txt文件里包含驱动必须读取的关键参数（不同批次 / 型号的模块参数不同），比如：
>
> - 射频参数：发射功率、信道频率校准值（保证 WiFi 信号强度和稳定性，避免信号过弱 / 干扰）；
> - 硬件标识：默认 MAC 地址、模块型号、天线配置（单天线 / 双天线）；
> - 功能限制：支持的 WiFi 频段（2.4G/5G）、蓝牙配对参数（AP6212A 是 WiFi + 蓝牙二合一模块）；
> - 厂商校准值：生产时对模块的硬件校准参数（保证不同模块的兼容性）。

#### GPU

（1）将`Device Drivers > Graphics support > Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)下的Ignore drm ioctl permission `标记为 **N**

![image-20260130191249487](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301912539.png)

（2）将`Device Drivers > Graphics support > Search (Panfros) > Graphics support下的Panfrost (DRM support for ARM Mali Midgard/Bifrost GPUs)` 标记为 **Y**

![image-20260130191307144](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301913188.png)

打开`~/tspi/kernel/arch/arm64/boot/dts/rockchip/tspi-rk3566-core-v10.dtsi `将cursor-win-id = <ROCKCHIP_VOP2_CLUSTER0>; 这一行**注释掉**。

![image-20260130191337852](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301913892.png)

在GPU图像处理下新增两行：

```
clock-names = "gpu", "bus";
interrupt-names = "gpu", "mmu", "job";
```

![image-20260130191401774](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301914831.png)

完成后保存

![alt text](https://wiki.vrxiaojie.top/assets/image8.B_yM8NWx.png)

![alt text](https://wiki.vrxiaojie.top/assets/image9.CyvfTSKH.png)

退出后输入

```bash
make ARCH=arm64 savedefconfig
mv defconfig arch/arm64/configs/rockchip_linux_defconfig
```

### 复制触摸驱动

### 安装GCC交叉编译工具

前往https://developer.arm.com/downloads/-/gnu-a/10-2-2020-11 下载`gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu.tar.xz`

```bash
wget https://developer.arm.com/-/media/Files/downloads/gnu-a/10.2-2020.11/binrel/gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu.tar.xz
```

并将其解压至 ~/ 目录下

```bash
tar -xvf gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu.tar.xz
vim ~/.bashrc
# 在文件最后新增三行
export ARCH=arm64
export CROSS_COMPILE=aarch64-none-linux-gnu-
export PATH=$PATH:/home/vrxiaojie/gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu/bin
# 执行
source ~/.bashrc
```

之后编译系统

显示lz4版本不合适

```bash
git clone https://github.com/lz4/lz4.git
cd lz4
make -j$(nproc)
sudo make install
```



## rootfs文件系统

从[这里](https://mirrors.aliyun.com/ubuntu-cdimage/ubuntu-base/releases/22.04/release/)下载镜像`https://mirrors.aliyun.com/ubuntu-cdimage/ubuntu-base/releases/22.04/release/ubuntu-base-22.04-base-amd64.tar.gz`

```bash
mkdir ~/ubuntu_rootfs
tar -xzvf ubuntu-base-22.04.5-base-arm64.tar.gz -C ~/ubuntu_rootfs/
```

### 将WIFI固件复制进Ubuntu

为了使上面配置menuconfig的WIFI模块生效

```
sudo cp ~/tspi/external/rkwifibt/firmware/broadcom/AP6212A1/wifi/nvram_ap6212a.txt ~/ubuntu_rootfs/lib/firmware
sudo cp ~/tspi/external/rkwifibt/firmware/broadcom/AP6212A1/wifi/fw_bcm43438a1.bin ~/ubuntu_rootfs/lib/firmware
```

### 安装模块至rootfs中

在 `~/tspi/kernel`目录下编译模块

```bash
make modules
```

![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301917412.png)

接着安装模块至ubuntu rootfs, 这个变量决定了内核模块将被安装到**哪个目录的 `lib/modules/` 子目录下**

```bash
make ARCH=arm64 modules_install INSTALL_MOD_PATH=../../ubuntu_rootfs
```

![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301917367.png)

用`ls`命令能看到`ubuntu_rootfs/lib/modules`目录下多出了一个带数字的文件夹`5.10.209`，文件夹内包含了刚安装的模块

![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301917553.png)

以下内容参考 https://www.jlc-bbs.com/platform/a/310346

（1）在当前编译环境中安装仿真开发环境，

```c
sudo apt install qemu-user-static
```

（2）将当前编译环境中的仿真开发环境复制到目标系统文件夹

```c
sudo cp /usr/bin/qemu-aarch64-static ubuntu_rootfs/usr/bin/
```

（3）将当前编译环境中的网络配置文件复制到目标系统文件夹

```
sudo cp /etc/resolv.conf  ubuntu_rootfs/etc/
```

（4）修改目标系统中的软件源配置文件

```
sudo vim ubuntu_rootfs/etc/apt/sources.list
```

将该文件原先的内容删掉，替换为以下内容：

```
deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse

# deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-proposed main restricted universe multiverse
# deb-src http://mirrors.aliyun.com/ubuntu-ports/ jammy-proposed main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse
```

（5）编写挂载脚本

```
sudo vim mount.sh
```

加入以下内容：

```bash
#!/bin/bash
function mnt() {
    echo "MOUNTING"
    sudo mount -t proc /proc ${2}proc
    sudo mount -t sysfs /sys ${2}sys
    sudo mount -o bind /dev ${2}dev
    #sudo mount -t devpts -o gid=5,mode=620 devpts ${2}dev/pts
    sudo mount -o bind /dev/pts ${2}dev/pts
    sudo chroot ${2}
}
function umnt() {
    echo "UNMOUNTING"
    sudo umount ${2}proc
    sudo umount ${2}sys
    sudo umount ${2}dev/pts
    sudo umount ${2}dev
}
if [ "$1" == "-m" ] && [ -n "$2" ];
then
        mnt $1 $2
elif [ "$1" == "-u" ] && [ -n "$2" ];
then
        umnt $1 $2
else
        echo ""
        echo "Either 1'st, 2'nd or both parameters were missing"
        echo ""
        echo "1'st parameter can be one of these: -m(mount) OR -u(umount)"
        echo "2'nd parameter is the full path of rootfs directory(with tralling '/')"
        echo ""
        echo "For example: ch-mount -m /media/sdcard"
        echo ""
        echo 1st parameter : ${1}
        echo 2nd parameter : $[2]
fi
```

（6）添加脚本执行权限

```
sudo chmod +x mount.sh
```

（7）挂载根文件系统

```
./mount.sh -m ubuntu_rootfs/
```

注意: 当完成根文件系统挂载后，后续命令将在根文件系统中执行，直至根文件系统被卸载（后文会提及如何卸载）

### 2.6 在根文件系统中安装必要的软件

（1）更新安装软件包列表

```
apt update
```

若在使用该命令时遇到问题：

![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301921760.png)

其原因是/tmp文件夹的权限错误，只需使用chmod为/tmp赋777权限

```
chmod 777 /tmp
apt clean
apt update
```

（2）更新和升级软件包

```
apt upgrade
```

（3）在目标系统中安装必要的软件

```
apt install -y sudo vim udev net-tools ethtool udhcpc netplan.io language-pack-en-base iputils-ping openssh-sftp-server  ntp usbutils alsa-utils libmtp9 language-pack-zh-han* bluetooth* bluez* blueman* wireless-tools network-manager dialog chromium-browser
```

安装过程中会提示配置地区和时区，输入`6` 选择Asia![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301921576.png)

接着输入`70`选择Shanghai![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301921630.png)

（4）为了实现屏幕显示，安装桌面环境 ubuntu-desktop 注意，此过程相当耗时，如有提示缺少依赖，可用apt单独安装依赖后，继续安装桌面环境。

```
apt install ubuntu-desktop -y
```

中途会让选择键盘布局，这里输入`19`，选择Chinese![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301921884.png)

继续选择中文键盘布局 `1`![alt text](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601301921009.png)

（5）卸载办公套件并清除相关配置文件

```
apt-get remove --purge libreoffice* -y
```

（6）清理无用的软件

```
sudo apt autoremove
```

（7）清理apt

```
sudo apt clean
```

### 2.7 添加用户及启动配置

（1）在目标系统中添加用户

```
adduser jiao
```

（2）为用户添加管理员权限

```
adduser jiao sudo
```

（3）修改root用户密码

```
passwd root
```

### 修改开机等待网络延迟时间

默认情况下，系统启动过程中会出现“A start job is running for wait for network to be Configured”的提示信息，然后开始倒计时5分钟，需要等待倒计时结束后才能继续启动系统，通过修改配置文件，将倒计时时间缩短到5秒或关闭倒计时。

```
vim  /etc/systemd/system/network-online.target.wants/systemd-networkd-wait-online.service
```

修改的配置文件内容：

```
ExecStart=/usr/bin/nm-online -s -q --timeout=0
```

### 添加分区释放的系统服务（重要）

默认情况下，rootfs分区烧录后，只有固件本身大小。通过添加系统服务，实现分区释放。 （1）修改配置文件

```
vim /etc/init.d/resize2fs.sh
```

修改的配置文件内容：

```bash
#!/bin/bash -e 
# resize filesystem mmcblk0p6
if [ ! -e "/usr/local/boot_flag" ] ;
then
  echo "Resizing /dev/mmcblk0p6..."
  resize2fs /dev/mmcblk0p6
  touch /usr/local/boot_flag
fi
```

（2）添加配置文件执行权限

```bash
chmod +x /etc/init.d/resize2fs.sh
```

（3）创建执行上述脚本的系统服务

```bash
vim lib/systemd/system/resize2fs.service
```

添加内容：

```
#start
[Unit]
Description=Setup rockchip platform environment
Before=lightdm.service
After=resize-helper.service
[Service]
Type=simple
ExecStart=/etc/init.d/resize2fs.sh
[Install]
WantedBy=multi-user.target
#end
```

> 实际需要自己运行
>
> ```bash
> sudo systemctl enable resize2fs.service
> # 立即启动服务（执行扩容操作）
> sudo systemctl start resize2fs.service
> ```
>
> 

### 退出并卸载根文件系统

退出根文件系统

```
exit
```

卸载根文件系统

```
sudo ./mount.sh -u ubuntu_rootfs/
```

## 制作rootfs.img并烧录

```bash
sudo dd if=/dev/zero of=ubuntu_rootfs.img bs=1M count=8192
sudo mkfs.ext4 ubuntu_rootfs.img
sudo mkdir ubuntu_base_rootfs
sudo chmod 777 ubuntu_base_rootfs
sudo mount ubuntu_rootfs.img ubuntu_base_rootfs
sudo cp -rfp ubuntu_rootfs/* ubuntu_base_rootfs/
sudo umount ubuntu_base_rootfs/
sudo e2fsck -p -f ubuntu_rootfs.img # 修复及检测镜像文件系统
sudo resize2fs -M ubuntu_rootfs.img # 压缩镜像文件的大小
sudo du -sh ubuntu_rootfs.img # 查看镜像文件的大小
rm ~/tspi/rockdev/rootfs.* # 删除原rockdev下的rootfs.ext4和rootfs.img
# 将刚刚创建的ubuntu_rootfs.img 移动到rockdev下并重命名为rootfs.img
mv ubuntu_rootfs.img ~/tspi/rockdev/rootfs.img
```

> 也可以通过修改复制脚本的方式实现, 目标是在这个位置放上rootfs文件

```bash
./build.sh updateimg
```

合成update.img文件

## 网络连接

[立创泰山派学习01--ubuntn系统的WIFI配置及SSH的安装 - zbl1118 - 博客园](https://www.cnblogs.com/zblblog/p/18075528)

```bash
nmcli dev wifi list
sudo nmcli device wifi connect "TP-LINK_5G_2B18" password "13838106970"
sudo nmcli device wifi connect "jiao" password "11111111"
```

## 硬盘处理

```bash
sudo fdisk -l /dev/mmcblk0
Disk /dev/mmcblk0: 14.56 GiB, 15634268160 bytes, 30535680 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 25590000-0000-4648-8000-196800006884

Device            Start      End  Sectors  Size Type
/dev/mmcblk0p1    16384    24575     8192    4M unknown
/dev/mmcblk0p2    24576    32767     8192    4M unknown
/dev/mmcblk0p3    32768   163839   131072   64M unknown
/dev/mmcblk0p4   163840   294911   131072   64M unknown
/dev/mmcblk0p5   294912   360447    65536   32M unknown
/dev/mmcblk0p6   360448 12943359 12582912    6G unknown
/dev/mmcblk0p7 12943360 13205503   262144  128M unknown
/dev/mmcblk0p8 13205504 30535615 17330112  8.3G unknown

sudo mkfs.ext4 /dev/mmcblk0p8
sudo mkdir /data
sudo mount /dev/mmcblk0p8 /data
df -h /data
```

临时挂载在重启后会失效。我们需要将其信息添加到 `/etc/fstab` 文件中。

1. 首先，获取分区的 **UUID**（最可靠的标识方式）：

    ```
    sudo blkid /dev/mmcblk0p8
    ```

    输出中会显示类似 `UUID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"` 的信息。

2. 编辑 `fstab` 文件：

    ```
    sudo nano /etc/fstab
    ```

3. 在文件末尾**新起一行**，添加以下内容（请将 `UUID=xxxx...` 替换为上一步命令输出的**实际UUID**）：

    ```
    UUID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  /data  ext4  defaults,noatime  0  2
    ```

4. 按 `Ctrl+O` 保存，按 `Ctrl+X` 退出。

+ 验证 fstab 配置

可以运行以下命令测试配置是否正确，这不会破坏现有挂载：

```bash
sudo mount -a
```

如果命令执行没有报错，并且再次运行 `df -h /data` 显示正常，就说明配置成功。下次开机时会自动挂载。

```bash
# 实际的文件移植
sudo rsync -av /opt/ /data/opt/  # 复制内容
sudo mv /opt /opt.old            # 将原目录重命名备份
sudo ln -s /data/opt /opt        # 创建指向新位置的软链接
sudo reboot 
# 重启后，检查新 /opt 工作是否正常，若正常可删除 /opt.old
```

