# åŒºåŸŸå·ç§¯ç¥ç»ç½‘ç»œ

## R-CNN

ä½¿ç”¨å¯å‘å¼æœç´¢ç®—æ³•é€‰æ‹©é”šæ¡†, é¢„è®­ç»ƒæ¨¡å‹å¯¹æ¯ä¸€ä¸ªé”šæ¡†æŠ½å–ç‰¹å¾

è®­ç»ƒä¸€ä¸ªSVMå¯¹ç±»åˆ«åˆ†ç±», å†è®­ç»ƒä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹é¢„æµ‹è¾¹ç¼˜æ¡†åç§»

### Rolå…´è¶£åŒºåŸŸæ± åŒ–å±‚

å…¶ç›®çš„æ˜¯å¯¹éå‡åŒ€å°ºå¯¸çš„è¾“å…¥æ‰§è¡Œæœ€å¤§æ± åŒ–ä»¥è·å¾—å›ºå®šå°ºå¯¸çš„ç‰¹å¾å›¾

ç»™å®šä¸€ä¸ªé”šæ¡†, å‡åŒ€çš„è¿›è¡Œåˆ†å‰²ä¸ºn x må—, è¾“å‡ºæ¯ä¸€ä¸ªå—é‡Œé¢çš„æœ€å¤§å€¼(æœ€å¤§æ± åŒ–)

ä¸ç®¡è¿™ä¸€ä¸ªé”šæ¡†å¤šå¤§, æ€»è¾“å‡ºä¸€ä¸ªnmçš„å€¼

![image-20250123224349974](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501232243010.png)

## Fast-RCNN

ä½¿ç”¨CNNå¯¹å›¾åƒè¿›è¡ŒæŠ½å–ç‰¹å¾, ä¹‹åä½¿ç”¨æ¯”è¾ƒå¥½çš„é”šæ¡†è¿›è¡Œæ‹Ÿåˆ, è€Œä¸æ˜¯ä½¿ç”¨æ‰€æœ‰çš„é”šæ¡†, é€‰æ‹©é”šæ¡†çš„ç®—æ³•æ˜¯å›¾åƒè¯†åˆ«é‡Œé¢çš„ç®—æ³•

![image-20250123224313652](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501232243728.png)

## Faster RCNN

å›¾åƒè¯†åˆ«çš„ç®—æ³•é€Ÿåº¦æ¯”è¾ƒæ…¢, æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œè¿›è¡Œé€‰æ‹©

![image-20250123224558588](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501232245636.png)

## Mask RCNN

![image-20250123224720530](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501232247571.png)

è¿›è¡Œåƒç´ çº§åˆ«çš„é¢„æµ‹, æé«˜ä¸€ä¸ªå›¾ç‰‡è¾¹ç¼˜çš„è´¨é‡, å› ä¸ºä¹‹å‰ä½¿ç”¨çš„Rol poolä¼šä½¿å¾—è¾“å‡ºæœ‰åç§»(ä¸èƒ½æ•´é™¤çš„æ—¶å€™å‘ä¸€ä¾§å–æ•´)

## å•å‘å¤šæ¡†æ£€æµ‹SSD

### å¤šå°ºåº¦ç›®æ ‡æ£€æµ‹

å¦‚æœä¸ºæ¯ä¸ªåƒç´ éƒ½ç”Ÿæˆçš„é”šæ¡†ï¼Œæˆ‘ä»¬æœ€ç»ˆå¯èƒ½ä¼šå¾—åˆ°å¤ªå¤šéœ€è¦è®¡ç®—çš„é”šæ¡†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¾“å…¥å›¾åƒä¸­å‡åŒ€é‡‡æ ·ä¸€å°éƒ¨åˆ†åƒç´ ï¼Œå¹¶ä»¥å®ƒä»¬ä¸ºä¸­å¿ƒç”Ÿæˆé”šæ¡†ã€‚

```python
def display_anchors(fmap_w, fmap_h, s):
    d2l.set_figsize()
    # å‰ä¸¤ä¸ªç»´åº¦ä¸Šçš„å€¼ä¸å½±å“è¾“å‡º
    fmap = torch.zeros((1, 10, fmap_h, fmap_w))
    anchors = multibox_prior(fmap, sizes=s, ratios=[1, 2, 0.5])
    bbox_scale = torch.tensor((w, h, w, h))
    show_bboxes(d2l.plt.imshow(img).axes,
        anchors[0] * bbox_scale) # æ˜¾ç¤ºä¸€ä¸‹

display_anchors(fmap_w=4, fmap_h=4, s=[0.15]) # æŒ‰ç…§4*4çš„ç”Ÿæˆ
```

![image-20250124225408398](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501242254605.png)

```python
display_anchors(fmap_w=2, fmap_h=2, s=[0.4])
```

![image-20250124225737928](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501242257099.png)

### å®ç°åŸç†

å¯¹æ¯ä¸€ä¸ªåƒç´ ç”Ÿæˆå¤šä¸ªé”šæ¡†, å¯¹é”šæ¡†è¿›è¡Œè®¡ç®—

æ­¤æ¨¡å‹ä¸»è¦ç”±åŸºç¡€ç½‘ç»œç»„æˆï¼Œå…¶åæ˜¯å‡ ä¸ªå¤šå°ºåº¦ç‰¹å¾å—ã€‚åŸºæœ¬ç½‘ ç»œç”¨äºä»è¾“å…¥å›¾åƒä¸­æå–ç‰¹å¾ï¼Œå› æ­¤å®ƒå¯ä»¥ä½¿ç”¨æ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œã€‚

æ¯ä¸ªå¤šå°ºåº¦ç‰¹å¾å— å°†ä¸Šä¸€å±‚æä¾›çš„ç‰¹å¾å›¾çš„é«˜å’Œå®½ç¼©å°ï¼ˆå¦‚å‡åŠï¼‰ï¼Œå¹¶ä½¿ç‰¹å¾å›¾ä¸­æ¯ä¸ªå•å…ƒåœ¨è¾“å…¥å›¾åƒä¸Šçš„æ„Ÿå—é‡å˜å¾—æ›´å¹¿é˜”ã€‚

![image-20250124230844742](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501242308903.png)

### ç±»åˆ«é¢„æµ‹å±‚

è®¾ç›®æ ‡ç±»åˆ«çš„æ•°é‡ä¸ºqã€‚è¿™æ ·ä¸€æ¥ï¼Œé”šæ¡†æœ‰q + 1ä¸ªç±»åˆ«ï¼Œå…¶ä¸­0ç±»æ˜¯èƒŒæ™¯ã€‚

è®¾ç‰¹å¾å›¾çš„é«˜å’Œå®½ åˆ†åˆ«ä¸ºhå’Œwã€‚å¦‚æœä»¥å…¶ä¸­æ¯ä¸ªå•å…ƒä¸ºä¸­å¿ƒç”Ÿæˆaä¸ªé”šæ¡†ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯¹hwaä¸ªé”šæ¡†è¿›è¡Œåˆ†ç±»ã€‚å¦‚æœä½¿ç”¨å…¨ è¿æ¥å±‚ä½œä¸ºè¾“å‡ºï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ¨¡å‹å‚æ•°è¿‡å¤šã€‚

ç±»åˆ«é¢„æµ‹å±‚ä½¿ç”¨ä¸€ä¸ªä¿æŒè¾“å…¥é«˜å’Œå®½çš„å·ç§¯å±‚ã€‚è¿™æ ·ä¸€æ¥ï¼Œè¾“å‡ºå’Œè¾“å…¥åœ¨ç‰¹å¾å›¾å®½å’Œé«˜ä¸Šçš„ç©ºé—´ åæ ‡ä¸€ä¸€å¯¹åº”ã€‚è€ƒè™‘è¾“å‡ºå’Œè¾“å…¥åŒä¸€ç©ºé—´åæ ‡ï¼ˆã€ï¼‰ï¼ˆğ‘¥ã€ğ‘¦ï¼‰ï¼šè¾“å‡ºç‰¹å¾å›¾ä¸Šï¼ˆxã€yï¼‰åæ ‡çš„é€šé“é‡ŒåŒ…å«äº†ä»¥è¾“å…¥ç‰¹å¾å›¾ï¼ˆã€ï¼‰ï¼ˆğ‘¥ã€ğ‘¦ï¼‰åæ ‡ä¸ºä¸­å¿ƒç”Ÿæˆçš„æ‰€æœ‰é”šæ¡†çš„ç±»åˆ«é¢„æµ‹ã€‚å› æ­¤è¾“å‡ºé€šé“æ•°ä¸ºğ‘(ğ‘+1)ï¼Œå…¶ä¸­ç´¢å¼•ä¸ºï¼ˆï¼‰ğ‘–(ğ‘+1)+ğ‘—ï¼ˆ0â‰¤ğ‘—â‰¤ğ‘ï¼‰çš„é€šé“ä»£è¡¨äº†ç´¢å¼•ä¸ºiçš„é”šæ¡†æœ‰å…³ç±»åˆ«ç´¢å¼•ä¸ºjçš„é¢„æµ‹ã€‚

```python
def cls_predictor(num_inputs, num_anchors, num_classes):
    return nn.Conv2d(num_inputs, 
                     num_anchors * (num_classes +
                     1),kernel_size=3, padding=1)
```

### è¾¹æ¡†é¢„æµ‹å±‚

å’Œä¸Šé¢çš„æ¯”è¾ƒç±»ä¼¼, ä½†æ˜¯ä¸ºæ¯ä¸€ä¸ªé”šæ¡†é¢„æµ‹å‡ºå››ä¸ªåç§»é‡

```python
def bbox_predictor(num_inputs, num_anchors):
    return nn.Conv2d(num_inputs, num_anchors * 4, kernel_size=3, padding=1)
```



### è¿ç»“å¤šå°ºåº¦çš„é¢„æµ‹

å®é™…çš„è¾“å‡ºå¤§å°å’Œæ¯ä¸€ä¸ªå›¾ç‰‡çš„é”šæ¡†æ•°, æ‰¹é‡å¤§å°, ç±»åˆ«æ•°, å›¾ç‰‡çš„å¤§å°, æœ‰å…³

```python
def forward(x, block):
	return block(x)
Y1 = forward(torch.zeros((2, 8, 20, 20)), cls_predictor(8, 5, 10))
Y2 = forward(torch.zeros((2, 16, 10, 10)), cls_predictor(16, 3, 10))
Y1.shape, Y2.shape
"""
(torch.Size([2, 55, 20, 20]), torch.Size([2, 33, 10, 10]))
ç¬¬äºŒç»´çš„å¤§å°æ˜¯è¾“å‡ºçš„(ç§ç±»+1)*é”šæ¡†çš„å¤§å°, åé¢çš„æ˜¯å›¾ç‰‡çš„å¤§å°
"""
```

åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™, ç”±äºå›¾ç‰‡çš„å¤§å°ä¸åŒçš„åŸå› , æ‰€ä»¥æŠŠå›¾ç‰‡è¿›è¡Œå±•å¹³

```python
def flatten_pred(pred):
    # permuteå˜åŒ–æŠŠè¾“å‡ºçš„é€šé“æ•°æ”¾åœ¨æœ€å, å±•å¹³ä»¥åå®é™…çš„ç›¸åŒä½ç½®çš„ä¸åŒé€šé“æ˜¯åœ¨ä¸€èµ·çš„
    return torch.flatten(pred.permute(0, 2, 3, 1), start_dim=1)
def concat_preds(preds):
    # æŠŠç¬¬äºŒç»´æ‹¼æ¥èµ·æ¥
    return torch.cat([flatten_pred(p) for p in preds], dim=1)

```

### é«˜å®½å‡åŠå—

æ¯ä¸ªé«˜å’Œå®½å‡ åŠå—ç”±ä¸¤ä¸ªå¡«å……ä¸º1çš„3 Ã— 3çš„å·ç§¯å±‚ã€ä»¥åŠæ­¥å¹…ä¸º2çš„2 Ã— 2æœ€å¤§æ±‡èšå±‚ç»„æˆã€‚é«˜å’Œå®½å‡åŠå—ä¼šæ‰©å¤§æ¯ä¸ªå•å…ƒåœ¨å…¶è¾“å‡ºç‰¹å¾å›¾ä¸­çš„æ„Ÿå—é‡ã€‚

```python
def down_sample_blk(in_channels, out_channels):
    blk = []
    for _ in range(2):
        blk.append(nn.Conv2d(in_channels, out_channels,
            kernel_size=3, padding=1))
        blk.append(nn.BatchNorm2d(out_channels)) // å½’ä¸€åŒ–
        blk.append(nn.ReLU())
        in_channels = out_channels
    blk.append(nn.MaxPool2d(2))
    return nn.Sequential(*blk)
```

### åŸºæœ¬ç½‘ç»œå¿«

ç”¨äºä»å›¾åƒé‡Œé¢æŠ½å–ç‰¹å¾, è¯¥ç½‘ç»œä¸²è”3ä¸ªé«˜å’Œ å®½å‡åŠå—ï¼Œå¹¶é€æ­¥å°†é€šé“æ•°ç¿»å€ã€‚ç»™å®šè¾“å…¥å›¾åƒçš„å½¢çŠ¶ä¸º256Ã—256ï¼Œæ­¤åŸºæœ¬ç½‘ç»œå—è¾“å‡ºçš„ç‰¹å¾å›¾å½¢çŠ¶ä¸º32Ã—32 ï¼ˆ256/23 = 32ï¼‰ã€‚

```python
def base_net():
    blk = []
    num_filters = [3, 16, 32, 64]
    for i in range(len(num_filters) - 1):
        blk.append(down_sample_blk(num_filters[i], num_filters[i+1]))
    return nn.Sequential(*blk)

forward(torch.zeros((2, 3, 256, 256)), base_net()).shape
```

### å®Œæ•´çš„æ¨¡å‹

å®Œæ•´çš„å•å‘å¤šæ¡†æ£€æµ‹æ¨¡å‹ç”±äº”ä¸ªæ¨¡å—ç»„æˆã€‚æ¯ä¸ªå—ç”Ÿæˆçš„ç‰¹å¾å›¾æ—¢ç”¨äºç”Ÿæˆé”šæ¡†ï¼Œåˆç”¨äºé¢„æµ‹è¿™äº›é”šæ¡†çš„ç±» åˆ«å’Œåç§»é‡ã€‚åœ¨è¿™äº”ä¸ªæ¨¡å—ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯åŸºæœ¬ç½‘ç»œå—ï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬å››ä¸ªæ˜¯é«˜å’Œå®½å‡åŠå—ï¼Œæœ€åä¸€ä¸ªæ¨¡å—ä½¿ç”¨ å…¨å±€æœ€å¤§æ± å°†é«˜åº¦å’Œå®½åº¦éƒ½é™åˆ°1ã€‚

```python
def get_blk(i):
    if i == 0:
        blk = base_net()
    elif i == 1:
        blk = down_sample_blk(64, 128)
    elif i == 4:
        blk = nn.AdaptiveMaxPool2d((1,1))
    else:
        blk = down_sample_blk(128, 128)
    return blk
```

ç°åœ¨æˆ‘ä»¬ä¸ºæ¯ä¸ªå—å®šä¹‰å‰å‘ä¼ æ’­ã€‚ä¸å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸åŒï¼Œæ­¤å¤„çš„è¾“å‡ºåŒ…æ‹¬ï¼šCNNç‰¹å¾å›¾Yï¼›åœ¨å½“å‰å°ºåº¦ä¸‹æ ¹ æ®Yç”Ÿæˆçš„é”šæ¡†ï¼›é¢„æµ‹çš„è¿™äº›é”šæ¡†çš„ç±»åˆ«å’Œåç§»é‡ï¼ˆåŸºäºYï¼‰ã€‚

```python
def blk_forward(X, blk, size, ratio, cls_predictor, bbox_predictor):
    Y = blk(X)
    # ç”Ÿæˆå¤šä¸ªé”šæ¡†
    anchors = d2l.multibox_prior(Y, sizes=size, ratios=ratio)
    cls_preds = cls_predictor(Y) # å·ç§¯é¢„æµ‹æ¯ä¸€ä¸ªæ¡†çš„è¾“å‡ºç§ç±»
    bbox_preds = bbox_predictor(Y) # é¢„æµ‹ä¸€ä¸‹åç§»
    return (Y, anchors, cls_preds, bbox_preds)

```

ä¸€ä¸ªè¾ƒæ¥è¿‘é¡¶éƒ¨çš„å¤šå°ºåº¦ç‰¹å¾å—æ˜¯ç”¨äºæ£€æµ‹è¾ƒå¤§ç›®æ ‡çš„ï¼Œå› æ­¤éœ€è¦ç”Ÿæˆæ›´å¤§çš„é”šæ¡†ã€‚ åœ¨ä¸Šé¢çš„å‰å‘ä¼ æ’­ä¸­ï¼Œåœ¨æ¯ä¸ªå¤šå°ºåº¦ç‰¹å¾å—ä¸Šï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨çš„multibox_priorå‡½æ•°çš„sizeså‚ æ•°ä¼ é€’ä¸¤ä¸ªæ¯”ä¾‹å€¼çš„åˆ—è¡¨ã€‚

åœ¨ä¸‹é¢ï¼Œ0.2å’Œ1.05ä¹‹é—´çš„åŒºé—´è¢«å‡åŒ€åˆ†æˆäº”ä¸ªéƒ¨åˆ†ï¼Œä»¥ç¡®å®šäº”ä¸ªæ¨¡å—çš„åœ¨ä¸åŒå°ºåº¦ ä¸‹çš„è¾ƒå°å€¼ï¼š0.2ã€0.37ã€0.54ã€0.71å’Œ0.88ã€‚ä¹‹åï¼Œä»–ä»¬è¾ƒå¤§çš„å€¼ç”±âˆš 0.2 Ã— 0.37 = 0.272ã€ âˆš 0.37 Ã— 0.54 = 0.447ç­‰ ç»™å‡ºã€‚

```python
sizes = [[0.2, 0.272], [0.37, 0.447], [0.54, 0.619], [0.71, 0.79],
[0.88, 0.961]]
ratios = [[1, 2, 0.5]] * 5
num_anchors = len(sizes[0]) + len(ratios[0]) - 1
```

æ„å»ºæ¨¡å‹, æ¯ä¸€å±‚éƒ½æœ‰ä¸€ä¸ªè¾“å‡º, æœ€åæŠŠè¾“å‡ºåˆå¹¶èµ·æ¥

```python
class TinySSD(nn.Module):
    def __init__(self, num_classes, **kwargs):
        super(TinySSD, self).__init__(**kwargs)
        self.num_classes = num_classes
        idx_to_in_channels = [64, 128, 128, 128, 128]
        for i in range(5):
            # å³èµ‹å€¼è¯­å¥self.blk_i=get_blk(i)
            setattr(self, f'blk_{i}', get_blk(i)) # äº”ä¸ªä¸åŒçš„å—
            setattr(self, f'cls_{i}', cls_predictor(idx_to_in_channels[i],
                num_anchors, num_classes)) # é¢„æµ‹æ¯ä¸€ä¸ªæ¡†çš„è¾“å‡ºç§ç±»
            setattr(self, f'bbox_{i}', bbox_predictor(idx_to_in_channels[i],
                num_anchors)) # é¢„æµ‹æ¯ä¸€ä¸ªæ¡†çš„è¾“å‡ºåæ ‡åç§»é‡
        
    def forward(self, X):
        anchors, cls_preds, bbox_preds = [None] * 5, [None] * 5, [None] * 5
        for i in range(5):
            # getattr(self,'blk_%d'%i)å³è®¿é—®self.blk_i
            X, anchors[i], cls_preds[i], bbox_preds[i] = blk_forward(
                X, getattr(self, f'blk_{i}'), sizes[i], ratios[i],
                getattr(self, f'cls_{i}'), getattr(self, f'bbox_{i}'))
        anchors = torch.cat(anchors, dim=1) # å°†é”šæ¡†åæ ‡å±•å¹³
        cls_preds = concat_preds(cls_preds) # è¾¹æ¡†é¢„æµ‹ç§ç±»
        cls_preds = cls_preds.reshape(
            cls_preds.shape[0], -1, self.num_classes + 1) # æŠŠç±»çš„æ¯ä¸€ä¸ªé¢„æµ‹ä½œä¸ºä¸€ä¸ªç»´åº¦
        bbox_preds = concat_preds(bbox_preds) # è¾¹æ¡†é¢„æµ‹åæ ‡
        return anchors, cls_preds, bbox_preds
```



```python
net = TinySSD(num_classes=1)
X = torch.zeros((32, 3, 256, 256))
anchors, cls_preds, bbox_preds = net(X)

print('output anchors:', anchors.shape)
print('output class preds:', cls_preds.shape)
print('output bbox preds:', bbox_preds.shape)

"""
output anchors: torch.Size([1, 5444, 4])    # é”šæ¡†çš„ä½ç½®
output class preds: torch.Size([32, 5444, 2]) # é”šæ¡†çš„ç§ç±»é¢„æµ‹, 32æ‰¹é‡å¤§å°, 5444é”šæ¡†æ•°é‡
output bbox preds: torch.Size([32, 21776]) # é¢„æµ‹ä¸€ä¸‹åç§»
"""
```

åŠ è½½æ•°æ®é›†

```python
batch_size = 32
train_iter, _ = d2l.load_data_bananas(batch_size)
```

åŠ è½½æ¨¡å‹

```python
device, net = d2l.try_gpu(), TinySSD(num_classes=1)
trainer = torch.optim.SGD(net.parameters(), lr=0.2, weight_decay=5e-4)
```

æŸå¤±å‡½æ•°

```python
cls_loss = nn.CrossEntropyLoss(reduction='none')
bbox_loss = nn.L1Loss(reduction='none') # 
def calc_loss(cls_preds, cls_labels, bbox_preds, bbox_labels, bbox_masks):
    batch_size, num_classes = cls_preds.shape[0], cls_preds.shape[2]
    # è®¡ç®—ä¸€ä¸‹åˆ†ç±»çš„åç§»
    cls = cls_loss(cls_preds.reshape(-1, num_classes),
        cls_labels.reshape(-1)).reshape(batch_size, -1).mean(dim=1)
    # è®¡ç®—ä¸€ä¸‹è¾¹æ¡†ä½ç½®çš„åç§», ä¹˜ä¸€ä¸ªmaskå»é™¤æ— å…³çš„æ¡†
    bbox = bbox_loss(bbox_preds * bbox_masks, bbox_labels * bbox_masks).mean(dim=1)
    return cls + bbox # æŠŠä¸¤ä¸ªè¯¯å·®åŠ åœ¨ä¸€èµ·
def cls_eval(cls_preds, cls_labels):
    # ç”±äºç±»åˆ«é¢„æµ‹ç»“æœæ”¾åœ¨æœ€åä¸€ç»´ï¼Œargmaxéœ€è¦æŒ‡å®šæœ€åä¸€ç»´ã€‚
    # è®¡ç®—ä¸€ä¸‹ç®—å¯¹çš„ä¸ªæ•°
    return float((cls_preds.argmax(dim=-1).type(cls_labels.dtype) == cls_labels).sum())
def bbox_eval(bbox_preds, bbox_labels, bbox_masks):
    # è®¡ç®—ä¸€ä¸‹åç§»
    return float((torch.abs((bbox_labels - bbox_preds) * bbox_masks))
```

å¼€å§‹è®­ç»ƒ

```python
num_epochs, timer = 20, d2l.Timer()
animator = d2l.Animator(xlabel='epoch', xlim=[1, num_epochs],
            legend=['class error', 'bbox mae'])
net = net.to(device)
for epoch in range(num_epochs):
    # è®­ç»ƒç²¾ç¡®åº¦çš„å’Œï¼Œè®­ç»ƒç²¾ç¡®åº¦çš„å’Œä¸­çš„ç¤ºä¾‹æ•°
    # ç»å¯¹è¯¯å·®çš„å’Œï¼Œç»å¯¹è¯¯å·®çš„å’Œä¸­çš„ç¤ºä¾‹æ•°
    metric = d2l.Accumulator(4)
    net.train()
    for features, target in train_iter:
        timer.start()
        trainer.zero_grad()
        X, Y = features.to(device), target.to(device)
        # ç”Ÿæˆå¤šå°ºåº¦çš„é”šæ¡†ï¼Œä¸ºæ¯ä¸ªé”šæ¡†é¢„æµ‹ç±»åˆ«å’Œåç§»é‡
        anchors, cls_preds, bbox_preds = net(X)
        # è·å–çœŸå®çš„æ¯ä¸€ä¸ªé”šæ¡†çš„åˆ†ç±»ä»¥åŠåç§»
        bbox_labels, bbox_masks, cls_labels = d2l.multibox_target(anchors, Y)
        # æ ¹æ®ç±»åˆ«å’Œåç§»é‡çš„é¢„æµ‹å’Œæ ‡æ³¨å€¼è®¡ç®—æŸå¤±å‡½æ•°
        l = calc_loss(cls_preds, cls_labels, bbox_preds, bbox_labels,
            bbox_masks)
        l.mean().backward()
        trainer.step()
        metric.add(cls_eval(cls_preds, cls_labels), cls_labels.numel(),
            bbox_eval(bbox_preds, bbox_labels, bbox_masks),
            bbox_labels.numel())
    cls_err, bbox_mae = 1 - metric[0] / metric[1], metric[2] / metric[3]
    animator.add(epoch + 1, (cls_err, bbox_mae))
print(f'class err {cls_err:.2e}, bbox mae {bbox_mae:.2e}')
```

![image-20250125153326312](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501251533557.png)

å®é™…é¢„æµ‹ä¸€ä¸‹

```python
import torchvision
# åŠ è½½ä¸€ä¸ªå›¾ç‰‡
X = torchvision.io.read_image('E:/JHY/python/2024-11-3-pytorchLiMu/jupyrt/data/bananas/bananas_val/images/1.png').unsqueeze(0).float()
img = X.squeeze(0).permute(1, 2, 0).long() # åŠ ä¸€ä¸ªæ‰¹é‡ç»´åº¦

import torch.nn.functional as F

def predict(X):
    net.eval()
    anchors, cls_preds, bbox_preds = net(X.to(device))
    cls_probs = F.softmax(cls_preds, dim=2).permute(0, 2, 1)
    # ä½¿ç”¨çœŸå®çš„é”šæ¡†ä»¥åŠåç§»è¿›è¡ŒæŠ‘åˆ¶ä»¥åŠè·å–å®é™…çš„è¾“å‡º
    output = multibox_detection(cls_probs, bbox_preds, anchors)
    idx = [i for i, row in enumerate(output[0]) if row[0] != -1] # è·å–æœ‰æ•ˆçš„ç±»
    return output[0, idx]
output = predict(X)
output

"""
tensor([[ 0.00,  0.99,  0.09,  0.31,  0.30,  0.53],
        [ 0.00,  0.04, -0.18,  0.18,  1.13,  0.81],
        [ 0.00,  0.04,  0.12, -0.05,  0.98,  0.96],
        [ 0.00,  0.03,  0.10,  0.37,  0.26,  0.58],
        [ 0.00,  0.03, -0.22,  0.52,  0.44,  1.18],
        [ 0.00,  0.03,  0.08,  0.24,  0.28,  0.45],
        [ 0.00,  0.02,  0.62,  0.32,  1.14,  1.31],
        [ 0.00,  0.02,  0.63, -0.32,  1.14,  0.64],
        [ 0.00,  0.01, -0.11, -0.36,  0.26,  0.45],
        [ 0.00,  0.01,  0.37,  0.61,  1.36,  1.13],
        [ 0.00,  0.01,  0.37, -0.17,  1.32,  0.34],
        [ 0.00,  0.01,  0.03,  0.33,  0.21,  0.52],
        [ 0.00,  0.01,  0.09,  0.19,  0.30,  0.37]], device='cuda:0',
       grad_fn=<IndexBackward0>)
"""
def display(img, output, threshold):
    d2l.set_figsize((5, 5))
    fig = d2l.plt.imshow(img)
    for row in output:
        score = float(row[1])
        if score < threshold:
            continue
        h, w = img.shape[0:2]
        bbox = [row[2:6] * torch.tensor((w, h, w, h), device=row.device)]
        d2l.show_bboxes(fig.axes, bbox, '%.2f' % score, 'w')
display(img, output.cpu(), threshold=0.9)
```

![image-20250125153705020](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202501251537278.png)

## YOLO

SSDæ¡†é‡Œé¢é”šæ¡†å¤§é‡çš„é‡å , æµªè´¹å¾ˆå¤šçš„è®¡ç®—, YOLOæŠŠå›¾ç‰‡å‡åŒ€çš„åˆ†å‰²ä¸ºSxSä¸ªé”šæ¡†, æ¯ä¸ªé”šæ¡†é¢„æµ‹Bä¸ªè¾¹ç¼˜æ¡†(æœ‰Bä¸ªç‰©ä½“å’Œè¿™ä¸€ä¸ªè¾¹ç¼˜æ¡†æ¯”è¾ƒç›¸è¿‘)

æ‰€æœ‰çš„é”šæ¡†ä¹‹é—´ä¸ä¼šé‡åˆ