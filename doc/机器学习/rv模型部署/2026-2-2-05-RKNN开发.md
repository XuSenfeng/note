# RKNN

[rknpu2/doc/Rockchip_RKNPU_User_Guide_RKNN_API_V1.5.2_CN.pdf at master · rockchip-linux/rknpu2](https://github.com/rockchip-linux/rknpu2/blob/master/doc/Rockchip_RKNPU_User_Guide_RKNN_API_V1.5.2_CN.pdf)

RKNN SDK 为带有 RKNPU 的芯片平台提供编程接口，能够帮助用户部署使用 RKNN Toolkit2 导出的RKNN模型，加速AI应用的落地

不同平台可以使用的API函数

![image-20260202161941326](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202602021619377.png)

可以查询的参数

![image-20260202162003640](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202602021620681.png)

目前在RK3562/RK3566/RK3568/RK3588 上有两组 API 可以使用，分别是**通用API 接口**和**零拷贝流程的API接口**，RV1106/RV1103 只支持零拷贝流程的 API 接口。

+ 通用接口每次更新帧数据，需要将外部模块分配的数据拷贝到NPU运行时的输入内存
+ 而零拷贝流程的接口会直接使用预先分配的内存（包括NPU运行时创建的或外部其他框架创建的，比 如DRM框架），减少了内存拷贝的花销。

当用户输入数据只有虚拟地址时，只能使用通用API接 口；当用户输入数据有物理地址或fd时，两组接口都可以使用。通用API和零拷贝API不能混合 调用。

## 通用API

+ 初始化 rknn_input 结构体
+ 使用 rknn_inputs_set 函数设置模型输入
+ 使用 rknn_outputs_get 函数获取推理的输出

![image-20260202162422349](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202602021624391.png)

![image-20260202164433892](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202602021644935.png)

加载动态形状输入RKNN模型后，可以在运行时动态修改输 入的形状。首先，通过 rknn_query 可以查询 RKNN 模型支持的输入形状列表,每个输入支持 的形状列表信息以 rknn_input_range 结构体形式返回，它包含了每个输入的名称、数据布局 信息、形状个数以及具体形状。接着，通过调用 rknn_set_input_shapes 接口，传入包含每个 输入形状信息的rknn_tensor_attr 数组指针可以设置当前推理使用的形状。在设置输入形状后， 可以再次调用rknn_query 查询当前设置成功后的输入和输出形状。最后，按照普通API流程 完成推理。每次切换输入形状时，需要再设置一次新的形状，准备新形状大小的数据并再次 调用rknn_inputs_set 接口。

### API

+ rknn_init 

rknn_init初始化函数将创建rknn_context对象、加载RKNN模型以及根据flag和 rknn_init_extend结构体执行特定的初始化行为



## 零拷贝API

+ 分配内存后使用内存信息初始化rknn_tensor_memory结构体
+ 推理前创建并设置该结构体
+ 推理后读取该结构体中的内存信息

### 运行时分配

![image-20260202162710240](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202602021627281.png)

> RGA（Raster Graphic Accelerator）是**瑞芯微（Rockchip）** 芯片内置的**光栅图形加速器**，是专门为图像处理优化的硬件模块
>
> 