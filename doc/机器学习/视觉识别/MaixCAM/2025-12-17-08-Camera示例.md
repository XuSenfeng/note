# Camera示例

**各个文件主要做什么**

-   [app.hpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   声明整个相机应用的生命周期函数：app_pre_init / app_init / app_loop / app_deinit 以及 app_base_*。
    -   把 UI（ui_screen / ui_event_handler / ui_utils）和 maix 的 camera / display / touchscreen / lvgl 头文件都串起来。
-   [app.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   核心业务逻辑：
        -   维护一个大的 priv 状态结构（拍照/录像标志、分辨率、码率、音频开关、时间戳开关、定时拍、延时摄影、编码器、ffmpeg_packer、audio_recorder、Region 覆盖图层等）。
        -   在 app_pre_init 里读取 sensor 分辨率、初始化 UI 配置（分辨率列表、码率列表等）。
        -   在 app_init 里打开 camera、显示屏、触摸屏，配置编码器、ffmpeg 等。
        -   在 app_loop 里循环：
            -   从 camera 取帧、在屏幕显示；
            -   根据 ui_event_handler 提供的 ui_get_xxx 标志判断是否拍照、开始/停止录像、更新参数；
            -   处理音频录制、视频打包、时间戳叠加、timelapse 等。
    -   这是“业务中枢”：UI 通过标志/参数和这里交互，这里再跟底层硬件/中间件打交道。
-   [app_ex.hpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   扩展功能模块，主要两大块：
        1.  TMC2209 步进电机滑台（用于对焦/焦点堆栈）：
            -   通过 UART 扫描 TMC2209，初始化 ScrewSlide 对象，保存当前步距、速度等。
            -   提供 tmc2209_exist_c 给 C 代码判断是否接了滑台。
            -   有一堆步长配置（2um8、22um4、1mm、2mm 等）和 TMC2209Status 结构，给对焦、焦点堆栈使用。
        2.  高速快门触发 HP_SHOT（通过 GPIO 控制 A15 等）以及其他触发逻辑。
    -   和 ui_stack、自动对焦等配合，属于“高级玩法”。
-   [ui_screen.h](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) / [ui_screen.c](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   负责“画界面”：用 LVGL 搭出整个相机 UI。
    -   定义了 priv_t（左右屏宽度百分比、delay/resolution/bitrate 配置等）以及大量全局 lv_obj_t 指针（各种按钮、图片、小预览、大预览、菜单面板）。
    -   left_screen_init：左侧是预览区域和一列功能按钮（闪光灯、RAW、码率、时间戳、timelapse、stack 等）。
    -   right_screen_init：右侧是模式切换（拍照/录像）、快门按钮、小缩略图，以及 TMC2209 的上下按钮等。
    -   adjust_screen_init：中间一条参数调节栏（S、ISO、EV、WB）等。
    -   screen_delay_init、screen_resolution_init、screen_bitrate_init、screen_timelapse_init：四个弹出设置面板，对应延时拍、分辨率、码率、timelapse。
    -   内部会用 ui_camera_config_t，把 app 侧给的分辨率/码率配置渲染成按钮列表。
-   [ui_event_handler.h](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) / [ui_event_handler.c](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   “事件逻辑层”和“UI 状态缓冲区”：
        -   定义所有 LVGL 回调函数：event_touch_xxx_cb、event_iso_bar_update_cb 等，响应按钮点击、滚动、滑条改变。
        -   内部有一个 priv 结构保存各种标志：拍照/录像开始/停止、退出、当前是否在看照片、哪种设置面板打开、是否自动曝光/自动 ISO/自动 WB、RAW/光源/时间戳按钮的触摸与更新标志、分辨率/码率/timelapse 的当前值等等。
        -   对外提供一堆 ui_get_xxx / ui_set_xxx / ui_update_xxx 函数：
            -   [app.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 每一帧在 app_loop 里通过这些函数读取“用户请求”（比如 ui_get_cam_snap_flag、ui_get_cam_video_start_flag、ui_get_resulution、ui_get_bitrate、ui_get_timelapse_s 等），然后执行实际操作。
            -   同时把结果回写到 UI（比如 ui_update_small_img、ui_set_record_time、ui_set_bitrate、ui_set_timelapse_s 等）。
    -   可以理解为：它把 LVGL 的事件回调转成一个比较易用的“状态接口”给业务逻辑用。
-   [ui_utils.h](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) / [ui_utils.c](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   和照片文件相关的辅助工具：
        -   ui_list_valid_picture_path：遍历指定目录（按日期子目录 yyyy-mm-dd），打印所有 jpg/jpeg 文件。
        -   ui_find_latest_picture：在这些日期目录中找到最新日期、再从里面选修改时间最大的那张照片，返回路径（需要 free）。
        -   ui_get_sys_date：返回当前系统日期字符串（需要 free）。
    -   主要给“查看最近照片”“按日期建目录”之类逻辑服务。
-   [focus.hpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) / [focus.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   自动对焦/辅助对焦算法：
        -   定义了一套接口：
            -   IContrastAlgo（对焦评价算法接口），有多种实现：方差、梯度能量、Brenner、Laplace 等。
            -   ICVMatCreater / IImageCreater / IImageCropper 等，把 maix::image::Image 转成 cv::Mat、灰度图、裁剪为中心区域等。
        -   FullScan 等对焦扫描器：驱动滑台不断移动，采集不同位置的清晰度，对比结果找到最佳焦点；内部还支持保存分析数据到文件。
        -   使用 OpenCV 做图像运算，结合 maix::image 的格式转换。
    -   和 [app_ex.hpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 里的 TMC2209 滑台、以及 UI 中的对焦/stack 功能联动。
-   [region.hpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 以及 [region.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)、[region.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)、[region.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)
    -   Region 类：在视频图像上叠加一个“区域”（overlay），用于画小图/标记框等。
    -   构造函数中绑定 camera 通道，在 sophgo_middleware 中创建区域；get_canvas 获取画布指针，包装成 maix::image::Image；update_canvas 把你画好的内容（BGRA8888）写回硬件 overlay。
    -   不同平台下的 [region.cpp](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 实现可能略有差异，但接口一致。