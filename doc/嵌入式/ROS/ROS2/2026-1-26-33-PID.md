# PID算法

计算期望输出以及反馈信号之间的误差, 根据一定数学模型计算出控制信号, 使得目标系统可以稳定的到达期望的输出

![Screenshot_20260126_182543](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601261826059.jpg)

对误差以及累计的误差计算获取到实际的输出值, Error是当前的误差值, 在比较简单的系统里面可以不计算第三项, 实际的电机在比较小的数值的时候是不动的, 误差小于一定值的时候需要使用累计误差进行调整

> 只有第一项, 在到达对应位置的时候会直接关闭, 只有前两个的话会抖动的比较厉害, 没有对当前速度的考虑

在实际计算的时候, PID一般积分有一个上限, 避免见减去的时候花的时间太长, 输出的值也有限制的最大最小值

## 代码实现

```cpp
#ifndef __PID_CONTROLLER_H__
#define __PID_CONTROLLER_H__

class PidController
{
public:
    PidController() = default;
    PidController(float kp, float ki, float kd);

private:
    // PID 参数，可以调节的
    float target_;
    float out_min_;
    float out_max_;
    float kp_;
    float ki_;
    float kd_;
    float intergral_up_ = 2500; // 积分上限
    // pid 中间过程值
    float error_;
    float error_sum_;
    float derror_;
    float prev_error_;

public:
    float update(float current);                   // 提供当前值，返回下次输出值，也就是PID的结果
    void update_target(float target);              // 更新目标值
    void update_pid(float kp, float ki, float kd); // 更新PID参数
    void reset();                                  // 重置PID
    void out_limit(float min, float max);          // 设置输出限制
};

#endif // __PID_CONTROLLER_H__
```

```cpp
#include "Arduino.h"
#include "PidController.h"

// 构造函数，传入三个PID参数
PidController::PidController(float kp, float ki, float kd)
{
    kp_ = kp;
    ki_ = ki;
    kd_ = kd;
}

float PidController::update(float current)
{
    error_ = target_ - current; //  计算error

    error_sum_ += error_; //  计算error_sum,同时限制积分上下限
    if (error_sum_ > intergral_up_)
        error_sum_ = intergral_up_;
    if (error_sum_ < -1 * intergral_up_)
        error_sum_ = -1 * intergral_up_;

    derror_ = prev_error_ - error_; // 计算误差变化率
    prev_error_ = error_;           // 方便下次计算使用

    float output = kp_ * error_ + ki_ * error_sum_ + kd_ * derror_;

    if (output > out_max_)
        output = out_max_;
    if (output < out_min_)
        output = out_min_;

    return output;
}

void PidController::update_target(float target)
{
    target_ = target;
}

void PidController::update_pid(float kp, float ki, float kd)
{
    kp_ = kp;
    ki_ = ki;
    kd_ = kd;
}

void PidController::reset()
{
    error_sum_ = 0;
    prev_error_ = 0;
    error_ = 0;
    derror_ = 0;
    kp_ = 0;
    ki_ = 0;
    kd_ = 0;
    intergral_up_ = 2500;
    out_min_ = 0;
    out_max_ = 0;
}
void PidController::out_limit(float min, float max)
{
    out_min_ = min;
    out_max_ = max;
}
```

