# DDS

在实际使用的时候选择DDS不能一刀切, 需要考虑许可证资源消耗等多种因素, ROS2在设计时候通过定义抽象的中间件(ROS Middleware 简称rmw)接口适配不同的DDS

可以在电脑安装不同的DDS, 使用的时候通过配置环境变量进行

```bash
sudo spt search ros-humble-rmw-*
```

## 配置文件

不同的配置文DDS可以通过配置文件来进行配置

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<profiles xmlns="http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles">

    <!-- 默认发布者配置 -->
    <publisher profile_name="default_publisher" is_default_profile="true">
        <historyMemoryPolicy>DYNAMIC</historyMemoryPolicy>
    </publisher>

    <!-- 默认订阅者配置 -->
    <subscriber profile_name="default_subscriber" is_default_profile="true">
        <historyMemoryPolicy>DYNAMIC</historyMemoryPolicy>
    </subscriber>

   <!-- 话题 chatter 的发布者配置 -->
    <publisher profile_name="/chatter">
        <historyMemoryPolicy>DYNAMIC</historyMemoryPolicy>
        <matchedSubscribersAllocation>
            <initial>0</initial>
            <maximum>1</maximum>
            <increment>1</increment>
        </matchedSubscribersAllocation>
    </publisher>
</profiles>
```

限制`/chatter`的最大的订阅者数量是1

```bash
export RMW_IMPLEMENTATION=rmw_fastrtps_cpp # 使用的DDS
export RMW_FASTRTPS_USE_QOS_FROM_XML=1
export FASTRTPS_DEFAULT_PROFILES_FILE=./topic_sub_limit.xml
ros2 run demo_nodes_cpp talker
```

## 共享内存

对于不在同一个节点, 但是在同一个主机的节点, 可以使用共享内存的通信, 需要对DDS额外配置, 实际使用的时候, 发布数据需要从中间件里面租借存放消息的数据块, 存入消息, 之后把数据描述发布出去, 接受者获取以后, 从提供的内存里面读取数据

```cpp
#include "rclcpp/loaned_message.hpp"
#include "rclcpp/rclcpp.hpp"
#include "std_msgs/msg/int32.hpp"

class LoanedMessagePublisher : public rclcpp::Node {
public:
  LoanedMessagePublisher() : Node("loaned_message_publisher") {
    publisher_ =
        this->create_publisher<std_msgs::msg::Int32>("loaned_int_topic", 10);
    timer_ = this->create_wall_timer(std::chrono::seconds(1), [&]() {
      auto message = publisher_->borrow_loaned_message(); // 1.租借消息
      message.get().data = count_++;  // 2.放入数据
      RCLCPP_INFO(this->get_logger(), "发布数据:%d", message.get().data);
      publisher_->publish(std::move(message));  // 3.发布数据
    });
  }

private:
  rclcpp::Publisher<std_msgs::msg::Int32>::SharedPtr publisher_;
  rclcpp::TimerBase::SharedPtr timer_;
  int32_t count_{0};
};

int main(int argc, char **argv) {
  rclcpp::init(argc, argv);
  auto node = std::make_shared<LoanedMessagePublisher>();
  rclcpp::spin(node);
  rclcpp::shutdown();
  return 0;
}
```

使用的配置文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<profiles xmlns="http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles">

  <data_writer profile_name="default publisher profile" is_default_profile="true">
    <qos>
      <publishMode>
        <kind>SYNCHRONOUS</kind>
      </publishMode>
      <data_sharing>
        <kind>AUTOMATIC</kind>
      </data_sharing>
    </qos>
    <historyMemoryPolicy>DYNAMIC</historyMemoryPolicy>
  </data_writer>

  <data_reader profile_name="default subscription profile" is_default_profile="true">
    <qos>
      <data_sharing>
        <kind>AUTOMATIC</kind>
      </data_sharing>
    </qos>
    <historyMemoryPolicy>DYNAMIC</historyMemoryPolicy>
  </data_reader>
</profiles>
```

