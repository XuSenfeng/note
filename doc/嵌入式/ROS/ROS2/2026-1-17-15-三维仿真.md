# 三维仿真

机器人三维物理仿真平台**Gazebo**是ROS系统中最为常用的**三维物理仿真平台**，支持动力学引擎，可以实现高质量的图形渲染，不仅可以模拟机器人及周边环境，还可以加入摩擦力、弹性系数等物理属性

```bash
sudo apt install ros-humble-gazebo-*
```

可以帮助我们验证机器人算法、优化机器人设计、测试机器人场景应用，为机器人开发提供更多可能。

```bash
export SVGA_VGPU=0 # 使用CPU
export LIBGL_ALWAYS_SOFTWARE=1
ros2 launch gazebo_ros gazebo.launch.py
```

## 模型

### XACRO

可以使用DRDF模型优化以后, 使用XACRO文件描述, XACRO文件加入了更多编程化的实现方法，可以让模型创建更友好。

- **宏定义**，一个小车有4个轮子，每个轮子都一样，我们就没必要创建4个一样的link，像函数定义一样，做一个可重复使用的模块就可以了。
- **文件包含**，复杂机器人的模型文件可能会很长，为了切分不同的模块，比如底盘、传感器，我们还可以把不同模块的模型放置在不同的文件中，然后再用一个总体文件做包含调用。
- **可编程接口**，比如在XACRO模型文件中，定义一些常量，描述机器人的尺寸，定义一些变量，在调用宏定义的时候传递数据，还可以在模型中做数据计算，甚至加入条件语句，比如你的机器人叫A，就有摄像头，如果叫B，就没有摄像头。

```bash
$ sudo apt install ros-humble-xacro
```

#### 常量

![image-20220528150321426](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171633332.png)

`<xacro:property>`标签用来定义一些常量，比如这样定义一个PI的常量名为“M_PI”，值为“3.14159”，在调用的时候，通过$加大括号，里边就可以使用定义好的常量了

针对原本移动机器人的URDF文件，我们就可以把底盘的质量、尺寸，轮子的质量、尺寸、安装位置，这些不会变化的数据，都通过常量定义

![image-20220528150338969](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171634534.png)

#### 数学计算

![image-20220528150430205](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171634432.png)

如果需要做数学计算，同样是在“${}”中进行，比如某一个位置，我们可以通过这两个常量做运算得到，就加入了加法和除法运算

> 所有数学运算都会转换成浮点数进行，以保证运算精度

#### 宏定义

![image-20220528150542643](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171635886.png)

定义方式是通过这个<xacro:macro>标签描述的，还可以像函数一样，设置里边会用到的一些参数，比如这里的A、B、C

#### 引用文件

![image-20220528150712684](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171635325.png)

### 仿真配置参数

确保每一个link都有惯性参数和碰撞属性，因为Gazebo是物理仿真平台，必要的物理参数是一定需要的

+ 完善物理参数![image-20220528150842585](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171638577.png)
+ 添加Gazebo标签渲染每一个link的颜色![image-20220528150931153](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171640434.png)
+ 给运动的joint设置传动装置, 可以理解为仿真了一个电机![image-20220528150958309](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171640206.png)
+ 添加控制器插件小车是差速控制的，那就添加差速控制器插件，这样在不同角度下两个电机的速度分配，就可以交给控制器插件来完成了![image-20220528151019063](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601171640100.png)

