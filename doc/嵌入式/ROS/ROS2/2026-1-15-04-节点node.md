# 节点

每一个节点是一个可执行文件, 实现一个功能, 可能位于不同的设备上面

## 基础使用

+ 初始化编程接口
+ 初始化节点, 创建节点
+ 实现节点功能
+ 销毁节点

### 数据类型

使用的数据叫interface, 可以使用命令

```bash
ros2 interface list # 查看
# 具体的实现
ros2 interface show example_interfaces/msg/String
```

### python

#### 基础使用

```python
import rclpy
from rclpy.node import Node
import time
# ROS2节点主入口main函数
def main(args=None):
    # ROS2 Python接口初始化
    rclpy.init(args=args)
    # 创建ROS2节点对象并进行初始化
    node = Node("node_helloworld")
    
    while rclpy.ok():
        # ROS2日志输出
        node.get_logger().info("Hello World")
        # 休眠控制循环时间
        time.sleep(0.5)
    
    node.destroy_node()
    rclpy.shutdown()
```

使用python文件的时候需要配置一下入口函数

```python
entry_points={
    'console_scripts': [
     'node_helloworld       = learning_node.node_helloworld:main',
    ],
},
```

文件编译的时候会被复制到install目录里面

![image-20260115141954508](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/lenovo-picture/202601151419572.png)

#### 面向对象

```python
import rclpy                                     # ROS2 Python接口库
from rclpy.node import Node                      # ROS2 节点类
import time

"""
创建一个HelloWorld节点, 初始化时输出“hello world”日志
"""
class HelloWorldNode(Node):
    def __init__(self, name):
        super().__init__(name)                       # ROS2节点父类初始化
        while rclpy.ok():                            # ROS2系统是否正常运行
            self.get_logger().info("Hello World")    # ROS2日志输出
            time.sleep(0.5)                          # 休眠控制循环时间

def main(args=None):                                 # ROS2节点主入口main函数
    rclpy.init(args=args)                            # ROS2 Python接口初始化
    node = HelloWorldNode("node_helloworld_class")   # 创建ROS2节点对象并进行初始化
    node.destroy_node()                              # 销毁节点对象
    rclpy.shutdown()                                 # 关闭ROS2 Python接口
```

可以在节点里面实现实际的功能

```python
import rclpy                            # ROS2 Python接口库
from rclpy.node import Node             # ROS2 节点类

import cv2                              # OpenCV图像处理库
import numpy as np                      # Python数值计算库

lower_red = np.array([0, 90, 128])     # 红色的HSV阈值下限
upper_red = np.array([180, 255, 255])  # 红色的HSV阈值上限

def object_detect(image):
    hsv_img = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)                               # 图像从BGR颜色模型转换为HSV模型
    mask_red = cv2.inRange(hsv_img, lower_red, upper_red)                          # 图像二值化

    contours, hierarchy = cv2.findContours(mask_red, cv2.RETR_LIST, cv2.CHAIN_APPROX_NONE) # 图像中轮廓检测

    for cnt in contours:                                                          # 去除一些轮廓面积太小的噪声
        if cnt.shape[0] < 150:
            continue
            
        (x, y, w, h) = cv2.boundingRect(cnt)                                      # 得到苹果所在轮廓的左上角xy像素坐标及轮廓范围的宽和高
        cv2.drawContours(image, [cnt], -1, (0, 255, 0), 2)                        # 将苹果的轮廓勾勒出来
        cv2.circle(image, (int(x+w/2), int(y+h/2)), 5, (0, 255, 0), -1)           # 将苹果的图像中心点画出来
	    
    cv2.imshow("object", image)                                                    # 使用OpenCV显示处理后的图像效果
    cv2.waitKey(0)
    cv2.destroyAllWindows()

def main(args=None):
    rclpy.init(args=args)
    node = Node("node_object")
    node.get_logger().info("ROS2节点示例：检测图片中的苹果")

    image = cv2.imread('/home/gyh/dev_ws/src/ros2_21_tutorials/learning_node/learning_node/apple.jpg')  # 读取图像
    object_detect(image)
    # 在这个里面处理话题回调函数等
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()
```

### cpp

```cpp
#include <unistd.h>
#include "rclcpp/rclcpp.hpp"

class HelloWorldNode : public rclcpp::Node
{	
    // ROS2节点初始化以及父类初始化
    public:
        HelloWorldNode()
        : Node("node_helloworld_class")
        {
            // ROS2系统是否正常运行
            while(rclcpp::ok())
            {
                // ROS2日志输出
                RCLCPP_INFO(this->get_logger(), "Hello World");
                // 休眠控制循环时间
                sleep(1);
            }
        }
};

// ROS2节点主入口main函数
int main(int argc, char * argv[])
{
    // ROS2 C++接口初始化
    rclcpp::init(argc, argv);
    // 创建ROS2节点对象并进行初始化                 
    rclcpp::spin(std::make_shared<HelloWorldNode>());
    // 关闭ROS2 C++接口
    rclcpp::shutdown();
    return 0;
}
```

#### cmake

可以自己编写文件进行链接

```bash
cmake_minimum_required(VERSION 3.8)
project(ros2_cpp)
add_executable(node_helloworld node_helloworld_class.cpp)

find_package(rclcpp REQUIRED)
target_include_directories(node_helloworld PUBLIC ${rclcpp_INCLUDE_DIRS})
target_link_libraries(node_helloworld ${rclcpp_LIBRARIES})
```

## 日志

日志可以使用环境变量进行配置输出格式

`RCUTILS_CONCOLE_OUTPUT_FORMAT`: 输出日志的格式, 可以设置为`[{function_name}:{line_number}]:{message}`

```bash
node.get_logger().info("ROS2节点示例：检测图片中的苹果")
```

