# launch脚本

ROS2里面的脚本使用python进行描述, 所有的命令可以使用python命令进行描述

## 实现

### 构建运行

#### python项目

```bash
$ ros2 launch learning_launch simple.launch.py
```

这个文件放在launch文件夹下面, 名字就是simple.launch.py

在setup.py文件里面有如下的描述

```python
data_files=[
    ('share/ament_index/resource_index/packages',
        ['resource/' + package_name]),
    ('share/' + package_name, ['package.xml']),
    # 这个匹配launch文件
    (os.path.join('share', package_name, 'launch'), glob(os.path.join('launch', '*.launch.py'))),
    (os.path.join('share', package_name, 'config'), glob(os.path.join('config', '*.*'))),
    (os.path.join('share', package_name, 'rviz'), glob(os.path.join('rviz', '*.*'))),
],
```

#### cpp

脚本文件的构建是一样的, cmake添加一个拷贝配置

```cmake
install(DIRECTORY
  launch
  DESTINATION share/${PROJECT_NAME}/
)
```

## 实际实现

python的实现需要使用generate_launch_description这个函数名字, 返回一个`LaunchDescription`数组, 里面是一系列的动作

### 节点启动描述

```python
# launch文件的描述类
from launch import LaunchDescription
from launch_ros.actions import Node
# 自动生成launch文件的函数
def generate_launch_description():
    # 返回launch文件的描述信息
    # 配置一个节点的启动
    return LaunchDescription([                 
        Node(
            # 节点所在的功能包
            package='learning_topic',
            # 节点的可执行文件
            executable='topic_helloworld_pub', 
        ),
        # 配置一个节点的启动
        Node(
            # 节点所在的功能包
            package='learning_topic',
            # 节点的可执行文件名
            executable='topic_helloworld_sub',
        ),
    ])
```

可以使用`output`指定实际输出的位置

+ screen: 终端
+ log: 日志文件
+ both: 上面两个

### 参数文件加载

```python
import os

from ament_index_python.packages import get_package_share_directory 
from launch import LaunchDescription类
from launch_ros.actions import Node

def generate_launch_description():
	# 找到配置文件的完整路径
   rviz_config = os.path.join(          
      get_package_share_directory('learning_launch'),
      'rviz',
      'turtle_rviz.rviz'
      )
	# 返回launch文件的描述信息
   return LaunchDescription([
      # 配置一个节点的启动, 对节点重新命名
      Node(
         package='rviz2',
         executable='rviz2',
         name='rviz2',
          # 加载命令行参数
         arguments=['-d', rviz_config]  
      )
   ])
```

### 资源重映射

当我们使用别人代码的时候，经常会发现通信的话题名称不太符合我们的要求, 为了提高软件的复用性，ROS提供了资源重映射的机制，可以帮助我们解决类似的问题

```python
from launch import LaunchDescription      # launch文件的描述类
from launch_ros.actions import Node       # 节点启动的描述类

def generate_launch_description():
    return LaunchDescription([
        Node(
            package='turtlesim',
            # 使用命名空间的名字
            namespace='turtlesim1',
            executable='turtlesim_node',
            name='sim'
        ),
        Node(
            package='turtlesim',
            namespace='turtlesim2',
            executable='turtlesim_node',
            name='sim'
        ),
        # 启动 turtlesim 功能包中的 mimic 节点，并通过话题重映射，
        # 让 turtlesim2 命名空间下的海龟 “模仿” turtlesim1 
        # 命名空间下的海龟运动
        # mimic 节点本身只认 /input/pose 和 /output/cmd_vel 这两个话题，
        # 若不做重映射，它无法关联到你创建的 turtlesim1/turtlesim2 海龟，
        # 因此需要通过 remappings 调整话题指向
        Node(
            package='turtlesim',
            executable='mimic', 
            name='mimic',
            # 资源重映射列表
            remappings=[
                # 将/input/pose话题名修改为/turtlesim1/turtle1/pose
                ('/input/pose', '/turtlesim1/turtle1/pose'),
                # 将/output/cmd_vel话题名修改为/turtlesim2/turtle1/cmd_vel
                ('/output/cmd_vel', '/turtlesim2/turtle1/cmd_vel'),
            ]
        )
    ])
```

**结合命名空间形成唯一标识**：节点的完整名称 = `namespace + name`，因此两个 turtlesim 节点的完整名称分别是：

- `/turtlesim1/sim`（原本默认是 `/turtlesim1/turtlesim_node`）
- `/turtlesim2/sim`（原本默认是 `/turtlesim2/turtlesim_node`）；

### 初始化参数

```python
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration, TextSubstitution
from launch_ros.actions import Node

def generate_launch_description():
    # 声明launch文件里面使用的参数, 可以在加载的时候复用
   background_r_launch_arg = DeclareLaunchArgument(
      'background_r', default_value=TextSubstitution(text='0')
   )
   background_g_launch_arg = DeclareLaunchArgument(
      'background_g', default_value=TextSubstitution(text='84')
   )
   background_b_launch_arg = DeclareLaunchArgument(
      'background_b', default_value=TextSubstitution(text='122')
   )

   return LaunchDescription([
      # 加载并启用以上创建的参数（arg）
      background_r_launch_arg,                                     
      background_g_launch_arg,
      background_b_launch_arg,
      Node(
         package='turtlesim',
         executable='turtlesim_node',
         name='sim',
         parameters=[{
             # 将外部 Launch 参数的值传递给 turtlesim_node 内部
            'background_r': LaunchConfiguration('background_r'),
            'background_g': LaunchConfiguration('background_g'),
            'background_b': LaunchConfiguration('background_b'),
         }]
      ),
   ])
```

launch文件中出现的argument和parameter，虽都译为“参数”，但含义不同： - argument：仅限launch文件内部使用，方便在launch中调用某些数值； - parameter：ROS系统的参数，方便在节点见使用某些数值

可以在使用launch的时候再次设置

```bash
ros2 launch demo demo.launch.py background_r:=0
```

也可以从文件里面直接读取

```python
import os

from ament_index_python.packages import get_package_share_directory  # 查询功能包路径的方法

from launch import LaunchDescription   # launch文件的描述类
from launch_ros.actions import Node    # 节点启动的描述类


def generate_launch_description():
   config = os.path.join(              # 找到参数文件的完整路径
      get_package_share_directory('learning_launch'),
      'config',
      'turtlesim.yaml'
      )

   return LaunchDescription([
      Node(
         package='turtlesim',
         executable='turtlesim_node',
         namespace='turtlesim2',
         name='sim',
         parameters=[config]# 加载参数文件
      )
   ])
```

## 进阶使用

Launch文件有三个组成部分, 动作, 条件, 替换

+ 动作: 可以是一个节点的启动, 打印信息, 终端指令, 另一个launch文件
+ 替换: 使用launch文件的参数替换节点的参数
+ 条件: 使用条件可以决定实际启动的动作

### 模块的包含

```python
import os
from ament_index_python.packages import get_package_share_directory

from launch import LaunchDescription
from launch.actions import IncludeLaunchDescription
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.actions import GroupAction
from launch_ros.actions import PushRosNamespace
def generate_launch_description():
    # 包含指定路径下的另外一个launch文件, 使用功能包名字查找路径
   parameter_yaml = IncludeLaunchDescription(
      PythonLaunchDescriptionSource([os.path.join(
         get_package_share_directory('learning_launch'), 'launch'),
         '/parameters_nonamespace.launch.py'])
      )
   # 对指定launch文件中启动的功能加上命名空间, 按顺序执行
   parameter_yaml_with_namespace = GroupAction(      
      actions=[
         PushRosNamespace('turtlesim2'),
         parameter_yaml]
      )

   return LaunchDescription([# 返回launch文件的描述信息
      parameter_yaml_with_namespace
   ])
```

### 执行命令

```pthon
action_topic_list = launch.actions.ExecuteProcess(
	cmd=["ros2", "topic", list]
)
```

### 顺序执行

```python
parameter_yaml_with_namespace = launch.actions.GroupAction(      
  actions=[
     launch.actions.TimerAction(period=2.0, actions=[action_include_launch]),
     launch.actions.TimerAction(period=4.0, actions=[action_topic_list])
  ]
)
```

### 打印信息

```python
action_log_info = launch.action.LogInfo(msg=str(path))
```

### 调教执行

```python
# 初始化一个launch参数
action_declare_startup_rqt = launch.action.DeclareLaunchArgument('startup_rqt', default_value="False")
startup_rqt = launch.substitutions.LaunchConfiguration('startup_rqt', default="False")
# 使用这个参数进行判断执行
action_topic_list = launch.actions.ExecuteProcess(
	condition=launch.conditions.IfCondition(startup_rqt)
    cmd=["rqt"]
)
```

