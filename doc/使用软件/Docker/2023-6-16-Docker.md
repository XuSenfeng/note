---
layout: post
title: "Docker使用" 
date:   2023-6-16 11:29:08 +0800
tags: docker
---

# Docker

应用打包, 分发, 部署的工具

你也可以把它理解为一个轻量的虚拟机，它只虚拟你软件需要的运行环境，多余的一点都不要，
而普通虚拟机则是一个完整而庞大的系统，包含各种不管你要不要的软件。

性能比较好, 稳定性好

**打包**：就是把你软件运行所需的依赖、第三方库、软件打包到一起，变成一个安装包
**分发**：你可以把你打包好的“安装包”上传到一个镜像仓库，其他人可以非常方便的获取和安装
**部署**：拿着“安装包”就可以一个命令运行起来你的应用，自动模拟出一摸一样的运行环境，不管是在 Windows/Mac/Linux。

>   可以使用Play With Docker网址构建镜像以及运行测试

### Docker 部署的优势

常规应用开发部署方式：自己在 Windows 上开发、测试 --> 到 Linux 服务器配置运行环境部署。

>   问题：我机器上跑都没问题，怎么到服务器就各种问题了

用 Docker 开发部署流程：自己在 Windows 上开发、测试 --> 打包为 Docker 镜像（可以理解为软件安装包） --> 各种服务器上只需要一个命令部署好

>   优点：确保了不同机器上跑都是一致的运行环境，不会出现我机器上跑正常，你机器跑就有问题的情况。

例如 [易文档](https://easydoc.net/)，[SVNBucket](https://svnbucket.com/) 的私有化部署就是用 Docker，轻松应对客户的各种服务器。

### Docker 通常用来做什么

-   应用分发、部署，方便传播给他人安装。特别是开源软件和提供私有部署的应用
-   快速安装测试/学习软件，用完就丢（类似小程序），不把时间浪费在安装软件上。例如 Redis / MongoDB / ElasticSearch / ELK
-   多个版本软件共存，不污染系统，例如 Python2、Python3，Redis4.0，Redis5.0
-   Windows 上体验/学习各种 Linux 系统

### 重要概念：镜像、容器、仓库

**镜像**：可以理解为软件安装包，可以方便的进行传播和安装。只读, 用于建立容器
**容器**：软件安装后的状态，每个软件运行环境都是独立的、隔离的，称之为容器。实际的运行实例, 可以在这里运行程序
**仓库**： 记录镜像和容器

### 安装

桌面版：https://www.docker.com/products/docker-desktop
服务器版：https://docs.docker.com/engine/install/#server

**命令行安装 Linux 内核**
`wsl.exe --install -d Ubuntu`

**设置开机启动 Hypervisor**
`bcdedit /set hypervisorlaunchtype auto`

>   注意要用管理员权限打开 PowerShell

**设置默认使用版本2**
`wsl.exe --set-default-version 2`

**查看 WSL 是否安装正确**
`wsl.exe --list --verbose`
应该如下图，可以看到一个 Linux 系统，名字你的不一定跟我的一样，看你安装的是什么版本。
并且 VERSION 是 2
![image.png](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408242303944.png)

**确保 BIOS 已开启虚拟化，下图检查是否已开启好**

>   如果是已禁用，请在开机时按 F2 进入 BIOS 开启一下，不会设置的可以网上搜索下自己主板的设置方法，Intel 和 AMD 的设置可能稍有不同

![image.png](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408242303945.png)

### 镜像加速源

| 镜像加速器          | 镜像加速器地址                       |
| ------------------- | ------------------------------------ |
| Docker 中国官方镜像 | https://registry.docker-cn.com       |
| DaoCloud 镜像站     | http://f1361db2.m.daocloud.io        |
| Azure 中国镜像      | https://dockerhub.azk8s.cn           |
| 科大镜像站          | https://docker.mirrors.ustc.edu.cn   |
| 阿里云              | https://ud6340vz.mirror.aliyuncs.com |
| 七牛云              | https://reg-mirror.qiniu.com         |
| 网易云              | https://hub-mirror.c.163.com         |
| 腾讯云              | https://mirror.ccs.tencentyun.com    |

```
"registry-mirrors": ["https://registry.docker-cn.com"]
```

![1.png](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/image/202408242303946.png)

## 实际使用

Docker 官方镜像仓库：https://hub.docker.com/

`docker run -d -p 6379:6379 --name redis redis:latest`

>   运行一个软件, -d在后台运行, -p容器里面的端口暴漏, --name给容器命名, 使用的源为最新版本

### 常用命令

| **命令**              | **功能**                                         | **示例**                                   |
| :-------------------- | :----------------------------------------------- | :----------------------------------------- |
| `docker run`          | 启动一个新的容器并运行命令                       | `docker run -d ubuntu`                     |
| `docker ps`           | 列出当前正在运行的容器                           | `docker ps`                                |
| `docker ps -a`        | 列出所有容器（包括已停止的容器）                 | `docker ps -a`                             |
| `docker build`        | 使用 Dockerfile 构建镜像                         | `docker build -t my-image .`               |
| `docker images`       | 列出本地存储的所有镜像                           | `docker images`                            |
| `docker pull`         | 从 Docker 仓库拉取镜像                           | `docker pull ubuntu`                       |
| `docker push`         | 将镜像推送到 Docker 仓库                         | `docker push my-image`                     |
| `docker exec`         | 在运行的容器中执行命令                           | `docker exec -it container_name bash`      |
| `docker stop`         | 停止一个或多个容器                               | `docker stop container_name`               |
| `docker start`        | 启动已停止的容器                                 | `docker start container_name`              |
| `docker restart`      | 重启一个容器                                     | `docker restart container_name`            |
| `docker rm`           | 删除一个或多个容器                               | `docker rm container_name`                 |
| `docker rmi`          | 删除一个或多个镜像                               | `docker rmi my-image`                      |
| `docker logs`         | 查看容器的日志                                   | `docker logs container_name`               |
| `docker inspect`      | 获取容器或镜像的详细信息                         | `docker inspect container_name`            |
| `docker exec -it`     | 进入容器的交互式终端                             | `docker exec -it container_name /bin/bash` |
| `docker network ls`   | 列出所有 Docker 网络                             | `docker network ls`                        |
| `docker volume ls`    | 列出所有 Docker 卷                               | `docker volume ls`                         |
| `docker-compose up`   | 启动多容器应用（从 `docker-compose.yml` 文件）   | `docker-compose up`                        |
| `docker-compose down` | 停止并删除由 `docker-compose` 启动的容器、网络等 | `docker-compose down`                      |
| `docker info`         | 显示 Docker 系统的详细信息                       | `docker info`                              |
| `docker version`      | 显示 Docker 客户端和守护进程的版本信息           | `docker version`                           |
| `docker stats`        | 显示容器的实时资源使用情况                       | `docker stats`                             |
| `docker login`        | 登录 Docker 仓库                                 | `docker login`                             |
| `docker logout`       | 登出 Docker 仓库                                 | `docker logout`                            |

-   **`-d`**：后台运行容器，例如 `docker run -d ubuntu`。
-   **`-it`**：以交互式终端运行容器，例如 `docker run -it ubuntu /bin/bash`, `docker exec -it 243c32535da7 /bin/bash`, exec退出的时候容器不会停止
-   **`-t`**：为镜像指定标签，例如 `docker build -t my-image .`

### 导出导入

```bash
docker export 1e560fca3906 > ubuntu.tar
cat docker/ubuntu.tar | docker import - test/ubuntu:v1
docker import http://example.com/exampleimage.tgz example/imagerepo
```



## 代理

[Docker/DockerHub 国内镜像源/加速列表（2月20日更新-长期维护）-腾讯云开发者社区-腾讯云](https://cloud.tencent.com/developer/article/2485043)

![image-20250221221647494](https://picture-01-1316374204.cos.ap-beijing.myqcloud.com/picture/202502212216344.png)

## 逻辑卷

docker容器里面的数据是不会持久保存的, 创建一个容器的时候, 通常是一个干净的文件系统, 可以在里面进行操作, 但是容器关闭的时候所有的文件丢失, 想要持久话的话, 可以把容器里面的某一个目录映射到宿主机的某一个目录里面

```bash
# 列出所有卷
docker volume ls

# 查看卷的详细信息（含宿主机路径）
docker volume inspect <卷名/随机ID>

# 删除指定卷
docker volume rm <卷名>

# 删除所有未使用的卷（谨慎！）
docker volume prune
```

1.  **数据库数据持久化**：如 MySQL 的 `/var/lib/mysql` 目录；
2.  **应用日志存储**：如 Nginx/Java 应用的日志目录；
3.  **用户上传文件**：如 Web 应用的 `/uploads` 目录；
4.  **配置文件共享**：多个容器共享同一套配置文件。
