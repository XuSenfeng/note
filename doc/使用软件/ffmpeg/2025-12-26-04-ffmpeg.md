# ffmpeg

## 基础参数

| 参数   | 适用领域   | 核心作用                                                     | 类比（生活化理解）                                           |
| ------ | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 采样率 | 音频       | 衡量声音信号的 “采样精度”，即每秒对声音波形的采样次数，决定音频的还原度。 | 用相机拍海浪：采样率越高，每秒拍的照片越多，越能还原海浪的细节。 |
| 分辨率 | 视频       | 衡量视频画面的 “像素尺寸”，即画面的宽 × 高（如 640x480），决定视频的清晰度上限。 | 画画的画布大小：分辨率越高，画布越大，能画的细节越多。       |
| 码率   | 音视频通用 | 衡量每秒音视频的数据量（单位 kbps），是 “数据预算”，直接决定质量和体积。 | 给画布 / 照片分配的 “颜料 / 存储空间”：预算越多，能画的细节越丰富，照片越清晰。 |

### 主要参数

+   -i: 输入的流, 可以是视频xxx.mp4
+   -f: 输出的格式, 可以设置为mp4, flv等, 不设置的时候会自动获取输出文件的尾缀
+   -ss: 开始的时间
+   -t: 时间长度

### 音频参数

+   -aframes: 设置输出的音频帧数
+   -b\:a: 音频码率
+   -ar: 采样率
+   -ac: 音频的Channel数
+   -acodec: 音频编解码器, 可以直接使用copy
+   -an: 不处理音频
+   -af: 音频过滤器

>   **示例**
>
>   `ffmpeg -i test.mp4 -codec copy -f flv out.mp4`把MP4文件转换为flv格式, 所有的音视频直接拷贝
>
>   可以使用`ffmpeg -encoders | finds mp3`查找mp3的完整编码器名字
>
>   `ffmped -i test.mp4 -b:a 192k -ar 48000 -ac 2 -acodec libmp3lame out.mp3`
>
>   FFmpeg 会读取 `test.mp4` 的视频文件，忽略其中的视频流，只处理音频流，将其按照 `192kbps 比特率、48kHz 采样率、双声道` 的参数，通过 LAME 编码器转码为 MP3 格式，并保存为 `out.mp3`Fmpeg 会根据这个后缀识别输出格式为 MP3 —— 而 MP3 格式的核心定义就是**仅存储音频数据**，不支持封装任何视频流、字幕流等非音频数据

### 视频参数

+   -vframes: 输出试音的帧数
+   -b: 视频的码率
+   -b\:v: 视频的码率
+   -r: 设定帧速率
+   -s: 宽高
+   -vn: 不处理视频
+   -vcodec: 视频解码器, 可以使用copy
+   -vf: 视频过滤器
+   -pix_fmt: 像素格式

>   **示例**
>
>   `ffmpeg -i test.mp4 -vframe 300 -b:v 300k -r 30 -s 640x480 -aspect 16:9 -vcodec libx265 out.h265`
>
>   按照指定的视频参数（300kbps 比特率、30 帧 / 秒、640x480 分辨率、16:9 宽高比），通过 H.265 编码器转码并输出为**裸的 H.265 视频流文件** `out.h265`（无音频、无封装格式）, 播放时播放器会按 16:9 拉伸画面，导致画面变形（比如人物变扁 / 变瘦）

## 示例

### 提取音视频数据

#### 保留格式

```bash
ffmpeg -i test.mp4 -acodec copy -vn audio.mp4
ffmpeg -i test.mp4 -vcodec copy -an video.mp4
```

#### 提取视频

```bash
ffmpeg -i test.mp4 -vcodec copy -an test_copy.h264
ffmpeg -i test.mp4 -vcodec libx264 -an test_copy.h264
```

#### 提取音频

```bash
ffmpeg -i test.mp4 -acodec copy -vn test_copy.mp3
ffmpeg -i test.mp4 -acodec libmp3lame -vn test_copy.mp3
```

### 提取像素格式

#### 提取yuv

```bash
ffmpeg -i test.mp4 -t 3 -pix_fmt yuv420p yuv420p_orig.yuv
ffmpeg -i test.mp4 -t 3 -pix_fmt yuv420p  -s 320x240 yuv420p_320x240.yuv
```

#### 提取RGB

```bash
ffmpeg -i test.mp4 -t 3 -pix_fmt rgb24 rgb24_orig.rgb
```

#### 相互转换

```bash
ffmpeg -s 320x240 -pix_fmt yuv420p -i yuv420p_320x240.yuv -pix_fmt rgb24 rgb24_320x240.rgb
```

#### 提取pcm

```bash
ffmpeg -i test.mp3 -ar 48000 -ac 2 -f s16le 48000_2_s16le.pcm
ffmpeg -i test.mp3 -ar 48000 -ac 2 -sample_fmt s16 48000_2_s16.wav
ffmpeg -i test.mp3 -ar 48000 -ac 2 -codec:a pcm_s16le 48000_2_s16le.wav
ffmpeg -i test.mp3 -ar 48000 -ac 2 -f f32le 48000_2_f32le.pcm
```

-f: 的参数可以使用命令`ffmpeg -muxers | findstr PCM`查看PCM的格式, 存储的是裸数据

-sample_fmt: 可以使用命令`ffmpeg -sample_fmts`查询, 存储的有一个wav的头部

-codec\:a可以使用命令`ffmpeg -encoders | findstr pcm`查询, 存储的有一个wav的头部

>   ffplay播放的时候pcm数据格式的需要指定参数, wav的不需要

## 转换封装格式

### 保持编码

```bash
ffmpeg -i test.mp4 -vcodec copy -vbsf -acodec copy test_copy.ts
ffmpeg -i test.mp4 -codec copy  test_copy.ts
```

>   在使用v的copy的时候可以加`-vbsf` ：**在不重新编码（不损画质、速度快）的前提下，修改已编码视频比特流的 “格式规则 / 元数据”**，解决 “同一种编码（如 H.265）的比特流，因格式 / 元数据不同，导致某些设备认不出来、播不了” 的问题。
>
>   它就像给视频流换 “文件格式标签”，不改视频画面本身，只改 “描述格式的文字”—— 比如把 “MP4 专用的 H.265 格式” 改成 “裸流播放器能认的 H.265 格式”
>
>   MP4 里的 H.265 流是 “AVCC 格式”（带 MP4 封装标记），而裸`.h265`文件需要 “Annex B 格式”（通用裸流格式）；不加 `-vbsf`，拷贝出来的流还是 AVCC 格式，播放器认不出；加了之后，格式被转换成 Annex B，就能正常播放

### 转换编码

```bash
ffmpeg -i test.mp4 -vcodec libx265 -acodec libmp3lame out_h265_mp3.mkv
```

### 改变帧率

```bash
ffmpeg -i test.mp4 -r 15 -codec copy out.mp4 # (!!!错误!!!!不要有copy)
ffmpeg -i test.mp4 -r 15 out.mp4
```

### 视频码率

```bash
ffmpeg -i test.mp4 -b 400k output.mkv
ffmpeg -i test.mp4 -b:v 400k output.mkv
```

>   不指定codec的时候可能会默认进行格式转码, 只进行一个码率改变的时候, 不指定另一个也可能影响, 需要指定使用copy参数

### 音频码率

```bash
ffmpeg -i test.mp4 -b:a 192k output.mp4
```

>   `ffmpeg -i test.mp4 -b:a 192k -b:v 400k output.mp4`音视频

### 截取视频

```bash
ffmpeg -i test.mp4 -ss 00:05:00 -t 10 -codec copy 1.mp4
```

才5分钟开始截取10秒视频